{
    "Shader": {
        "info": {
            "date": "1578515264",
            "description": "after trying many soffline shadertoy canvases on a Samsung S8,I noticed that many of them where incompatible. The smaller ones perfomed a lot better, like THIS 64kOfflineShadertoy.html with focus on webAudio support (and shitty minimal semi-broken IU).",
            "flags": 0,
            "hasliked": 0,
            "id": "tly3Rm",
            "likes": 1,
            "name": "offline S8dertoy 64k THX",
            "published": 3,
            "tags": [
                "shadertoy",
                "canvas",
                "thx",
                "html",
                "offline",
                "hacky",
                "nofont",
                "s8dertoy"
            ],
            "usePreview": 0,
            "username": "ollj",
            "viewed": 542
        },
        "renderpass": [
            {
                "code": "//main feature here is the whole HTML code in the commonTaB\n//when copied into a html file,you get an offlineShadertoy.html\n//this one has dcent Webaudio support on a samsung S8 mobile phone\n//where it plays the THX harmonics intro, within a 64k.html file\n//, within its mobile version of the fiirefox browser.\n\n//this shader has an unlisted \"evil twin\": \n//https://www.shadertoy.com/view/tlGGzm\n//that only has different (more instrumental) opengl code, to play the \"Terminator main theme\"\n\n//on many platforms you may have to klock \"volume\" and then \"reset\" \n//because there the default volume seems to be 0% and not the intended 100% volume\n//and because this is hacky crunched code, its non uniofurm between browsers or platforms.\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    // Normalized pixel coordinates (from 0 to 1)\n    vec2 uv = fragCoord/iResolution.xy;\n    ;uv=fract(uv*4.);\n\n    // Time varying pixel color\n    vec3 col = 0.5 + 0.5*cos(iTime+uv.xyx+vec3(0,2,4));\n\n    // Output to screen\n    fragColor = vec4(col,1.0);\n}\n\n\n/*\n\n\n\n/*\n\ni have made 3 html files that are [offline shadertoy]\n\ni made 3 html files that are [offline shadertoy]\n\nself     : https://www.shadertoy.com/view/tly3Rm\ngood twin: https://www.shadertoy.com/view/tly3Rm\ncousin: https://www.shadertoy.com/view/WdlSRl\ncousin: https://www.shadertoy.com/view/3slSRl\nthe html code is in the common-tab of these domains.\n\n\nboth are a messy hacky crippled reverse-engineered conversions.\nboth have no codemirror , and are single .html files to edit in a text editor\nif you have a bug in the opengl code, it will nto tell you the right line number within your html file, but it will describe the error.\n\none version only has the imageBuffer and Webaudio (in webgl and webgl2), mouseIn and webm Out.\nand is <61 k in size, can hack a quick 64k demo in [offline shadertoy] with this, has a working volume slider!\n\nthe other version is 220k small and has working features:\n- Webgl, webgl2, with all extensions that shadertoy lists.\n- mouseIn\n- KeyboardIn\n- opengl to webaudio [44,22,11]kHz\n- 4 double buffers whos previous frame can be loaded via texture(ichanel0,uv.xy)\n- Webm recording\n- fullscreen\n- audio syncs nicely with video for 180 seconds, pausing&resuming the audio desyncs it with the video.\n- can still change settings of buffers (thugh my ui is a bit crippled,it may have starting issues like an old car)\nnot managed to make work, but may just work with minor tweaks:\n- soundCloud in (may change a link to a local source somewhere, i didnt look into the httpreq part of that)\n- imageIn (same issue, can not use ANY texture, as these are streamed)\n- videoin (works not, just like ImagweIn...)\n- EnvMap\n- texture3d\n- Buff3d\n- webvr, code is still in, untested, be the forst to try Webvr shadertoy on a plane!\n\n(actually may be easy to add a 5th... double buffer to make up for lack of textureStreaming)\nso, it doesnt give you fast foutierTransformed ideal blue noise buffers, but a bayer matrix is fine , too.\n\ni still need to figure out how to fix its most basic UI issues, its html tables for now, just for simplicity.\n, with all my hacky gluelogic that i bridged over the httpReq and json code\n, i barely know what my [offline shadertoy] can and can not do.\n\nthe boilerplates of both files can \"easily\" be optimized and made roughly half as big, but the art is to not brak anything while crunching it.\n\n/**/\n\n/**/",
                "description": "",
                "inputs": [],
                "name": "Image",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 37
                    }
                ],
                "type": "image"
            },
            {
                "code": "/*   //remove this line from the html document, and the very last line of it\n\n\n\n<!DOCTYPE html>\n<html><head><title></title><style>\n.n{top:0px;left:0px;width100%;height:474px;position:relative;\n    padding-left:0px;padding-right:0px;margin-left:0px;margin-right:0px;}\n</style><script>\n//boilerplate==tinyFm303 ,<60k webaudio\n//moved to top because it sets opengl context modes,kinda important to debug.\nvar wMs=[\"experimental-webgl\",\"webgl\",\"experimental-webgl2\",\"webgl2\"]\n//var wMs=[\"webgl2\"]\nvar wM=4;//try version wMs[wM],and if that is not supported,diminish wM and retry.\nvar sRs=[44100,22050,11025,5512.5]//[3,6,12,24]min == [90,180,360,720]sec of play time (constrained by bufferSize/sampleRate)\nvar sR=1;//sRs[sR] points at a sample rate that is likely supported by webaudio\nfunction piCreateGlContext(cv,useAlpha,useDepth,usePreserveBuffer,useSupersampling){var opts=\n {alpha:useAlpha\n ,depth:useDepth\n ,stencil:false\n ,premultipliedAlpha:false\n ,antialias:useSupersampling\n ,preserveDrawingBuffer:usePreserveBuffer\n ,powerPreference:\"high-performance\"};//\"low_power\",\"high_performance\",\"default\"\n ;m=null\n ;while(wM>-1&&!m){m=cv.getContext(wMs[wM--],opts)}\n ;wM++\n ;return m;}\n</script><!--commontab code--><script id=\"o\">\n#define viewZoom 2.\n#define fra(u)(u-.5*iResolution.xy)*viewZoom/iResolution.y\n#define dd(a) dot(a,a)\n</script><!--Sound tab code--><script id=\"s\">\n\n\n\n\n//instrument,defined by an array of fourier coefficients,WTF!\n\n// Harmonics taken from\n// https://stackoverflow.com/questions/10702942/note-synthesis-harmonics-violin-piano-guitar-bass-frequencies-midi\n\n//https://www.shadertoy.com/view/XsyfDD\n//thx deep note intro\n\n#define DURATION 8.0\n#define INTRO 6.0\n\nfloat hash(uint x//uint hash via iq\n){uint k=1103515245U//seed\n ;x=((x>>8U)^x)*k\n ;x=((x>>8U)^x)*k\n ;x=((x>>8U)^x)*k\n ;return float(x)*(1.0/float(0xffffffffU));}\n\n\nstruct Intersection{\n    float totalDistance;\n    float mediumDistance;\n    float sdf;\n    float density;\n    int materialID;\n};\n    \nstruct Camera{\n\tvec3 origin;\n    vec3 direction;\n    vec3 left;\n    vec3 up;\n};\n    \nfloat hash1(float seed){\n    return fract(sin(seed)*43758.5453 );\n}\n\nfloat hash2D(vec2 x)\n{\n\tfloat i = dot(x,vec2(123.4031,46.5244876));\n\treturn fract(sin(i * 7.13) * 268573.103291);\n}\n\nCamera GetCamera(vec2 uv,float zoom,float time,int seed)\n{\n    float dist = 2.65 / zoom;\n    \n    vec3 target = vec3(0.0,0.0,0.2);\n    vec3 p = vec3(0.0,0.,0.2) + vec3(cos(time),0.0,sin(time)) * dist;\n        \n    vec3 forward = normalize(target - p);\n    vec3 left = normalize(cross(forward,vec3(0.0,1.0,0.0)));\n    vec3 up = normalize(cross(forward,left));\n\n    Camera cam;   \n    cam.origin = p;\n    cam.direction = normalize(forward - left * uv.x * zoom - up * uv.y * zoom);\n    cam.up = up;\n    cam.left = left;\n        \n    return cam;\n}\n\nconst float coeff[26] = float[26]\n(1.,.286699025,.150079537,.042909002,\n    .203797365,.229228698,.156931925,\n    .115470898,.0,.097401803,.087653465,\n    .052331036,.052922462,.038850593,\n    .053554676,.053697434,.022270261,\n    .013072562,.008585879,.005771505,\n    .004343925,.002141371,.005343231,\n    .000530244,.004711017,.009014153);\n\nfloat instrBase(float t\n){float r=0.\n ;t*=4.\n ;for(float i = 0.;i< 2.;++i)r+= sin(t*i*acos(-1.))*coeff[int(i)]\n ;for(float i = 0.;i< 3.;++i)r+= sin(t*i*acos(-1.))*coeff[int(i)]\n ;return r;}\n\nfloat instrument(float time\n){float s = 0.0\n ;s += instrBase(time)\n //;s += instrBase(time * .5) * .33\n //;s += instrBase(time * 2.0) * .05\n ;return s;}\n\n// Derivation (or integration :P) based on smootherstep\nfloat smoothChirp(float t,float from,float to,float duration\n){t /= duration\n ;float a = from * duration\n ;float b = to * duration\n ;// a x - (5 a x^4)/2 + (5 b x^4)/2 + 3 a x^5 - 3 b x^5 - a x^6 + b x^6\n ;float phase = a * t\n ;phase -= 5.0 * a * pow(t,4.0) * .5\n ;phase += 5.0 * b * pow(t,4.0) * .5\n ;phase += 3.0 * a * pow(t,5.0)\n ;phase -= 3.0 * b * pow(t,5.0)\n ;phase -= a * pow(t,6.0)\n ;phase += b * pow(t,6.0)\n ;float offset = (a + b) * .5 + .45\n ;float introFix = .375 // hack\n ;if(t > 1.0)        phase = b * t + offset\n ;    else if(t < 0.0)        phase = a * t + introFix\n ;\telse        phase += introFix\n ;  return instrument(phase);}\n\nvec2 mainSound( in int samp,float time\n){int voices = 30\n ; vec2 accum = vec2(0)\n ;for(int i = 0; i < voices; ++i\n ){vec3 r = vec3(hash(uint(i * 7)),hash(uint(i * 31)),hash(uint(i * 17)))\n  ;float r1 = r.x\n  ;float r2 =  r.y\n  ;float from = 100.0 + r1 * 200.0\n  ;float to = 587.0 - 2.6\n  ;int octave = int(r1 * 4.0) - 2\n  ;float oct = pow(2.0,float(octave))\n  ;if(r2 < .33)            to = 369.0\n  ;        else if(r2 < .66)            to = 440.0\n  ;        else            to += 5.0 * (r.z * 2.0 - 1.0)\n  ;        to *= oct\n  ;        from += sin(time * .6 + 1.95) * 7.0 * smoothstep(INTRO,0.0,time)\n  ;        float signal = smoothChirp(time - INTRO,from,to,DURATION)\n  ;        signal *= (1.0 - r1 * r1 * .5) * 2.0\n  ;     float ampByFreq = smoothstep(INTRO,DURATION + INTRO,time)\n  ;        signal *= 1.0 + mix(oct,1.0 / oct,ampByFreq)\n  ;     float offset = float(i) * .25\n  ;        float so = 2.15\n  ;accum += signal*vec2(cos(time * so + offset) * .5 + .5,sin(time * so + offset) * .5 + .5)\n ;}\n ;float bass=0.\n ;bass += instrument(293.0 * .125 * time) * .115\n ;    bass += instrument(587.0 * .25 * time) * .05\n ;    bass += instrument(587.0 * .125 * time) * .25\n ; bass *= .5 * smoothstep(DURATION + INTRO - 3.0,DURATION + INTRO,time)\n ; accum /= float(voices)\n ;    accum *= mix(1.0,1.3,smoothstep(INTRO+DURATION - 3.0,INTRO+DURATION + 2.0,time))\n ;    accum += vec2(bass)\n ;  float gT = time - DURATION\n ;    accum *= smoothstep(.0,INTRO + 2.0,time) * smoothstep(30.0,15.0,time - 4.0)\n ;return accum;}\n\n\n\n\n</script><!--Image tab code--><script id=\"i\">\n//Image\nvoid mainImage(out vec4 fragColor,in vec2 fragCoord\n){vec2 u=fra(fragCoord)\n ;vec4 m=vec4(fra(iMouse.xy),fra(iMouse.zw))\n ;vec2 p=sqrt(vec2(dd(u-m.xy),dd(u-m.zw)))\n ;p=smoothstep(.01,-.01,p-.1)\n ;float c=0.\n ;if(u.x>0.)c=.5+.5*cos(iTime+u.x)\n ;else{vec4 b=texture(iChannel0,fragCoord/iResolution.xy);c=max(max(b.x,b.y),b.z);}\n ;c=fract(c*9.)\n ;fragColor=vec4(p,c,1);}\n</script><script>\n\"use strict\"\n\nfunction gei(a){return document.getElementById(a).textContent;}//stringConcatenationExample:var striii=\"aaaa\"+gei('h')+\"tail\"\n\n//piLibs 2015-2017-https://iquilezles.org/www/material/piLibs/piLibs.htm\n//piFile\n\nfunction piFile(binaryDataArrayBuffer\n){var mDataView=binaryDataArrayBuffer\n ;var mOffset=0\n ;var me={}\n ;me.mDummy=0\n ;me.Seek=function(off){mOffset=off;}\n ;me.ReadUInt8=function(){var res=(new Uint8Array(mDataView,mOffset))[0];mOffset+=1;return res;}\n ;me.ReadUInt16=function(){var res=(new Uint16Array(mDataView,mOffset))[0];mOffset+=2;return res;}\n ;me.ReadUInt32=function(){var res=(new Uint32Array(mDataView,mOffset))[0];mOffset+=4;return res;}\n ;me.ReadUInt64=function(){return me.ReadUInt32()+(me.ReadUInt32()<<32);}\n ;me.ReadFloat32=function(){var res=(new Float32Array(mDataView,mOffset))[0];mOffset+=4;return res;}\n ;me.ReadFloat32Array=function(n\n ){var src=new Float32Array(mDataView,mOffset)\n  ;var res=[];for(var i=0;i<n;i++){res[i]=src[i];}\n  ;mOffset+=4*n\n  ;return res;}\n ;me.ReadFloat32ArrayNative=function(n){var src=new Float32Array(mDataView,mOffset);mOffset+=4*n;return src;}\n ;return me;}\n\nfunction piMesh(){this.mChunks=[];this.mPrimitiveType=0;this.mVertexFormat=null;}\n\npiMesh.prototype.scale=function(x,y,z\n){var stride=this.mVertexFormat.mStride/4\n ;for(var j=0;j<this.mChunks.length;j++\n ){var nv=this.mChunks[j].mNumVertices\n  ;for(var i=0;i<nv;i++\n  ){this.mChunks[j].mVerts[stride*i+0]*=x\n   ;this.mChunks[j].mVerts[stride*i+1]*=y\n   ;this.mChunks[j].mVerts[stride*i+2]*=z;}}}\n\npiMesh.prototype.translate=function(x,y,z\n){var stride=this.mVertexFormat.mStride/4\n ;for(var j=0;j<this.mChunks.length;j++\n ){var nv=this.mChunks[j].mNumVertices\n  ;for(var i=0;i<nv;i++\n  ){this.mChunks[j].mVerts[stride*i+0]+=x\n   ;this.mChunks[j].mVerts[stride*i+1]+=y\n   ;this.mChunks[j].mVerts[stride*i+2]+=z;}}}\n\npiMesh.prototype.GPULoad=function(renderer){return true;}\npiMesh.prototype.GPURender=function(renderer,positions){}\n\n//piLibs 2014-2017-https://iquilezles.org/www/material/piLibs/piLibs.htm\n//piRenderer\n\nvar mIs20=false;\nvar gShaderToy=null;\nvar gCode=null;\nvar gIsLiked=0;\nvar gRes=null;\nvar mAudioContext=null;\nvar mEffect=null;\nvar mTOffset=0;\nvar paused=false;\nvar mForceFrame=false;\nvar mTf=0;\nvar mRestarted=true;\n \nfunction piRenderer(\n){var m=null\n ;var pBindedShader=null\n ;var pFloat32Textures\n ;var pFloat32Filter\n ;var pFloat16Textures\n ;var pDrawBuffers\n ;var pDepthTextures\n ;var pDerivatives\n ;var pFloat32Filter\n ;var pFloat16Filter\n ;var pShaderTextureLOD\n ;var pAnisotropic\n ;var pRenderToFloat32F\n ;var pVBO_Quad=null\n ;var pVBO_Tri=null\n ;var pShaderHeader=[\"\",\"\"]\n ;var pm={}\n ;pm.TEXFMT   ={C4I8:0,C1I8:1,C1F16:2,C4F16:3,C1F32:4,C4F32:5,Z16:6,Z24:7,Z32:8}\n ;pm.TYPE     ={UINT8:0,UINT16:1,UINT32:2,FLOAT16:3,FLOAT32:4,FLOAT64:5}\n ;var iFormatPI2GL=function(format){if(mIs20\n     ){if(format===0)return{mFormat:m.RGBA8          ,mExternal:m.RGBA     ,mType:m.UNSIGNED_BYTE}\n else if(format===1)return{mFormat:m.R8             ,mExternal:m.RED      ,mType:m.UNSIGNED_BYTE}\n else if(format===5)return{mFormat:m.RGBA32F        ,mExternal:m.RGBA     ,mType:m.FLOAT}\n}else{if(format===0)return{mFormat:m.RGBA           ,mExternal:m.RGBA     ,mType:m.UNSIGNED_BYTE}\n else if(format===1)return{mFormat:m.LUMINANCE      ,mExternal:m.LUMINANCE,mType:m.UNSIGNED_BYTE}\n else if(format===5)return{mFormat:m.RGBA           ,mExternal:m.RGBA     ,mType:m.FLOAT}\n else if(format===6)return{mFormat:m.DEPTH_COMPONENT,mExternal:m.DEPTH_COMPONENT,mType:m.UNSIGNED_SHORT}}\n return null;}\n\n ;pm.Initialize=function(gl\n ){m=gl\n  ;mIs20=!(gl instanceof WebGLRenderingContext)\n  ;if(mIs20\n  ){pFloat32Textures=pFloat16Textures=pDerivatives=pDrawBuffers=pDepthTextures =pShaderTextureLOD=true\n   ;pFloat32Filter  =m.getExtension('OES_texture_float_linear')\n   ;pFloat16Filter  =m.getExtension('OES_texture_half_float_linear')\n   ;pAnisotropic=m.getExtension('EXT_texture_filter_anisotropic')\n   ;pRenderToFloat32F=m.getExtension('EXT_color_buffer_float')\n  ;}else\n   {pFloat32Textures=m.getExtension('OES_texture_float')\n   ;pFloat32Filter  =m.getExtension('OES_texture_float_linear')\n   ;pFloat16Textures=m.getExtension('OES_texture_half_float')\n   ;pFloat16Filter  =m.getExtension('OES_texture_half_float_linear')\n   ;pDerivatives    =m.getExtension('OES_standard_derivatives')\n   ;pDrawBuffers    =m.getExtension('WEBGL_draw_buffers')\n   ;pDepthTextures  =m.getExtension('WEBGL_depth_texture')\n   ;pShaderTextureLOD=m.getExtension('EXT_shader_texture_lod')\n   ;pAnisotropic    =m.getExtension('EXT_texture_filter_anisotropic')\n   ;pRenderToFloat32F=pFloat32Textures;}\n  ;var maxTexSize=m.getParameter(m.MAX_TEXTURE_SIZE)\n  ;var maxCubeSize=m.getParameter(m.MAX_CUBE_MAP_TEXTURE_SIZE)\n  ;var maxRenderbufferSize=m.getParameter(m.MAX_RENDERBUFFER_SIZE)\n  ;var extensions=m.getSupportedExtensions()\n  ;var textureUnits=m.getParameter(m.MAX_TEXTURE_IMAGE_UNITS)\n  ;var ph=\"precision highp \"\n  ;pVBO_Quad=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,pVBO_Quad);m.bufferData(m.ARRAY_BUFFER\n  ,new Float32Array([-1.0,-1.0,1.0,-1.0,-1.0,1.0,1.0,-1.0,1.0,1.0,-1.0,1.0]),m.STATIC_DRAW);m.bindBuffer(m.ARRAY_BUFFER,null)\n  ;pVBO_Tri=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,pVBO_Tri);m.bufferData(m.ARRAY_BUFFER//screenspace filling triangle\n  ,new Float32Array([-1.0,-1.0,3.0,-1.0,-1.0,3.0]),m.STATIC_DRAW);m.bindBuffer(m.ARRAY_BUFFER,null)   \n  ;pShaderHeader[0]=\"\"\n  ;var es300for100=\"float round(float x){return floor(x+0.5);}\\n\"\n  +\"vec2 round(vec2 x){return floor(x+0.5);}\\n\"\n  +\"vec3 round(vec3 x){return floor(x+0.5);}\\n\"\n  +\"vec4 round(vec4 x){return floor(x+0.5);}\\n\"\n  +\"float trunc(float x,float n){return floor(x*n)/n;}\\n\"\n  +\"mat3 transpose(mat3 m){return mat3(m[0].x,m[1].x,m[2].x,m[0].y,m[1].y,m[2].y,m[0].z,m[1].z,m[2].z);}\\n\"\n  +\"float determinant(in mat2 m){return m[0][0]*m[1][1]-m[0][1]*m[1][0];}\\n\"\n  +\"float determinant(mat4 m){\"\n  +\"float b00=m[0][0]*m[1][1]-m[0][1]*m[1][0],b01=m[0][0]*m[1][2]-m[0][2]*m[1][0]\"\n  +\",b02=m[0][0]*m[1][3]-m[0][3]*m[1][0],b03=m[0][1]*m[1][2]-m[0][2]*m[1][1]\"\n  +\",b04=m[0][1]*m[1][3]-m[0][3]*m[1][1],b05=m[0][2]*m[1][3]-m[0][3]*m[1][2]\"+\",b06=m[2][0]*m[3][1]-m[2][1]*m[3][0],b07=m[2][0]*m[3][2]-m[2][2]*m[3][0]\"+\",b08=m[2][0]*m[3][3]-m[2][3]*m[3][0],b09=m[2][1]*m[3][2]-m[2][2]*m[3][1]\"+\",b10=m[2][1]*m[3][3]-m[2][3]*m[3][1],b11=m[2][2]*m[3][3]-m[2][3]*m[3][2];\"+\"return b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;}\\n\"\n  +\"mat2 inverse(mat2 m){float det=determinant(m);return mat2(m[1][1],-m[0][1],-m[1][0],m[0][0])/det;}\\n\"\n  +\"mat4 inverse(mat4 m){\"\n  +\"float inv0 = m[1].y*m[2].z*m[3].w-m[1].y*m[2].w*m[3].z-m[2].y*m[1].z*m[3].w+m[2].y*m[1].w*m[3].z+m[3].y*m[1].z*m[2].w-m[3].y*m[1].w*m[2].z;\"\n  +\"float inv4 =-m[1].x*m[2].z*m[3].w+m[1].x*m[2].w*m[3].z+m[2].x*m[1].z*m[3].w-m[2].x*m[1].w*m[3].z-m[3].x*m[1].z*m[2].w+m[3].x*m[1].w*m[2].z;\"\n  +\"float inv8 = m[1].x*m[2].y*m[3].w-m[1].x*m[2].w*m[3].y-m[2].x*m[1].y*m[3].w+m[2].x*m[1].w*m[3].y+m[3].x*m[1].y*m[2].w-m[3].x*m[1].w*m[2].y;\"\n  +\"float inv12=-m[1].x*m[2].y*m[3].z+m[1].x*m[2].z*m[3].y+m[2].x*m[1].y*m[3].z-m[2].x*m[1].z*m[3].y-m[3].x*m[1].y*m[2].z+m[3].x*m[1].z*m[2].y;\"\n  +\"float inv1 =-m[0].y*m[2].z*m[3].w+m[0].y*m[2].w*m[3].z+m[2].y*m[0].z*m[3].w-m[2].y*m[0].w*m[3].z-m[3].y*m[0].z*m[2].w+m[3].y*m[0].w*m[2].z;\"\n  +\"float inv5 = m[0].x*m[2].z*m[3].w-m[0].x*m[2].w*m[3].z-m[2].x*m[0].z*m[3].w+m[2].x*m[0].w*m[3].z+m[3].x*m[0].z*m[2].w-m[3].x*m[0].w*m[2].z;\"\n  +\"float inv9 =-m[0].x*m[2].y*m[3].w+m[0].x*m[2].w*m[3].y+m[2].x*m[0].y*m[3].w-m[2].x*m[0].w*m[3].y-m[3].x*m[0].y*m[2].w+m[3].x*m[0].w*m[2].y;\"\n  +\"float inv13= m[0].x*m[2].y*m[3].z-m[0].x*m[2].z*m[3].y-m[2].x*m[0].y*m[3].z+m[2].x*m[0].z*m[3].y+m[3].x*m[0].y*m[2].z-m[3].x*m[0].z*m[2].y;\"\n  +\"float inv2 = m[0].y*m[1].z*m[3].w-m[0].y*m[1].w*m[3].z-m[1].y*m[0].z*m[3].w+m[1].y*m[0].w*m[3].z+m[3].y*m[0].z*m[1].w-m[3].y*m[0].w*m[1].z;\"\n  +\"float inv6 =-m[0].x*m[1].z*m[3].w+m[0].x*m[1].w*m[3].z+m[1].x*m[0].z*m[3].w-m[1].x*m[0].w*m[3].z-m[3].x*m[0].z*m[1].w+m[3].x*m[0].w*m[1].z;\"\n  +\"float inv10= m[0].x*m[1].y*m[3].w-m[0].x*m[1].w*m[3].y-m[1].x*m[0].y*m[3].w+m[1].x*m[0].w*m[3].y+m[3].x*m[0].y*m[1].w-m[3].x*m[0].w*m[1].y;\"\n  +\"float inv14=-m[0].x*m[1].y*m[3].z+m[0].x*m[1].z*m[3].y+m[1].x*m[0].y*m[3].z-m[1].x*m[0].z*m[3].y-m[3].x*m[0].y*m[1].z+m[3].x*m[0].z*m[1].y;\"\n  +\"float inv3 =-m[0].y*m[1].z*m[2].w+m[0].y*m[1].w*m[2].z+m[1].y*m[0].z*m[2].w-m[1].y*m[0].w*m[2].z-m[2].y*m[0].z*m[1].w+m[2].y*m[0].w*m[1].z;\"\n  +\"float inv7 = m[0].x*m[1].z*m[2].w-m[0].x*m[1].w*m[2].z-m[1].x*m[0].z*m[2].w+m[1].x*m[0].w*m[2].z+m[2].x*m[0].z*m[1].w-m[2].x*m[0].w*m[1].z;\"\n  +\"float inv11=-m[0].x*m[1].y*m[2].w+m[0].x*m[1].w*m[2].y+m[1].x*m[0].y*m[2].w-m[1].x*m[0].w*m[2].y-m[2].x*m[0].y*m[1].w+m[2].x*m[0].w*m[1].y;\"\n  +\"float inv15= m[0].x*m[1].y*m[2].z-m[0].x*m[1].z*m[2].y-m[1].x*m[0].y*m[2].z+m[1].x*m[0].z*m[2].y+m[2].x*m[0].y*m[1].z-m[2].x*m[0].z*m[1].y;\"\n  +\"float det=m[0].x*inv0+m[0].y*inv4+m[0].z*inv8+m[0].w*inv12;det=1.0/det\"\n  +\";return det*mat4(inv0,inv1,inv2,inv3,inv4,inv5,inv6,inv7,inv8,inv9,inv10,inv11,inv12,inv13,inv14,inv15);}\\n\"\n  +\"float sinh(float x){return (exp(x)-exp(-x))/2.;}\\n float cosh(float x){return (exp(x)+exp(-x))/2.;}\\n\"\n  +\"float tanh(float x){return sinh(x)/cosh(x);}\\n float csch(float x){return 1./sinh(x);}\\n\"\n  +\"float coth(float x){return cosh(x)/sinh(x);}\\n float sech(float x){return 1./cosh(x);}\\n\"\n  +\"float atanh(float x){return .5*log((1.+x)/(1.-x));}\\n float asinh(float x){return log(x+sqrt(x*x+1.));}\\n float asech(float x){return log((1.+sqrt(1.-x*x))/x);}\\n\"\n  +\"float acoth(float x){return .5*log((x+1.)/(x-1.));}\\n float acosh(float x){return log(x+sqrt(x*x-1.));}\\n float acsch(float x){return log((1.+sqrt(1.+x*x))/x);}\\n\"\n  ;var prec=\"#ifdef GL_ES\\n\"+ph+\"float;\\n\"+\"precision highp int;\\n\"\n  ;var v300=\"#version 300 es\\n\"\n  ;var v300e=\"precision mediump sampler3D;\\n\"+\"#endif\\n\"\n  ;if(mIs20)pShaderHeader[0]+=v300+prec+v300e\n  ;else    pShaderHeader[0]+=prec+\"#endif\\n\"+es300for100\n  ;pShaderHeader[1]=\"\"\n  ;if(mIs20){pShaderHeader[1]+=v300+prec+v300e\n  ;}else\n   {if(pDerivatives){pShaderHeader[1]+=\"#ifdef GL_OES_standard_derivatives\\n#extension GL_OES_standard_derivatives:enable\\n#endif\\n\";}\n   ;if(pShaderTextureLOD){pShaderHeader[1]+=\"#extension GL_EXT_shader_texture_lod:enable\\n\";} \n   ;var t4=\"vec4 texture\"\n   ;var ts=t4+\"(sampler\"\n   ;var tc=\"){return textureCube(s,c\"\n   ;var sa=\"(sampler2D s,vec2 c,\"\n   ;var r2=\"){return texture2D\"\n   ;pShaderHeader[1]+=\"#ifdef GL_ES\\n\"+ph+\"float;\\n\"+ph+\"int;\\n\"+\"#endif\\n\"\n  +ts+\"2D   s,vec2 c\"+r2+\"(s,c);}\\n\"+ts+\"2D   s,vec2 c,float b\"+r2+\"(s,c,b);}\\n\"\n  +ts+\"Cube s,vec3 c\"+tc+\");}\\n\"   +ts+\"Cube s,vec3 c,float b\"+tc+\",b);}\\n\"\n  +es300for100\n   ;if(pShaderTextureLOD){pShaderHeader[1]\n   +=t4+\"Lod\"+sa+\"float b         \"+r2+\"LodEXT(s,c,b);}\\n\"\n   +t4+\"Grad\"+sa+\"vec2 dx,vec2 dy\"+r2+\"GradEXT(s,c,dx,dy);}\\n\"}}return true;}\n ;\n ;pm.GetCaps=function(\n ){return{mIsGL20:mIs20\n  ,pFloat32Textures:pFloat32Textures!=null\n  ,pFloat16Textures:pFloat16Textures!=null\n      ,pDrawBuffers:pDrawBuffers!=null\n    ,pDepthTextures:pDepthTextures!=null\n      ,pDerivatives:pDerivatives!=null\n ,pShaderTextureLOD:pShaderTextureLOD!=null};}\n ;\n ;pm.CheckErrors=function(\n ){var error=m.getError()\n  ;if(error!=m.NO_ERROR\n  ){for(var prop in m\n   ){if(typeof m[prop]=='number'\n    ){if(m[prop]==error){console.log(\"GL Error \"+error+\":\"+prop);break;}   }}}}\n ;\n ;pm.Clear=function(flags,ccolor,cdepth,cstencil\n ){var mode=0\n  ;if(flags & 1){mode |=m.COLOR_BUFFER_BIT;m.clearColor(ccolor[0],ccolor[1],ccolor[2],ccolor[3]);}\n  ;if(flags & 2){mode |=m.DEPTH_BUFFER_BIT;m.clearDepth(cdepth);}\n  ;if(flags & 4){mode |=m.STENCIL_BUFFER_BIT;m.clearStencil(cstencil);}\n  ;m.clear(mode);}\n ;\n ;pm.CreateTexture=function(type,x,y,format,filter,wrap,buffer\n ){if(m===null)return null\n  ;var id=m.createTexture()\n  ;var glFoTy=iFormatPI2GL(format)\n  ;var glWrap=1;if(wrap===0)glWrap=m.CLAMP_TO_EDGE\n  ;if(type===0\n  ){m.bindTexture(m.TEXTURE_2D,id)\n   ;m.texImage2D(m.TEXTURE_2D,0,glFoTy.mFormat,x,y,0,glFoTy.mExternal,glFoTy.mType,buffer)\n   ;m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,glWrap)\n   ;m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,glWrap)\n   ;m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.NEAREST)\n   ;m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.NEAREST)\n   ;m.bindTexture(m.TEXTURE_2D,null)\n  ;}\n ;return{mObjectID:id,mXres:x,mYres:y,mFormat:format,mType:type,mFilter:filter,mWrap:wrap,mVFlip:false};}\n ;pm.CreateTextureFromImage=function(type,image,format,filter,wrap,flipY\n ){if(m===null)return null\n  ;var id=m.createTexture()\n  ;var glFoTy=iFormatPI2GL(format)\n  ;var glWrap=1;if(wrap===0)glWrap=m.CLAMP_TO_EDGE\n  ;if(type===0\n  ){m.bindTexture(m.TEXTURE_2D,id)\n   ;m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,flipY)\n   ;m.pixelStorei(m.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)\n   ;if(mIs20)m.pixelStorei(m.UNPACK_COLORSPACE_CONVERSION_WEBGL,m.NONE)\n   ;m.texImage2D(m.TEXTURE_2D,0,glFoTy.mFormat,glFoTy.mExternal,glFoTy.mType,image)\n   ;m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,glWrap)\n   ;m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,glWrap)\n   ;m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.NEAREST)\n   ;m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.NEAREST)\n   ;m.bindTexture(m.TEXTURE_2D,null)\n   ;}\n  ;return{mObjectID:id,mXres:image.width,mYres:image.height,mFormat:format,mType:type,mFilter:filter,mWrap:wrap,mVFlip:flipY};}\n ; ;\n ;pm.UpdateTexture=function(tex,x0,y0,x,y,buffer\n ){var glFoTy=iFormatPI2GL(tex.mFormat)\n  ;if(tex.mType===0\n  ){m.activeTexture(m.TEXTURE0)\n   ;m.bindTexture(m.TEXTURE_2D,tex.mObjectID)\n   ;m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,tex.mVFlip)\n   ;m.texSubImage2D(m.TEXTURE_2D,0,x0,y0,x,y,glFoTy.mExternal,glFoTy.mType,buffer)\n   ;m.bindTexture(m.TEXTURE_2D,null);}}\n ;\n ;pm.UpdateTextureFromImage=function(tex,image\n ){var glFoTy=iFormatPI2GL(tex.mFormat)\n  ;if(tex.mType===0\n  ){m.activeTexture(m.TEXTURE0)\n   ;m.bindTexture(m.TEXTURE_2D,tex.mObjectID)\n   ;m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,tex.mVFlip)\n   ;m.texImage2D(m.TEXTURE_2D,0,glFoTy.mFormat,glFoTy.mExternal,glFoTy.mType,image)\n   ;m.bindTexture(m.TEXTURE_2D,null);}};\n ;\n ;pm.CreateRenderTarget=function(color0,color1,color2,color3,depth,wantZbuffer\n ){var i=m.createFramebuffer()\n  ;m.bindFramebuffer(m.FRAMEBUFFER,i)\n  ;if(color0!=null)m.framebufferTexture2D(m.FRAMEBUFFER,m.COLOR_ATTACHMENT0,m.TEXTURE_2D,color0.mObjectID,0)\n  ;m.bindRenderbuffer(m.RENDERBUFFER,null);m.bindFramebuffer(m.FRAMEBUFFER,null);return{mObjectID:i};}\n ;\n ;pm.DestroyRenderTarget=function(tex){m.deleteFramebuffer(tex.mObjectID);}\n ;\n ;pm.SetRenderTarget=function(t){m.bindFramebuffer(m.FRAMEBUFFER,(t===null?null:t.mObjectID));}\n ;\n ;pm.CreateRenderTargetNew=function(wantColor0,wantZbuffer,x,y,samples\n ){var id=m.createFramebuffer()\n  ;m.bindFramebuffer(m.FRAMEBUFFER,id)\n  ;if(want2===true\n  ){var zb=m.createRenderbuffer()\n   ;m.bindRenderbuffer(m.RENDERBUFFER,zb)\n   ;if(samples==1)m.renderbufferStorage(m.RENDERBUFFER,m.DEPTH_COMPONENT16,x,y)\n   ;else          m.renderbufferStorageMultisample(m.RENDERBUFFER,samples,m.DEPTH_COMPONENT16,x,y)\n   ;m.framebufferRenderbuffer(m.FRAMEBUFFER,m.DEPTH_ATTACHMENT,m.RENDERBUFFER,zb);}\n  ;if(wantColor0\n  ){var cb=m.createRenderbuffer()\n   ;m.bindRenderbuffer(m.RENDERBUFFER,cb)\n   ;if(samples==1)m.renderbufferStorage(m.RENDERBUFFER,m.RGBA8,x,y)\n            ;else m.renderbufferStorageMultisample(m.RENDERBUFFER,samples,m.RGBA8,x,y)\n   ;m.framebufferRenderbuffer(m.FRAMEBUFFER,m.COLOR_ATTACHMENT0,m.RENDERBUFFER,cb);}\n   ;if(m.checkFramebufferStatus(m.FRAMEBUFFER)!=m.FRAMEBUFFER_COMPLETE){return null;}\n   ;m.bindRenderbuffer(m.RENDERBUFFER,null);m.bindFramebuffer(m.FRAMEBUFFER,null)\n   ;return{mObjectID:id,mXres:x,mYres:y};}\n ;\n ;pm.BlitRenderTarget=function(dst,src\n ){m.bindFramebuffer(m.READ_FRAMEBUFFER,src.mObjectID)\n  ;m.bindFramebuffer(m.DRAW_FRAMEBUFFER,dst.mObjectID)\n  ;m.clearBufferfv(m.COLOR,0,[0.0,0.0,0.0,1.0])\n  ;m.blitFramebuffer(0,0,src.mXres,src.mYres,0,0,src.mXres,src.mYres,m.COLOR_BUFFER_BIT,m.LINEAR);}\n ;\n ;pm.SetViewport=function(vp){m.viewport(vp[0],vp[1],vp[2],vp[3]);}\n ;pm.SetWriteMask=function(c0,c1,c2,c3,z){m.depthMask(z);m.colorMask(c0,c0,c0,c0);}\n ;\n ;pm.SetState=function(stateName,stateValue\n ){}\n ;\n ;pm.SetMultisample=function(v\n ){if(v===true){m.enable(m.SAMPLE_COVERAGE);m.sampleCoverage(1.0,false);}else{m.disable(m.SAMPLE_COVERAGE);}}\n ;\n ;pm.CreateShader=function(vsSource,fsSource\n ){if(m===null)return{mProgram:null,mResult:false,mInfo:\"No WebGL\",mHeaderLines:0}\n  ;var te={mProgram:null,mResult:true,mInfo:\"compile success\",mHeaderLines:0,mErrorType:0}\n  ;var vs=m.createShader(m.VERTEX_SHADER)\n  ;var fs=m.createShader(m.FRAGMENT_SHADER)\n  ;vsSource=pShaderHeader[0]+vsSource\n  ;fsSource=pShaderHeader[1]+fsSource\n  ;m.shaderSource(vs,vsSource)\n  ;m.shaderSource(fs,fsSource)\n  ;m.compileShader(vs)\n  ;m.compileShader(fs)\n  ;if(!m.getShaderParameter(vs,m.COMPILE_STATUS)){var infoLog=m.getShaderInfoLog(vs);;te.mResult=false\n   ;return te;}\n  ;if(!m.getShaderParameter(fs,m.COMPILE_STATUS)\n  ){var infoLog=m.getShaderInfoLog(fs)\n   ;te.mResult=false\n   ;return te;}\n  ;te.mProgram=m.createProgram()\n  ;m.attachShader(te.mProgram,vs)\n  ;m.attachShader(te.mProgram,fs)\n  ;m.linkProgram(te.mProgram)\n  ;if(!m.getProgramParameter(te.mProgram,m.LINK_STATUS)\n  ){var infoLog=m.getProgramInfoLog(te.mProgram)\n   ;m.deleteProgram(te.mProgram)\n   ;te.mResult=false\n   ;return te;}return te;}\n ;\n ;pm.AttachShader=function(s){if(s===null){pBindedShader=null;m.useProgram(null);}else{pBindedShader=s;m.useProgram(s.mProgram);}}\n ;\n ;pm.DetachShader=function(){m.useProgram(null);}\n ;pm.DestroyShader=function(tex){m.deleteProgram(tex.mProgram);}\n ;pm.GetAttribLocation=function(shader,name){return m.getAttribLocation(shader.mProgram,name);}\n ;pm.sscLocation=function(shader,name){return m.getUniformLocation(shader.mProgram,name);}\n ;pm.sscMat4F=function(uname,params,istranspose\n ){var program=pBindedShader\n  ;var pos=m.getUniformLocation(program.mProgram,uname)\n  ;if(pos===null)return false\n  ;if(istranspose===false\n  ){var tmp=new Float32Array([params[0],params[4],params[8],params[12],params[1],params[5],params[9],params[13]\n                            ,params[2],params[6],params[10],params[14],params[3],params[7],params[11],params[15]])\n   ;m.uniformMatrix4fv(pos,false,tmp)\n  ;}else m.uniformMatrix4fv(pos,false,new Float32Array(params))\n  ;return true;}\n ;\n ;pm.gulf=function(m,u){return m.getUniformLocation(pBindedShader.mProgram,u);}\n ;pm.ssc1F =function(u,x){var p=pm.gulf(m,u);if(p===null)return false;m.uniform1f(p,x);return true;}\n ;pm.ssc1I =function(u,x){var p=pm.gulf(m,u);if(p===null)return false;m.uniform1i(p,x);return true;}\n ;pm.ssc2F =function(u,x){var p=pm.gulf(m,u);if(p===null)return false;m.uniform2fv(p,x);return true;}\n ;pm.ssc1FV=function(u,x){var p=pm.gulf(m,u);if(p===null)return false;m.uniform1fv(p,new Float32Array(x));return true;}\n ;pm.ssc3FV=function(u,x){var p=pm.gulf(m,u);if(p===null)return false;m.uniform3fv(p,new Float32Array(x));return true;}\n ;pm.ssc4FV=function(u,x){var p=pm.gulf(m,u);if(p===null)return false;m.uniform4fv(p,new Float32Array(x));return true;}\n ;pm.ssc1F_Pos=function(p,x){m.uniform1f(p,x);return true;}\n ;pm.ssc3F=function(u,x,y,z){var p=pm.gulf(m,u);if(p===null)return false;m.uniform3f(p,x,y,z);return true;}\n ;pm.SetShaderTextureUnit=function(u,unit\n ){var program=pBindedShader;var p=m.getUniformLocation(program.mProgram,u);if(p===null)return false;m.uniform1i(p,unit);return true;}\n ;\n ;pm.DrawFullScreenTriangle_XY=function(v){m.bindBuffer(m.ARRAY_BUFFER,pVBO_Tri)\n  ;m.vertexAttribPointer(v,2,m.FLOAT,false,0,0);m.enableVertexAttribArray(v)\n  ;m.drawArrays(4,0,3);m.disableVertexAttribArray(v);m.bindBuffer(m.ARRAY_BUFFER,null);}\n ;pm.DrawUnitQuad_XY=function(v){m.bindBuffer(m.ARRAY_BUFFER,pVBO_Quad)\n  ;m.vertexAttribPointer(v,2,m.FLOAT,false,0,0);m.enableVertexAttribArray(v)\n  ;m.drawArrays(4,0,6);m.disableVertexAttribArray(v);m.bindBuffer(m.ARRAY_BUFFER,null);};\n\npm.SetBlend=function(t\n){if(t\n ){m.enable(m.BLEND)\n  ;m.blendEquationSeparate(m.FUNC_ADD,m.FUNC_ADD)\n  ;m.blendFuncSeparate(m.SRC_ALPHA,m.ONE_MINUS_SRC_ALPHA,m.ONE,m.ONE_MINUS_SRC_ALPHA)\n ;}else{m.disable(m.BLEND);}};\n\npm.GetPixelData=function(data,x,y\n){m.readPixels(0,0,x,y,m.RGBA,m.UNSIGNED_BYTE,data);};return pm;}\n\n//piLibs 2015-2017-https://iquilezles.org/www/material/piLibs/piLibs.htm\n//piWebUtils\n\nfunction min(a,b){return (a<b)? a:b;}\n\n//RequestAnimationFrame\nwindow.requestAnimFrame=(function(){return window.requestAnimationFrame    \n||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame\n||window.msRequestAnimationFrame||function(cb){window.setTimeout(cb,1000/60);};})();\n\nwindow.getRealTime=(function(){if(\"performance\" in window)return function(){return window.performance.now();}\n           return function(){return (new Date()).getTime();}})();\n\nwindow.URL=window.URL||window.webkitURL;\n\nnavigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;\n\nfunction htmlEntities(str){return str;}\n\n\nvar piGetTime=function(t){if(t==0)return \"\" ;return new Date(t*1000).toISOString().substr(0,10);}\n\nfunction piGetCoords(o){var x=0;var y=0;do{x+=o.offsetLeft;y+=o.offsetTop;}while(o=o.offsetParent);return{mX:x,mY:y};}\n\nfunction piGetMouseCoords(ev,canvasElement\n){var pos=piGetCoords(canvasElement)\n ;var mcx=         (ev.pageX-pos.mX)* canvasElement.width/canvasElement.offsetWidth\n ;var mcy=canvasElement.height-(ev.pageY-pos.mY)* canvasElement.height/canvasElement.offsetHeight\n ;return{mX:mcx,mY:mcy};}\n\nfunction piGetSourceElement(e){var ele=null;if(e.target)ele=e.target;if(e.srcElement)ele=e.srcElement;return ele;}\n\nfunction piRequestFullScreen(ele\n){if(ele==null)ele=document.documentElement\n ;if(ele.requestFullscreen)ele.requestFullscreen()\n ;else if(ele.msRequestFullscreen)ele.msRequestFullscreen()\n ;else if(ele.mozRequestFullScreen)ele.mozRequestFullScreen()\n ;else if(ele.webkitRequestFullscreen)ele.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}\n\nfunction piIsFullScreen(\n){return document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen||document.msFullscreenElement||false;}\n\nfunction piExitFullScreen(\n){if(document.exitFullscreen)document.exitFullscreen()\n ;else if(document.msExitFullscreen)document.msExitFullscreen()\n ;else if(document.mozCancelFullScreen)document.mozCancelFullScreen()\n ;else if(document.webkitExitFullscreen)document.webkitExitFullscreen();}\n\n\n\n\nfunction piCreateAudioContext(\n){var res=null\n ;try    {if(window.AudioContext)res=new AudioContext()\n  ;if(res==null&&window.webkitAudioContext)res=new webkitAudioContext();}catch(e){res=null;}return res;}\n\n\nfunction piCreateFPSCounter(\n){var mFrame\n ;var mTo\n ;var mFPS\n ;var iReset=function(time){mFrame=0;mTo=time;mFPS=60.0;}\n ;var iCount=function(time\n ){mFrame++\n  ;if((time-mTo)>500.0\n  ){mFPS=1000.0*mFrame/(time-mTo)\n   ;mFrame=0\n   ;mTo=time\n   ;return true;}return false;}\n ;var iGetFPS=function(){return mFPS;}\n ;return{Reset:iReset,Count:iCount,GetFPS:iGetFPS};}\n\nfunction piCanMediaRecorded(canvas\n){if(typeof window.MediaRecorder !=='function'||typeof canvas.captureStream !=='function'){return false;}\n    return true;\n}\nfunction piCreateMediaRecorder(isRecordingCallback,canvas\n){if(piCanMediaRecorded(canvas)==false){return null;}\n ;var mediaRecorder=new MediaRecorder(canvas.captureStream())\n ;var chunks=[]\n ;mediaRecorder.ondataavailable=function(e){if(e.data.size>0){chunks.push(e.data);}}\n ;mediaRecorder.onstart=function(){isRecordingCallback(true);}\n ;mediaRecorder.onstop=function(\n ){isRecordingCallback(false)\n  ;let blob   =new Blob(chunks,{type:\"video/webm\"})\n  ;chunks     =[]\n  ;let videoURL=window.URL.createObjectURL(blob)\n  ;let url    =window.URL.createObjectURL(blob)\n  ;let a      =document.createElement(\"a\")\n  ;document.body.appendChild(a)\n  ;a.style    =\"display:none\"\n  ;a.href     =url\n  ;a.download =\"capture.webm\"\n  ;a.click()\n  ;window.URL.revokeObjectURL(url);}\n  ;return mediaRecorder;}\n\n\n\nfunction EffectPass(renderer,is20,hasShaderTextureLOD,callback,obj,forceMuted,forcePaused,outputGainNode,copyProgram,id\n){this.mID=id\n ;this.mInputs=[null,null,null,null]\n ;this.mOutputs=[null,null,null,null]\n ;this.mSource=null\n ;this.mGainNode=outputGainNode\n ;this.mRenderer=renderer\n ;this.mProgramCopy=copyProgram\n ;this.mType=\"image\"\n ;this.mName=\"none\"\n ;this.mFrame=0\n ;this.pShaderTextureLOD=hasShaderTextureLOD\n ;this.mTextureCallbackFun=callback\n ;this.mTextureCallbackObj=obj\n ;this.mForceMuted=forceMuted\n ;this.mForcePaused=forcePaused ;}\n\nEffectPass.prototype.MakeHeader=function(\n){if(this.mType==\"image\"){this.mHeader=\"uniform vec3  iResolution;uniform float iTime;\"\n +\"uniform float iChannelTime[4];uniform vec4  iMouse;\"  \n }else this.mHeader=\"uniform float iChannelTime[4];uniform float iBlockOffset;\\n\"\n ;this.mHeader+=\"uniform vec4 iDate;uniform float iSampleRate;uniform vec3 iChannelResolution[4];\\n\";\n if(this.mType==\"image\"\n ){this.mHeader+=\"uniform int iFrame;uniform float iTimeDelta;uniform float iFrameRate;\"\n  +\"struct Channel{vec3 resolution;float time;};uniform Channel iChannel[4];\"\n  ;for(var i=0;i<this.mInputs.length;i++){var inp=this.mInputs[i];this.mHeader+=\"uniform sampler2D iChannel\"+i+\";\";}\n  ;this.mHeader+=\"void mainImage(out vec4 c,in vec2 f);\"\n  ;this.mImagePassFooter=(mIs20?\"\\nout vec4 outColor;\":\"\")\n  +\"\\nvoid main(void){vec4 color=vec4(0,0,0,1);mainImage(color,gl_FragCoord.xy);color.w=1.0;\"\n  +(mIs20?\"out\":\"gl_Frag\")+\"Color=color;}\";}}\n\nEffectPass.prototype.Destroy_Sound=function(wa\n){    if(this.mPlayNode!=null)this.mPlayNode.stop()\n ;this.mPlayNode=null\n ;this.mBuffer=null\n ;this.mData=null\n ;this.mRenderer.DestroyTexture(this.mRenderTexture);}\n\nEffectPass.prototype.Create=function(passType,passName,wa\n){this.mType=passType\n ;this.mName=passName\n ;this.mSource=null\n ;this.MakeHeader() \n ;if(passType==\"sound\"\n ){if(mIs20\n  ){this.mSoundPassFooter=\"\\nout vec4 outColor;void main(){\" \n   +\"float t=iBlockOffset+((gl_FragCoord.x-0.5)+(gl_FragCoord.y-0.5)*512.0)/iSampleRate;\" \n   +\"vec2 y=mainSound( in int samp,t);\" \n   +\"vec2 v=floor((0.5+0.5*y)*65536.0);\" \n   +\"vec2 vl=mod(v,256.0)/255.0;\" \n   +\"vec2 vh=floor(v/256.0)/255.0;\"\n   +\"outColor=vec4(vl.x,vh.x,vl.y,vh.y);}\"\n  ;}else{\n   ;this.mSoundPassFooter=\"\\nvoid main(){\"\n   +\"float t=iBlockOffset+((gl_FragCoord.x-0.5)+(gl_FragCoord.y-0.5)*512.0)/iSampleRate;\"\n   +\"vec2 y=mainSound( in int samp,t);\"\n   +\"vec2 v=floor((0.5+0.5*y)*65536.0);\"\n   +\"vec2 vl=mod(v,256.0)/255.0;\"\n   +\"vec2 vh=floor(v/256.0)/255.0;\"\n   +\"gl_FragColor=vec4(vl.x,vh.x,vl.y,vh.y);}\";}\n  ;this.mProgram=null\n  ;this.mSampleRate=sRs[sR]\n  ;this.mPlayTime=60*3*sRs[0]/sRs[sR]\n  ;this.mPlaySamples=this.mPlayTime*this.mSampleRate\n  ;this.mBuffer=wa.createBuffer(2,this.mPlaySamples,this.mSampleRate)\n  ;this.mTextureDimensions=512\n  ;this.mRenderTexture=this.mRenderer.CreateTexture(0\n  ,      this.mTextureDimensions,this.mTextureDimensions\n  ,      this.mRenderer.TEXFMT.C4I8,0,      0,null)\n  ;this.mRenderFBO=this.mRenderer.CreateRenderTarget(this.mRenderTexture,null,null,null,null,false)\n  ;this.mTmpBufferSamples=this.mTextureDimensions*this.mTextureDimensions\n  ;this.mData=new Uint8Array(this.mTmpBufferSamples*4)\n  ;this.mPlayNode=null\n ;}}\n\nEffectPass.prototype.Destroy=function(wa\n){this.mSource=null\n ;if(this.mType==\"sound\")this.Destroy_Sound(wa)\n ;else if(this.mType==\"common\")this.Destroy_Common(wa);}\n\nEffectPass.prototype.NewShader_Sound=function(shaderCode,commonShaderCodes\n){var vsSource=((mIs20)?\"layout(location=0)in\":\"attribute\")+\" vec2 pos;void main(){gl_Position=vec4(pos.xy,0.0,1.0);}\"\n ;var fsSource=this.mHeader\n ;fsSource+=gei('o')\n ;fsSource+=shaderCode\n ;fsSource+=this.mSoundPassFooter\n ;var res=this.mRenderer.CreateShader(vsSource,fsSource)\n ;if(res.mResult==false)return res.mInfo\n ;if(this.mProgram!=null)this.mRenderer.DestroyShader(this.mProgram)\n ;this.mProgram=res\n ;this.mFrame=0\n ;return null;}\n\nEffectPass.prototype.NewShader_Image=function(shaderCode,commonShaderCodes\n){var vsSource=((mIs20)?\"layout(location=0)in\":\"attribute\")+\" vec2 pos;void main(){gl_Position=vec4(pos.xy,0.0,1.0);}\"\n ;var fsSource=this.mHeader\n ;for(var i=0;i<commonShaderCodes.length;i++){fsSource+=commonShaderCodes[i]+'\\n';}\n ;this.mHeaderLength=fsSource.split(/\\r\\n|\\r|\\n/).length\n ;fsSource+=shaderCode\n ;fsSource+=this.mImagePassFooter\n ;var res=this.mRenderer.CreateShader(vsSource,fsSource)\n ;if(res.mResult==false)return res.mInfo\n ;if(this.mProgram!=null)this.mRenderer.DestroyShader(this.mProgram)\n ;this.mProgram=res\n ;this.mSupportsVR=false\n ;return null;}\n\nEffectPass.prototype.NewShader_Common=function(shaderCode\n){var vsSource=((mIs20)?\"layout(location=0)in\":\"attribute\")+\" vec2 pos;void main(){gl_Position=vec4(pos.xy,0.0,1.0);}\"\n ;var fsSource=this.mHeader+shaderCode+this.mImagePassFooter\n ;var res=this.mRenderer.CreateShader(vsSource,fsSource)\n ;if(res.mResult==false)return res.mInfo\n ;if(this.mProgram!=null)this.mRenderer.DestroyShader(this.mProgram)\n ;this.mProgram=res\n ;return null;}\n\nEffectPass.prototype.NewShader=function(shaderCode,commonSourceCodes\n){if(this.mRenderer==null)return null\n ;var res=null\n       ;if(this.mType==\"sound\")res=this.NewShader_Sound(shaderCode,commonSourceCodes)\n ;else if(this.mType==\"image\")res=this.NewShader_Image(shaderCode,commonSourceCodes)\n ;else if(this.mType==\"buffer\")res=this.NewShader_Image(shaderCode,commonSourceCodes)\n ;else if(this.mType==\"common\")res=this.NewShader_Common(shaderCode)\n ;this.mSource=shaderCode\n ;return res;}\n\n\nEffectPass.prototype.DestroyInput=function(id\n){if(this.mInputs[id]==null)return\n ;if(this.mInputs[id].mInfo.mType==\"texture\"){if(this.mInputs[id].globject!=null)this.mRenderer.DestroyTexture(this.mInputs[id].globject);}\n ;if(this.mInputs[id].mInfo.mType==\"volume\"){if(this.mInputs[id].globject!=null)this.mRenderer.DestroyTexture(this.mInputs[id].globject)\n ;}else if(this.mInputs[id].mInfo.mType==\"webcam\"\n ){this.mInputs[id].video.pause()\n  ;this.mInputs[id].video.src=\"\"\n  ;var tracks=this.mInputs[id].video.stream.getVideoTracks()\n  ;if(tracks)tracks[0].stop()\n  ;this.mInputs[id].video=null\n  ;if(this.mInputs[id].globject!=null)this.mRenderer.DestroyTexture(this.mInputs[id].globject)\n ;}else if(this.mInputs[id].mInfo.mType==\"video\"\n ){this.mInputs[id].video.pause()\n  ;this.mInputs[id].video=null\n  ;if(this.mInputs[id].globject!=null)            this.mRenderer.DestroyTexture(this.mInputs[id].globject)\n ;}else if(this.mInputs[id].mInfo.mType==\"music\"||this.mInputs[id].mInfo.mType==\"musicstream\"\n ){this.mInputs[id].audio.pause()\n  ;this.mInputs[id].audio.mSound.mFreqData=null\n  ;this.mInputs[id].audio.mSound.mWaveData=null\n  ;this.mInputs[id].audio=null\n  ;if(this.mInputs[id].globject!=null)            this.mRenderer.DestroyTexture(this.mInputs[id].globject)\n ;}else if(this.mInputs[id].mInfo.mType==\"cubemap\"){if(this.mInputs[id].globject!=null)this.mRenderer.DestroyTexture(this.mInputs[id].globject)\n ;}else if(this.mInputs[id].mInfo.mType==\"keyboard\"\n ){//if(this.mInputs[id].globject!=null)//commented out in the original\n  ;// this.mRenderer.DestroyTexture(this.mInputs[id].globject)//commented out in the original\n ;}else if(this.mInputs[id].mInfo.mType==\"mic\"\n ){this.mInputs[id].mic=null\n  ;if(this.mInputs[id].globject!=null)this.mRenderer.DestroyTexture(this.mInputs[id].globject)  ;}\n ;this.mInputs[id]=null;}\n\n\nEffectPass.prototype.StopInput=function(id\n){var inp=this.mInputs[id]\n ;if(inp==null){\n ;}else if(inp.mInfo.mType==\"music\"||inp.mInfo.mType==\"musicstream\"\n ){if(inp.audio.mPaused==false){inp.audio.pause();inp.audio.mPaused=true;}return inp.audio.mPaused;}\n  ;return null;}\n\nEffectPass.prototype.ResumeInput=function(id\n){var inp=this.mInputs[id]\n ;if(inp==null){\n ;}else if(inp.mInfo.mType==\"music\"||inp.mInfo.mType==\"musicstream\"\n ){if(inp.audio.mPaused){inp.audio.play();inp.audio.mPaused=false;}return inp.audio.mPaused;}\n ;return null;}\n\nEffectPass.prototype.Paint_Image=function(vrData,wa,d,time,dtime,fps,mouseOriX,mouseOriY,mousePosX,mousePosY,x,y,buffers,keyboard\n){var dates=[d.getFullYear(),d.getMonth(),d.getDate()//YYYY,MM,DD,\n ,d.getHours()*60*60+d.getMinutes()*60+d.getSeconds()+d.getMilliseconds()/1000.0]//secondsSince0AM\n ;this.mRenderer.AttachShader(this.mProgram)\n ;this.mRenderer.ssc1F(\"iTime\",time)\n ;this.mRenderer.ssc3F(\"iResolution\",x,y,1.0)\n ;this.mRenderer.ssc4FV(\"iMouse\",[mousePosX,mousePosY,mouseOriX,mouseOriY])\n ;this.mRenderer.ssc4FV(\"iDate\",dates)//YYYY,MM,DD,sssssss.ssss\n ;this.mRenderer.ssc1F(\"iSampleRate\",this.mSampleRate)\n ;this.mRenderer.ssc1I(\"iFrame\",this.mFrame)\n ;this.mRenderer.ssc1F(\"iTimeDelta\",dtime)\n ;this.mRenderer.SetViewport([0,0,x,y])\n ;this.mRenderer.DrawFullScreenTriangle_XY(this.mRenderer.GetAttribLocation(this.mProgram,\"pos\"));}\n\nEffectPass.prototype.Paint_Sound=function(wa,d\n){var dates=[d.getFullYear(),d.getDate(),d.getHours()*60.0*60+d.getMinutes()*60+d.getSeconds()]\n ;var resos=[0,0,0,0,0,0,0,0,0,0,0,0]\n ;this.mRenderer.SetRenderTarget(this.mRenderFBO)\n ;this.mRenderer.SetViewport([0,0,this.mTextureDimensions,this.mTextureDimensions])\n ;this.mRenderer.AttachShader(this.mProgram)\n ;this.mRenderer.SetBlend(false)\n ;var texID=[null,null,null,null]\n ;for(var i=0;i<this.mInputs.length;i++\n ){var inp=this.mInputs[i]\n  ;if(inp==null){}else if(inp.mInfo.mType==\"texture\"\n  ){if(inp.loaded==true\n   ){texID[i]=inp.globject\n    ;resos[3*i+0]=inp.image.width;resos[3*i+1]=inp.image.height;resos[3*i+2]=1\n ;}}else if(inp.mInfo.mType==\"volume\"\n ){if(inp.loaded==true\n  ){texID[i]=inp.globject\n   ;resos[3*i+0]=inp.mImage.mXres\n   ;resos[3*i+1]=inp.mImage.mYres\n   ;resos[3*i+2]=inp.mImage.mZres;}}}\n ;\n ;var l2=this.mRenderer.sscLocation(this.mProgram,\"iBlockOffset\")\n ;this.mRenderer.ssc4FV(\"iDate\",dates)\n ;this.mRenderer.ssc3FV(\"iChannelResolution\",resos)\n ;this.mRenderer.ssc1F(\"iSampleRate\",this.mSampleRate)\n ;var l1=this.mRenderer.GetAttribLocation(this.mProgram,\"pos\")\n ;var numSamples=this.mTmpBufferSamples\n ;var bufL=this.mBuffer.getChannelData(0)//Float32Array\n ;var bufR=this.mBuffer.getChannelData(1)//Float32Array\n ;var numBlocks=this.mPlaySamples/numSamples\n ;for(var j=0;j<numBlocks;j++\n ){var off=j*this.mTmpBufferSamples\n  ;this.mRenderer.ssc1F_Pos(l2,off/this.mSampleRate)\n  ;this.mRenderer.DrawUnitQuad_XY(l1)\n  ;this.mRenderer.GetPixelData(this.mData,this.mTextureDimensions,this.mTextureDimensions)\n  ;for(var i=0;i<numSamples;i++\n  ){bufL[off+i]=-1.0+2.0*(this.mData[4*i+0]+256.0*this.mData[4*i+1])/65535.0\n   ;bufR[off+i]=-1.0+2.0*(this.mData[4*i+2]+256.0*this.mData[4*i+3])/65535.0;}}\n ;this.mRenderer.DetachShader()\n ;this.mRenderer.SetRenderTarget(null)\n ;//below lines are webaudio syntax,the webaudio contexts makes precise synchronization/streaming almost impossible.\n ;if(this.mPlayNode!=null){this.mPlayNode.disconnect();this.mPlayNode.stop();}\n ;this.mPlayNode=wa.createBufferSource()\n ;this.mPlayNode.buffer=this.mBuffer\n ;this.mPlayNode.connect(this.mGainNode)\n ;this.mPlayNode.state=this.mPlayNode.noteOn\n ;this.mPlayNode.start(0);}\n\nEffectPass.prototype.Paint=function(vrData,wa,da,time,dtime,fps,mouseOriX,mouseOriY\n ,mousePosX,mousePosY,x,y,isPaused,bufferID,bufferNeedsMimaps,buffers,keyboard\n){if(this.mType===\"sound\"\n ){if(this.mFrame==0&&!isPaused\n  ){this.Paint_Sound(wa,da)\n   ;this.mFrame++\n ;}}else if(this.mType===\"image\"\n ){this.mRenderer.SetRenderTarget(null)\n  ;this.Paint_Image(vrData,wa,da,time,dtime,fps,mouseOriX,mouseOriY,mousePosX,mousePosY,x,y,buffers,keyboard)\n  ;this.mFrame++\n ;}else if(this.mType===\"common\"){}else if(this.mType==\"buffer\"\n ){}}\n\nEffectPass.prototype.StopOutput_Sound=function(wa  ){if(this.mPlayNode===null)return;this.mPlayNode.disconnect();};\nEffectPass.prototype.ResumeOutput_Sound=function(wa){if(this.mPlayNode===null)return;this.mPlayNode.connect(this.mGainNode);};\nEffectPass.prototype.StopOutput_Image=function(wa){};\nEffectPass.prototype.ResumeOutput_Image=function(wa){};\nEffectPass.prototype.StopOutput=function(wa\n){for(var j=0;j<this.mInputs.length;j++)this.StopInput(j)\n ;if(this.mType==\"sound\")this.StopOutput_Sound(wa)\n ;else this.StopOutput_Image(wa);}\n\nEffectPass.prototype.ResumeOutput=function(wa\n){for(var j=0;j<this.mInputs.length;j++)this.ResumeInput(j)\n ;if(this.mType==\"sound\")         this.ResumeOutput_Sound(wa)\n ;else         this.ResumeOutput_Image(wa);}\n\nfunction Effect(vr,ac,gl,x,y,callback,obj,forceMuted,forcePaused\n){this.eCreated=false\n ;this.mRenderer=null\n ;this.mAudioContext=ac\n ;this.mContext=gl\n ;this.mRenderingStereo=false\n ;this.mXres=x\n ;this.mYres=y\n ;this.mForceMuted=forceMuted\n ;if(ac==null)this.mForceMuted=true\n ;this.mForcePaused=forcePaused\n ;this.mGainNode=null\n ;this.mPasses=[]\n ;this.mFrame=0\n ;this.mTextureCallbackFun=callback\n ;this.mTextureCallbackObj=obj\n ;this.mMaxBuffers=4\n ;this.mMaxPasses=this.mMaxBuffers+1+1//some day decouple passes from buffers\n ;this.mBuffers=[]\n ;if(gl==null)return\n ;this.mRenderer=piRenderer()\n ;if(!this.mRenderer.Initialize(gl))return\n ;var caps=this.mRenderer.GetCaps()\n ,i2=mIs20=caps.mIsGL20\n ,of=(i2?\"out\":\"gl_Frag\")+\"Color=texture\"\n ,oc=i2?\"out vec4 outColor;\":\"\"\n ,vs1=(i2?\"layout(location=0)in\":\"attribute\")+\" vec2 p;void main(){gl_Position=vec4(p.xy,0,1);}\"\n ;this.pShaderTextureLOD=caps.pShaderTextureLOD\n ;if(ac!=null\n ){this.mGainNode=ac.createGain()\n  ;if(!forceMuted){this.mGainNode.connect(ac.destination);}\n  ;if(this.mForceMuted)this.mGainNode.gain.value=0.0\n  ;else this.mGainNode.gain.value=1.0;}\n ;var res=this.mRenderer.CreateShader(vs1,\"uniform vec4 v;uniform sampler2D t;\"+oc+\"void main(){\"+of+(i2?\"Lod\":\"2D\")+\"(t,gl_FragCoord.xy/v.zw,\"+(i2?\"\":\"-10\")+\"0.0);}\")\n ;if(res.mResult==false){console.log(\"Effect().CreateShader() failed:\"+res.mInfo);return;}\n ;this.mProgramCopy=res \n ;var res=this.mRenderer.CreateShader(vs1,\"uniform vec4 v;uniform sampler2D t;\"+oc+\"void main(){vec2 uv=gl_FragCoord.xy/v.zw;\"+of+(i2?\"\":\"2D\")+\"(t,vec2(uv.x,1.-uv.y));}\")\n ;if(res.mResult==false){console.log(\"CreateShader() Failed:\"+res);return;}\n ;this.mProgramDownscale=res\n ;this.ResizeBuffers(null,null)\n ;var keyboardData=new Uint8Array(256*3)\n ;for(var j=0;j<(256*3);j++){keyboardData[j]=0;}\n ;var kayboardTexture=this.mRenderer.CreateTexture(0,256,3,this.mRenderer.TEXFMT.C1I8,0,0,null)\n ;var keyboardImage=new Image()\n ;if(callback!=null)keyboardImage.src=\"/keyboard.png\";//don't load PNG if no UI \n ;this.mKeyboard={mData:keyboardData,mTexture:kayboardTexture,mIcon:keyboardImage}\n ;this.eCreated=true;}\n\nEffect.prototype.ResizeBuffers=function(oldXres,oldYres\n){var needCopy=(oldXres!=null&&oldYres!=null)\n ;if(!needCopy    //first time!\n ){var thumnailRes=[256,128]\n  ;for(var i=0;i<this.mMaxBuffers;i++\n  ){this.mBuffers[i]={mTexture:[null,null]\n   ,mTarget: [null,null]\n   ,mLastRenderDone:0\n   ,mThumbnailRenderTarget:null//thumbnailRenderTarget\n   ,mThumbnailTexture:null//thumbnailTexture\n   ,mThumbnailBuffer: null//thumbnailBuffer\n   ,mThumbnailRes:thumnailRes};}}\n ;//Prepare for rendering\n ;if(needCopy\n ){}\n ;//Resize each double buffer\n ;for(var i=0;i<this.mMaxBuffers;i++\n ){var texture1=this.mRenderer.CreateTexture(0\n  ,this.mXres,this.mYres\n  ,this.mRenderer.TEXFMT.C4F32\n  ,(needCopy)? this.mBuffers[i].mTexture[0].mFilter:0\n  ,(needCopy)? this.mBuffers[i].mTexture[0].mWrap  :0\n  ,null)\n  ;var target1=this.mRenderer.CreateRenderTarget(texture1,null,null,null,null,false)\n  ;var texture2=this.mRenderer.CreateTexture(0\n  ,this.mXres,this.mYres\n  ,this.mRenderer.TEXFMT.C4F32\n  ,(needCopy)? this.mBuffers[i].mTexture[1].mFilter:0\n  ,(needCopy)? this.mBuffers[i].mTexture[1].mWrap  :0\n  ,null)\n  ;var target2=this.mRenderer.CreateRenderTarget(texture2,null,null,null,null,false)\n  ;if(needCopy){//Copy old buffers 1 to new buffer\n   ;this.mRenderer.SetRenderTarget(target1)\n   ;this.mRenderer.DrawUnitQuad_XY(l1)\n   ;//Copy old buffers 2 to new buffer\n   ;this.mRenderer.SetRenderTarget(target2)\n   ;this.mRenderer.DrawUnitQuad_XY(l1)\n   ;//Deallocate old memory\n   ;this.mRenderer.DestroyTexture(this.mBuffers[i].mTexture[0])\n   ;this.mRenderer.DestroyRenderTarget(this.mBuffers[i].mTarget[0])\n   ;this.mRenderer.DestroyTexture(this.mBuffers[i].mTexture[1])\n   ;this.mRenderer.DestroyRenderTarget(this.mBuffers[i].mTarget[1]);}\n  ;//Store new buffers\n  ;this.mBuffers[i].mTexture=[texture1,texture2],this.mBuffers[i].mTarget=[target1,target2],this.mBuffers[i].mLastRenderDone=0;}\n ;if(needCopy){this.mRenderer.DetachShader();this.mRenderer.SetRenderTarget(null);};}\n\nEffect.prototype.ToggleVolume=function(\n){this.mForceMuted=!this.mForceMuted\n ;//outp\n ;if(this.mForceMuted)this.mGainNode.gain.value=0.0\n ;else this.mGainNode.gain.value=1.0\n ;//inp\n ;var num=this.mPasses.length\n ;for(var j=0;j<num;j++){for(var i=0;i<this.mPasses[j].mInputs.length;i++){}}\n ;return this.mForceMuted;}\n\nEffect.prototype.SetKeyDown=function(passid,k\n){//alert(\"Effect.prototype.SetKeyDown;\"+passid+\",\"+k)\n ;this.mKeyboard.mData[k+0*256]=255\n ;this.mKeyboard.mData[k+1*256]=255\n ;this.mKeyboard.mData[k+2*256]=255-this.mKeyboard.mData[k+2*256]\n ;this.mRenderer.UpdateTexture(this.mKeyboard.mTexture,0,0,256,3,this.mKeyboard.mData)\n ;var num=this.mPasses.length\n ;for(var j=0;j<num;j++\n ){alert(\"Effect.prototype.SetKeyDown000;\"+j+\" \")\n  ;for(var i=0;i<this.mPasses[j].mInputs.length;i++\n  ){var inp=this.mPasses[j].mInputs[i]\n   ;if(inp!=null&&inp.mInfo.mType==\"keyboard\"\n   ){alert(\"Effect.prototype.SetKeyDown;\"+j+\" \"+i)//never happerns MEH!\n   if(this.mTextureCallbackFun!=null\n   )this.mTextureCallbackFun(this.mTextureCallbackObj,i,{mImage:this.mKeyboard.mIcon,mData:this.mKeyboard.mData}\n   ,false,6,1,-1.0,this.mPasses[j].mID);}}}}\n\nEffect.prototype.SetKeyUp=function(passid,k\n){this.mKeyboard.mData[k+0*256]=0\n ;this.mKeyboard.mData[k+1*256]=0\n ;this.mRenderer.UpdateTexture(this.mKeyboard.mTexture,0,0,256,3,this.mKeyboard.mData)\n ;var num=this.mPasses.length\n ;for(var j=0;j<num;j++\n ){for(var i=0;i<this.mPasses[j].mInputs.length;i++\n  ){var inp=this.mPasses[j].mInputs[i]\n   ;if(inp!=null&&inp.mInfo.mType==\"keyboard\"\n   ){if(this.mTextureCallbackFun!=null\n   )this.mTextureCallbackFun(this.mTextureCallbackObj,i,{mImage:this.mKeyboard.mIcon,mData:this.mKeyboard.mData}\n   ,false,6,1,-1.0,this.mPasses[j].mID);}}}}\n\nEffect.prototype.StopOutputs=function(\n){var wa=this.mAudioContext,num=this.mPasses.length\n ;for(var i=0;i<num;i++){this.mPasses[i].StopOutput(wa);}}\n\nEffect.prototype.ResumeOutputs=function(\n){var wa=this.mAudioContext,num=this.mPasses.length\n ;for(var i=0;i<num;i++){this.mPasses[i].ResumeOutput(wa);}}\n\nEffect.prototype.SetSize=function(x,y\n){if(x !==this.mXres||y !==this.mYres\n ){var oldXres=this.mXres\n  ;var oldYres=this.mYres\n  ;this.mXres=x\n  ;this.mYres=y\n  ;this.ResizeBuffers(oldXres,oldYres)\n  ;return true;}\n ;return false;}\n\n\nEffect.prototype.UpdateInputs=function(passid,fu\n){this.mPasses[passid].UpdateInputs(this.mAudioContext,fu,this.mKeyboard);}\n\nEffect.prototype.ResetTime=function(\n){this.mFrame=0\n ;var num=this.mPasses.length\n ;for(var i=0;i<num;i++){this.mPasses[i].mFrame=0}}\n\nEffect.prototype.RequestAnimationFrame=function(id){requestAnimFrame(id);}\n\nEffect.prototype.Paint=function(time,dtime,fps,mouseOriX,mouseOriY,mousePosX,mousePosY,isPaused\n){var wa=this.mAudioContext\n ;var da=new Date()\n ;var vrData=null\n ;var x=this.mXres/1\n ;var y=this.mYres/1\n ;var num=this.mPasses.length\n ;if(this.mFrame==0\n ){for(var i=0;i<this.mMaxBuffers;i++\n ){this.mRenderer.SetRenderTarget(this.mBuffers[i].mTarget[0])\n  ;this.mRenderer.Clear(1,[0.0,0.0,0.0,0.0],1.0,0)\n  ;this.mRenderer.SetRenderTarget(this.mBuffers[i].mTarget[1])\n  ;this.mRenderer.Clear(1,[0.0,0.0,0.0,0.0],1.0,0);}}\n ;for(var i=0;i<num;i++//render sound first\n ){if(this.mPasses[i].mType!=\"sound\")continue\n  ;if(this.mPasses[i].mProgram==null)continue\n  ;this.mPasses[i].Paint(vrData,wa,da,time,dtime,fps,mouseOriX,mouseOriY,mousePosX,mousePosY,x,y,isPaused,null\n  ,false,this.mBuffers,this.mKeyboard);}\n ;for(var i=0;i<num;i++//render buffers second\n ){if(this.mPasses[i].mType!=\"buffer\")continue\n  ;if(this.mPasses[i].mProgram==null)continue\n  ;//check if any downstream pass needs mipmaps when reading from this buffer\n  ;var needMipMaps=false\n  ;for(var j=0;j<num;j++\n  ){for(var k=0;k<this.mPasses[j].mInputs.length;k++\n   ){var inp=this.mPasses[j].mInputs[k]\n    ;if(inp!=null&&inp.mInfo.mType==\"buffer\"&&inp.id===bufferID&&inp.mInfo.mSampler.filter===\"mipmap\"){needMipMaps=true;break;}}}\n  ;this.mPasses[i].Paint(vrData,wa,da,time,dtime,fps,mouseOriX,mouseOriY,mousePosX,mousePosY,x,y,isPaused\n  ,bufferID,needMipMaps,this.mBuffers,this.mKeyboard);}\n ;for(var i=0;i<num;i++//render image last\n ){if(this.mPasses[i].mType!=\"image\")continue\n  ;if(this.mPasses[i].mProgram==null)continue\n  ;this.mPasses[i].Paint(vrData,wa,da,time,dtime,fps,mouseOriX,mouseOriY,mousePosX,mousePosY,x,y,isPaused,null,false,this.mBuffers,this.mKeyboard);}   \n ;for(var k=0;k<256;k++){this.mKeyboard.mData[k+1*256]=0;} //erase keypresses\n ;this.mRenderer.UpdateTexture(this.mKeyboard.mTexture,0,0,256,3,this.mKeyboard.mData)\n ;this.mFrame++;}\n\nEffect.prototype.NewShader=function(shaderCode,passid\n){var commonSourceCodes=[]\n ;for(var i=0;i<this.mPasses.length;i++){if(this.mPasses[i].mType==\"common\"){commonSourceCodes.push(this.mPasses[i].mSource);}}\n ;return this.mPasses[passid].NewShader(shaderCode,commonSourceCodes);}\n\nEffect.prototype.GetNumPasses=function(){return this.mPasses.length;}\n\nEffect.prototype.GetNumOfType=function(passtype\n){var id=0;for(var j=0;j<this.mPasses.length;j++){if(this.mPasses[j].mType===passtype){id++;}}return id;}\n\nEffect.prototype.GetPassType=function(id){return this.mPasses[id].mType;}\nEffect.prototype.GetPassName=function(id){return this.mPasses[id].mName;}\n\nEffect.prototype.newPass=function(jobj\n){var numPasses=jobj.renderpass.length\n ;//alert(\"Effect.prototype.newPass  jobj.renderpass.length=\"+jobj.renderpass.length)\n ;if(numPasses<1||numPasses>this.mMaxPasses\n ){return{mFailed:true,mError:\"Incorrect number of passes,wrong shader format\",mShader:null};}\n ;var res=[]\n ;res.mFailed=false\n ;for(var j=0;j<numPasses;j++\n ){var rpass=jobj.renderpass[j]\n  ;this.mPasses[j]=new EffectPass(this.mRenderer,mIs20,this.pShaderTextureLOD\n  ,this.mTextureCallbackFun,this.mTextureCallbackObj,this.mForceMuted,this.mForcePaused,this.mGainNode\n  ,this.mProgramDownscale,j)\n  ;//skip sound passes if in thumbnail mode\n  ;if(this.mForceMuted&&rpass.type==\"sound\")continue\n  ;var numInputs=rpass.inputs.length\n  ;for(var i=0;i<numInputs;i++){}\n  ;for(var i=0;i<4;i++){}\n  ;var numOutputs=rpass.outputs.length\n  ;for(var i=0;i<numOutputs;i++){}\n  ;//create some hardcoded names. This should come from the DB\n  ;var rpassName=\"\"\n  ;if(rpass.type==\"common\")rpassName=\"Common\"\n  ;if(rpass.type==\"sound\")rpassName=\"Sound\"\n  ;this.mPasses[j].Create(rpass.type,rpassName,this.mAudioContext);}\n ;for(var pt=0;pt<4;pt++\n ){for(var j=0;j<numPasses;j++\n  ){var rpass=jobj.renderpass[j]\n   ;if(pt==0&&rpass.type!=\"common\")continue\n   ;if(pt==3&&rpass.type!=\"sound\")continue\n   ;if(this.mForceMuted&&rpass.type==\"sound\")continue\n   ;var shaderStr=rpass.code\n   ;var result=this.NewShader(shaderStr,j)\n   ;if(result!=null){res.mFailed=true;res[j]={mFailed:true,mError:result,mShader:shaderStr}\n   ;}else {res[j]={mFailed:false,mError:null,mShader:shaderStr};}}}\n ;return res;}\n\nEffect.prototype.DestroyPass=function(id){this.mPasses[id].Destroy(this.mAudioContext);this.mPasses.splice(id,1);}\n\nEffect.prototype.addep=function(passType,passName\n){var shaderStr=null\n ;if(passType==\"sound\")shaderStr=gei('s') //\"vec2 mainSound( in int samp,float time){return vec2(sin(6.2831*\\n440.0*time)*exp(-3.0*time));}\"\n ;if(passType==\"buffer\")shaderStr=gei('a') //\"void mainImage(out vec4 fragColor,in vec2 fragCoord)\\n{\\n    fragColor=vec4(0.0,0.0,1.0,1.0);\\n}\"\n ;if(passType==\"common\")shaderStr=gei('o')//\"vec4 someFunction(vec4 a,float b)\\n{\\n    return a+b;\\n}\"\n ;var id=this.GetNumPasses()\n ;this.mPasses[id]=new EffectPass(this.mRenderer,mIs20,this.pShaderTextureLOD\n ,this.mTextureCallbackFun,this.mTextureCallbackObj,this.mForceMuted,this.mForcePaused,this.mGainNode,this.mProgramDownscale,id)\n ;this.mPasses[id].Create(passType,passName,this.mAudioContext)\n ;var res=this.NewShader(shaderStr,id)\n ;return{mId:id,mShader:shaderStr,mError:res};}\n\nfunction ShaderToy(\n){var me=this\n ;me.mContext=null\n ;me.mTo=null\n ;me.mCanvas=null\n ;me.mFPS=piCreateFPSCounter()\n ;me.mInfo=null\n ;me.mPass=[]\n ;var devicePixelRatio=window.devicePixelRatio||1\n ;me.mCanvas=document.getElementById(\"demogl\")\n ;me.mCanvas.tabIndex=\"0\"//make it react to keyboard\n ;me.mCanvas.width=me.mCanvas.offsetWidth//* devicePixelRatio\n ;me.mCanvas.height=me.mCanvas.offsetHeight//* devicePixelRatio\n ;me.mHttpReq=new XMLHttpRequest()\n ;me.mTo=getRealTime()\n ;mTf=0\n ;me.mFPS.Reset(me.mTo)\n ;me.mMouseIsDown=false\n ;me.mMouseOriX=0\n ;me.mMouseOriY=0\n ;me.mMousePosX=0\n ;me.mMousePosY=0\n ;me.mContext=piCreateGlContext(me.mCanvas,false,false,true,false)//need preserve-buffe to true in order to capture screenshots\n ;mAudioContext=piCreateAudioContext()\n ;window.onfocus=function(){if(!paused){mTOffset=me.mTf;me.mTo=getRealTime();me.mRestarted=true;}}\n ;var refreshCharsAndFlags=function(){setTimeout(refreshCharsAndFlags,1500);}\n ;me.mEditorState={mCursorChange:false,mViewportChange:false,mCodeChange:false}\n ;me.mErrors=new Array()\n ;\n ;me.mCanvas.onmousedown=function(ev\n ){var rect=me.mCanvas.getBoundingClientRect()\n  ;me.mMouseOriX=Math.floor((ev.clientX-rect.left)/(rect.right-rect.left)*me.mCanvas.width)\n  ;me.mMouseOriY=Math.floor(me.mCanvas.height-(ev.clientY-rect.top)/(rect.bottom-rect.top)*me.mCanvas.height)\n  ;me.mMousePosX=me.mMouseOriX\n  ;me.mMousePosY=me.mMouseOriY\n  ;me.mMouseIsDown=true;}\n ;\n ;me.mCanvas.onmousemove=function(ev\n ){if(me.mMouseIsDown\n  ){var rect=me.mCanvas.getBoundingClientRect()\n   ;me.mMousePosX=Math.floor((ev.clientX-rect.left)/(rect.right-rect.left)*me.mCanvas.width)\n   ;me.mMousePosY=Math.floor(me.mCanvas.height-(ev.clientY-rect.top)/(rect.bottom-rect.top)*me.mCanvas.height);}}\n ;\n ;me.mCanvas.onmouseup=function(ev\n ){me.mMouseIsDown=false\n  ;me.mMouseOriX=-Math.abs(me.mMouseOriX)\n  ;me.mMouseOriY=-Math.abs(me.mMouseOriY);}\n ;\n ;document.getElementById(\"myResetButton\").onclick=function(ev){me.resetTime(true);}\n ;document.getElementById(\"myPauseButton\").onclick=function(ev){me.pauseTime(true);}\n ;document.getElementById(\"myVolume\").onclick=function(ev ){var res=mEffect.ToggleVolume();}\n ;var mFullScreenExitHandler=function(){}\n ;me.mCanvas.addEventListener('webkitfullscreenchange',mFullScreenExitHandler,false)\n ;me.mCanvas.addEventListener('mozfullscreenchange',mFullScreenExitHandler,false)\n ;me.mCanvas.addEventListener('fullscreenchange',mFullScreenExitHandler,false)\n ;me.mCanvas.addEventListener('MSFullscreenChange',mFullScreenExitHandler,false)\n ;document.getElementById(\"myFullScreen\").onclick=function(ev){piRequestFullScreen(me.mCanvas);me.mCanvas.focus();}\n ;mEffect=new Effect(null,mAudioContext,me.mContext,me.mCanvas.width,me.mCanvas.height,me.RefreshTexturThumbail,this,false,false)\n ;if(!mEffect.eCreated){paused=true;return;}\n ;me.mCanvas.addEventListener(\"webglcontextlost\",function(event\n ){event.preventDefault();paused=true;alert('WebGL implementation crashed');},false);\n ;this.mMediaRecorder=null\n ;document.getElementById(\"myRecord\").onclick=function(ev\n ){if(me.mMediaRecorder==null\n  ){me.mMediaRecorder=piCreateMediaRecorder(function(b\n   ){var ele=document.getElementById(\"myRecord\")\n    ;if(b){}else{}//currently recording or not\n   ;},me.mCanvas);}\n  ;if(me.mMediaRecorder==null\n  ){let ele=document.getElementById(\"myRecord\")\n   ;ele.style.background=\"url('/img/themes/classic/recordDisabled.png')\"\n   ;alert('MediaRecord API is not supported in this browser')\n   ;return;}\n  ;if(me.mMediaRecorder.state==\"inactive\"){me.mMediaRecorder.start()\n  ;}else{me.mMediaRecorder.stop();}}\n ;}\n\n\n//all below this line is pretty much minified\n\nShaderToy.prototype.startRendering=function(\n){var me=this\n ;function renderLoop2(\n ){if(me.mContext==null)return\n  ;mEffect.RequestAnimationFrame(renderLoop2)\n  ;if(paused){mEffect.UpdateInputs(me.mActiveDoc,false);return;}\n  ;var time=getRealTime()\n  ;var ltime=0.0\n  ;var dtime=0.0\n  ;if(paused){ltime=me.mTf;dtime=1000.0/60.0\n  ;}else \n   {ltime=mTOffset+time-me.mTo\n   ;if(me.mRestarted)dtime=1000.0/60.0\n   ;else dtime=ltime-me.mTf\n   ;me.mTf=ltime;}\n  ;me.mRestarted=false\n  ;var newFPS=me.mFPS.Count(time)\n  ;mEffect.Paint(ltime/1000.0,dtime/1000.0,me.mFPS.GetFPS(),me.mMouseOriX,me.mMouseOriY,me.mMousePosX,me.mMousePosY,paused)\n  ;document.getElementById(\"myTime\").textContent=(ltime/1000.0).toFixed(2)+\"/\"+90*sRs[0]/sRs[sR]+\".00\"\n  ;if(paused){\n  ;}else{if(newFPS\n    ){document.getElementById(\"myFramerate\").textContent=\" fps:\"+me.mFPS.GetFPS().toFixed(1)+\" \"+wMs[wM];}}}\n ;renderLoop2();}\n\nfunction resize(\n){var s=document.getElementById(\"demogl\");if(s){//is a bit overly excessive.\n ;s.setAttribute(\"width\",s.offsetWidth)\n ;s.setAttribute(\"height\",s.offsetHeight)\n ;s.width=s.offsetWidth;s.height=s.offsetHeight\n ;mEffect.SetSize(s.offsetWidth,s.offsetHeight);}}\n\nShaderToy.prototype.pauseTime=function(doFocusCanvas\n){if(!paused\n ){paused=true;mEffect.StopOutputs()\n ;}else\n  {mTOffset=mTf\n  ;this.mTo=getRealTime()\n  ;paused=false\n  ;mRestarted=true\n  ;mEffect.ResumeOutputs()\n  ;if(doFocusCanvas)this.mCanvas.focus();}}\n\nShaderToy.prototype.resetTime=function(doFocusOnCanvas\n){mTOffset=0\n ;this.mTo=getRealTime()\n ;mTf=0\n ;mRestarted=true\n ;this.mFpsTo=this.mTo\n ;this.mFpsFrame=0\n ;mEffect.ResetTime()\n ;if(doFocusOnCanvas)this.mCanvas.focus();}//put mouse/keyboard focus on canvas\n\n\nfunction watchInit(\n){gShaderToy=new ShaderToy()\n ;var kk={\"renderpass\":\n\t\t      [{\"inputs\":[],\"outputs\":[{\"channel\":0,\"id\":37      }],\"type\":\"image\" ,\"code\":gei('i')}\n\t\t    \t,{\"inputs\":[],\"outputs\":[{\"channel\":0,\"id\":\"none\"  }],\"type\":\"common\",\"code\":gei('o')}\n          ]}\n ;gShaderToy.pauseTime();\n ;gRes=mEffect.newPass(kk) \n ;gShaderToy.pauseTime();\n ;gShaderToy.startRendering()\n ;if(mEffect.GetNumOfType(\"sound\")<1){\n  ;var res=mEffect.addep(\"sound\",\"Sound\")\n  ;gShaderToy.mPass[res.mId]={mDocs:CodeMirror.Doc(res.mShader,\"text/x-glsl\")}\n  ;}\n ;gShaderToy.pauseTime();\n ;} \n\n</script>\n\n</head><body onload=\"watchInit();\" onresize=\"resize()\" class=\"n\">\n\n<table class=\"n\"><tbody class=\"n\"><tr><td>\n <div id=\"passManager\"></div>\n  <span id=\"myTime\">0.00</span><br>\n  <span id=\"myFramerate\">0.5 fps</span><br>\n  <button id=\"myResetButton\">reset</button><br>\n  <button id=\"myPauseButton\">pause</button><br>\n  <button id=\"myVolume\">volume</button><br>\n  <button id=\"myFullScreen\" >fullscreen</button><br>\n  <button id=\"myRecord\">record</button><br>\n  <button id=\"myVR\">vr</button><br>\n  <button  onclick=\"showHelp()\">shade</div><br>\n  </td><td>\n  <canvas id=\"demogl\" class=\"n\" tabindex=\"0\"></canvas>\n</div>\n\n    </td></tr></tbody></table>\n\n\n\n</body></html>\n\n\n\n//remove this line from the html document and the very first line of it /**/",
                "description": "",
                "inputs": [],
                "name": "Common",
                "outputs": [],
                "type": "common"
            }
        ],
        "ver": "0.1"
    }
}