{
    "Shader": {
        "info": {
            "date": "1470704821",
            "description": "cone tracing lighting diffuse/soft reflections, not really optimal at all.\ni was too lazy but a denoising pass does wonders.",
            "flags": 96,
            "hasliked": 0,
            "id": "lddGRj",
            "likes": 15,
            "name": "Cone tracing lighting",
            "published": 3,
            "tags": [
                "lighting",
                "cone",
                "tracing"
            ],
            "usePreview": 0,
            "username": "public_int_i",
            "viewed": 1226
        },
        "renderpass": [
            {
                "code": "//Ethan Alexander Shulman 2016\n\n\n\n#define CONE_PATHS 1\n\n\n    \n#define EPSILON .01\n\n#define nObjects 2\nfloat objectDistances[nObjects];\n\nstruct material {\n    vec3 diffuse,specular,emissive;\n    float roughness,metallic;\n};\n\nvec2 rot(vec2 p, float ang) {\n    return p*mat2(sin(ang),cos(ang),-cos(ang),sin(ang));\n}\n\nfloat df(vec3 p) {\n    objectDistances[0] = min(length(max(abs(abs(p)-6.)-vec3(1.,10.,1.), 0.)),\n        \t\t\t\t\tlength(p-vec3(0.,8.,0.))-2.);\n    \n    vec3 d = abs(p) - vec3(20.,10.,20.);\n    objectDistances[1] = abs(min(max(d.x,max(d.y,d.z)),0.0) +\n         length(max(d,0.0)));\n    \n    return min(objectDistances[0], objectDistances[1]);\n}\n\nvec3 normal(vec3 p) {\n    vec2 NE = vec2(EPSILON, 0.);\n    return normalize(vec3( df(p+NE.xyy)-df(p-NE.xyy),\n                           df(p+NE.yxy)-df(p-NE.yxy),\n                           df(p+NE.yyx)-df(p-NE.yyx) ));\n}\n\nmaterial mat(vec3 p) {\n   \tbool isph = length(p-vec3(0.,8.,0.)) < 2.01;\n    if (objectDistances[0] < objectDistances[1] && ! isph) {\n        //pillars\n        return material(vec3(.8), vec3(.8), vec3(0.), 0.8, 0.);\n    } else {\n        if (abs(p.y)/10. > max(abs(p.x),abs(p.z))/20. && !isph) {\n            //floor and ceiling\n        \treturn material(vec3(0.93,.93,0.92), vec3(0.), vec3(0.), .2, 0.);\n        } else {\n            if (abs(p.x) > abs(p.z) || isph) {\n                //emissive music visualizer wall + sphere\n                vec3 ts = pow(texture(iChannel0, p.zy*vec2(.025,.05)+.5).xyz, vec3(2.2*1.6));\n        \t\treturn material(vec3(0.0), vec3(0.0), ts*1., 0., 0.);\n            } else {\n                //walls\n        \t\treturn material(vec3(.84,.83,.84), vec3(0.8), vec3(0.0), .6, 0.);\n            }\n        }\n    }\n}\n\n\nfloat rand(vec3 s) {\n    \n    //Thanks to Shane for the improved random function\n    return fract(cos(dot(s, vec3(7, 157, 113)))*43758.5453);\n\n    /* old\n    return fract( (fract(s.x*32.924)*8. + fract(s.x*296.234) +\n                 fract(s.y*32.924)*8. + fract(s.y*296.234) +\n                 fract(s.z*32.924)*8. + fract(s.z*296.234))*98.397 );*/\n}\nvec3 randDir(vec3 s) {\n    return vec3(sin(rand(s.yzx+.89234)*34.24),\n                cos(rand(s.zxy-1.445)*34.24),\n                -cos(rand(s)*34.35));\n}\n\n\nvec3 ilTrace(vec3 rp, vec3 rd, float rough, float seed) {\n     \n    float blur = rough;\n    float coneSize = 16.*blur,//10.*(blur*.8+.2),\n        \t\tconeRand = .5*blur,\n        \t\taddMult = .1,\n        \t\talphaMult = .5;//.25+(1.-blur)*.5;\n    \n    \n    vec4 c = vec4(0.);//color sum, w is alpha/opacity\n    vec3 lp = rd;\n    float s = 0.,ld = 0.;\n    for (int i = 0; i < 128; i++) {\n        vec3 p = rp+normalize(rd+randDir(lp+vec3(seed,seed*1.1294,seed*.1294))*coneRand)*s;\n        float d = df(p);\n        \n        float alpha = max(0., 1.-abs(d)/min(s*.2,coneSize))*addMult;\n        c += vec4(mat(p).emissive*alpha,alpha*alphaMult);\n        \n        if (c.w > 1.) break;\n        \n        s += d*(.1+rand(p+vec3(seed,seed*1.1294,seed*.1294))*.4);\n    \tlp = p;\n        ld = d;\n    }\n    \n    return c.xyz*c.w*.5;\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n\tvec2 R = iResolution.xy,\n        uv = (fragCoord.xy * 2. - R)/R.y;\n    \n    vec3 rp = vec3(sin(iTime*.1)*15., 4., cos(iTime*.1)*15.);\n    vec3 rd = normalize(vec3(uv,-1.));\n    rd.y = -rd.y;\n    rd.yz = rot(rd.yz,1.8);\n    rd.zx = rot(rd.zx,iTime*.1+1.3);\n    \n    float s = 0.;\n    for (int i = 0; i < 77; i++) {\n        float d = df(rp+rd*s);\n        if (d < EPSILON) break;\n        s += d;\n    }\n    \n    vec3 hp = rp+rd*s;\n    if (df(hp) >= EPSILON) {\n        fragColor = vec4(0.);\n        return;\n    }\n    \n    vec3 n = normal(hp);\n    material m = mat(hp);\n    \n    vec3 c = m.emissive;\n    \n    vec3 il = vec3(0.);\n    //cone paths\n    for (int i = 0; i < CONE_PATHS; i++) {\n        il += ilTrace(hp+n*.1, mix(reflect(rd,n),n,max(0.0,m.roughness-0.5)*2.0), m.roughness*.95+0.05, float(i));\n    }\n    c += m.diffuse*il/float(CONE_PATHS);\n    \n    \n    fragColor = vec4(pow(c,vec3(1.0/2.2)), 1.);\n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 257,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer00.png"
                    }
                ],
                "name": "Image",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 37
                    }
                ],
                "type": "image"
            },
            {
                "code": "//Ethan Alexander Shulman 2016\n\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    \n    vec2 tuv = fragCoord/iResolution.xy,\n        uv = tuv - .5,\n        muv = uv;\n    \n    for (int i = 0; i < 7; i++) {\n        float t = float(i)+iTime*(1.+float(i))*.1;\n        muv = abs(muv)*mat2(sin(t),cos(t),-cos(t),sin(t));\n    \tmuv = abs(muv)-(float(i)*.1);\n    }\n    \n    \n    float sx = mod(abs(atan(muv.y,muv.x))/9.-iTime*.04, .5);\n    float freq = max( texture(iChannel1, vec2(sx,0.)).x,\n                     texture(iChannel1, vec2(sx,.25)).x );\n    freq *= 1.+sx*2.;\n    \n    float line = (length(max(abs(uv), 0.))-freq*.3)*10.;\n    line = max(0., line-max(0.,line-1.)*2.);\n\tline *= line;\n    \n    vec3 c = texture(iChannel3, floor(abs(muv*14.)-iTime)/64.).xyz*\n                 texture(iChannel3, floor(abs(muv*14.+freq)-iTime)/64.).x;\n    \n    c = c+c*line+line;\n    \n    fragColor = vec4(texture(iChannel0,uv*(.98+freq*.05+cos(iTime*.324+freq*7.342)*.005*freq)+.5).x*.9,\n                     texture(iChannel0,uv*(.98+freq*.05+cos(iTime+.294+freq*12.342)*.005*freq)+.5).y*.9,\n                     texture(iChannel0,uv*(.98+freq*.05+cos(iTime*.794+.593+freq*3.1324)*.005*freq)+.5).z*.9,\n                     1.)+\n        \t\tvec4(c, 1.)*.1;\n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 3,
                        "ctype": "texture",
                        "id": 16,
                        "published": 1,
                        "sampler": {
                            "filter": "mipmap",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "repeat"
                        },
                        "src": "/media/a/3083c722c0c738cad0f468383167a0d246f91af2bfa373e9c5c094fb8c8413e0.png"
                    },
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 257,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer00.png"
                    },
                    {
                        "channel": 1,
                        "ctype": "musicstream",
                        "id": 4514,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "https://soundcloud.com/maggs-2/bassnectar-magical-world-feat"
                    }
                ],
                "name": "Buf A",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 257
                    }
                ],
                "type": "buffer"
            }
        ],
        "ver": "0.1"
    }
}