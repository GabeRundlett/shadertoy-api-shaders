{
    "Shader": {
        "info": {
            "date": "1525368549",
            "description": "Nothing special, but I have to write some description.",
            "flags": 32,
            "hasliked": 0,
            "id": "Xd3fR7",
            "likes": 122,
            "name": "Terrian",
            "published": 3,
            "tags": [
                "fbm",
                "cloud",
                "water",
                "terrian"
            ],
            "usePreview": 1,
            "username": "EvilRyu",
            "viewed": 5955
        },
        "renderpass": [
            {
                "code": "// Created by evilryu\n// License Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.\n\n// A practice of terrian\n// Inspired by:\n// iq's Rainforest: https://www.shadertoy.com/view/4ttSWf\n// Shane's Dry Rocky Gorge: https://www.shadertoy.com/view/lslfRN\n\n\nvoid mainImage(out vec4 fragColor, in vec2 fragCoord)\n{\n    vec2 p = fragCoord/iResolution.xy;\n\n    vec3 col=texture(iChannel0, p ).xyz;    \n    col*=0.5 + 0.5*pow( 16.0*p.x*p.y*(1.0-p.x)*(1.0-p.y), 0.05 );\n         \n    fragColor = vec4( col, 1.0 );\n}\n",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 257,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer00.png"
                    }
                ],
                "name": "Image",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 37
                    }
                ],
                "type": "image"
            },
            {
                "code": "// Created by evilryu\n// License Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.\n\n// Just another practice of terrian\n// Inspired by:\n// iq's Rainforest: https://www.shadertoy.com/view/4ttSWf\n// Shane's Dry Rocky Gorge: https://www.shadertoy.com/view/lslfRN\n\n#define PI 3.14159265\n//#define AA\n\nvec2 hash2(vec2 p) \n{\n    const vec2 k = vec2(0.3183099, 0.3678794);\n    p = p*k + k.yx;\n    return fract( 16.0 * k*fract( p.x*p.y*(p.x+p.y)) );\n}\n\nvec2 hash2(float n) \n{ \n    return fract(sin(vec2(n,n+1.0))*vec2(43758.5453123,22578.1459123)); \n}\n\nfloat hash1(vec2 p)\n{\n    p  = 50.0*fract( p*0.3183099 );\n    return fract( p.x*p.y*(p.x+p.y) );\n}\n\nfloat noise(vec2 x)\n{\n    vec2 p = floor(x);\n    vec2 w = fract(x);\n    vec2 u = w*w*w*(w*(w*6.0-15.0)+10.0);\n    \n    float a = hash1(p+vec2(0,0));\n    float b = hash1(p+vec2(1,0));\n    float c = hash1(p+vec2(0,1));\n    float d = hash1(p+vec2(1,1));\n    \n    return -1.0+2.0*(a + (b-a)*u.x + (c-a)*u.y + (a - b - c + d)*u.x*u.y);\n}\n\nconst mat2 m2 = mat2(  0.80,  0.60,\n                      -0.60,  0.80 );\n\nfloat cloud(vec2 x)\n{\n    float f = 2.;\n    float s = 0.5;\n    float a = 0.0;\n    float b = 0.5;\n    for(int i=0; i<3+min(0,iFrame); i++)\n    {\n        float n = noise(x);\n        a += b*n;\n        b *= s;\n        x = f*m2*x;\n    }\n\treturn a;\n}\n\nfloat terrian(vec2 p)\n{    \n    p*=0.0045;\n    float f = 2.;\n    float s = 0.5;\n    float a = 0.0;\n    float b = 0.5;\n    for(int i=0; i<9+min(0,iFrame); i++)\n    {\n        float n = noise(p);\n        a += b*n;\n        b *= s;\n        p = f*m2*p;\n    }\n\t\n    a=smoothstep(-0.5,0.7,a);\n    \n    return a*300.;\n}\n\n\nvec3 terrian_normal(vec2 pos, float t)\n{   \n    vec2 e = vec2(0.001*t,0.0);\n\treturn normalize(vec3(terrian(pos-e.xy)-terrian(pos+e.xy),\n                           2.0*e.x,\n                           terrian(pos-e.yx)-terrian(pos+e.yx)));\n}\n\n// log-bisection tracing from Nimitz: https://www.shadertoy.com/view/4sSXz\nfloat march_terrian(vec3 ro, vec3 rd, float tmin, float tmax)\n{\n    float t = tmin;\n    vec3 p=ro+t*rd;\n    float d=p.y-terrian(p.xz);\n\n    float sgn=sign(d);\n    float told=t;\n    bool bisect=false;\n        \n    for (int i=0;i<256+min(0,iFrame);i++)\n    {\n        if(abs(d)<0.002*t || t>tmax) break;            \n       \tif(sign(d)!=sgn)\n        {\n            bisect=true;\n            break;\n        }\n        \n        told=t;\n        if(d>1.)t+=d*0.4;\n        else t+=log(abs(d)+1.1)*1.;\n        p=ro+t*rd;\n       \td=p.y-terrian(p.xz);\n    }\n    \n    if(bisect)\n    {\n        float m = 0.;\n        p=ro+told*rd;\n        sgn=sign(p.y-terrian(p.xz));\n        for(int i=0; i<6; i++)\n        { \n            m=(told+t)*.5;\n            p=ro+rd*m;\n            d=p.y-terrian(p.xz);\n            if(abs(d)<0.002*t)break;\n            d*sgn<0. ? t=m : told=m;\n        }\n        t=(told+t)*.5;\n    }\n    return t;\n}\n\n\nfloat water(vec2 p)\n{\n    p*=0.05;\n\tfloat f = 2.;\n    float s = 0.4;\n    float a = 0.0;\n    float b = 0.5;\n    for(int i=0; i<5+min(0,iFrame); i++)\n    {\n        float n = noise(vec2(p.x+10.,p.y-iTime*2.));\n        a += b*n;\n        b *= s;\n        p = f*m2*p;\n    }\n\treturn 3.*a;\n}\n\nvec3 water_normal(vec2 pos, float t) \n{\n\tvec2 e=vec2(1e-7*t*t*t,0.0);\n    return normalize(vec3(water(pos-e.xy)-water(pos+e.xy),\n                          2.0*e.x,\n                          water(pos-e.yx)-water(pos+e.yx)));\n}\n\nfloat intersect_water(vec3 ro, vec3 rd)\n{\n    float t=2000.;\n    if(rd.y <-0.01)\n    {\n      \tfloat t0=-(ro.y-20.)/rd.y;\n      \tt=min(t,t0);\n    }\n    return t;\n}\n\n\nvec4 texcube(sampler2D sam, vec3 p, vec3 n)\n{\n    vec4 p1=texture(sam, p.xy);\n    vec4 p2=texture(sam, p.xz);\n    vec4 p3=texture(sam, p.yz);\n    return p1*abs(n.z)+p2*abs(n.y)+p3*abs(n.x);\n}\n\nfloat bump(vec3 p, vec3 n)\n{\n    return dot(texcube(iChannel1, 0.25*p, n).xyz, vec3(0.299, 0.587, 0.114)); \n}\n\nvec3 bump_mapping(vec3 p, vec3 n, float weight)\n{\n    vec2 e = vec2(2./iResolution.y, 0); \n    vec3 g=vec3(bump(p-e.xyy, n)-bump(p+e.xyy, n),\n                bump(p-e.yxy, n)-bump(p+e.yxy, n),\n                bump(p-e.yyx, n)-bump(p+e.yyx, n))/(e.x*2.);  \n    g=(g-n*dot(g,n));\n    return normalize(n+g*weight);\n}\n\nfloat terrian_shadow(vec3 ro, vec3 rd, vec2 fragCoord)\n{\n    float res=1.0;\n    float t=.5+0.5*hash1(fragCoord);\n\n    float h;    \n    for(int i=0;i<20+min(0,iFrame);i++)\n    {\n        vec3 p=ro+t*rd;\n        h=p.y-terrian(p.xz);\n        res=min(16.0*h/t, res);\n        t+=clamp(h,1.+.1*t,30.);\n        if(res<0.001*t)\n            break;\n    }\n    return clamp(res, 0., 1.);\n}     \n\n\nvec3 sun_dir=normalize(vec3(-1., 1.5,-.6));\nvec3 sun_col=2.*vec3(1.);\n\nvec3 terrian_material(vec3 pos, vec3 n)\n{\n    float tree_pdf=smoothstep(0.,.5,n.y);\n    tree_pdf*=1.-smoothstep(20.,50.,pos.y);\n    vec3 mate=pow(texcube(iChannel1, pos*0.008, n).xyz,vec3(3.));\n    mate=mix(mate, .05*vec3(.7, 1., .2), tree_pdf);\n    tree_pdf=smoothstep(0.2,.3,n.y)*smoothstep(50.,200.,pos.y);\n    mate=mix(mate, .08*vec3(.5, 1., .2), tree_pdf);\n\treturn mate;\n}\n\nvec3 render_terrian(vec3 ro, vec3 rd, float t, vec2 fragCoord)\n{\n    vec3 pos=ro+t*rd;\n    vec3 n=terrian_normal(pos.xz, t);\n\n    vec3 sky=vec3(0.2,0.7,1.);\n    \n    vec3 mate=terrian_material(pos, n);\n    n=bump_mapping(pos*.1,n,0.15);\n    float sha=terrian_shadow(pos+.5*n, sun_dir, fragCoord);\n    float dif=max(0.,dot(n,sun_dir));\n    float bac=max(0.,dot(n,-sun_dir));\n    float amb=max(0.,dot(n,vec3(0,1,0)));\n    vec3 Lo=6.0*dif*sun_col*sha;\n    Lo+=0.5*bac*sun_col;\n    Lo+=3.5*amb*sky;\n   \tLo*=smoothstep(-1.,10.,pos.y);\n    return Lo*mate*0.2;        \n}\n\n\nvec3 render_water(vec3 ro, vec3 rd, float t, float t1, vec2 fragCoord, vec3 sky)\n{\n    vec3 pos=ro+t*rd;\n    vec3 n=water_normal(pos.xz, t);\n\n    vec3 mate=vec3(.8,.9,1.)*0.5;\n\n    float sha=terrian_shadow(pos+.1*n, sun_dir, fragCoord);\n    float dif=max(0.,dot(n,sun_dir));\n    float amb=max(0.,dot(n,vec3(0,1,0)));\n    float fre=clamp(1.0+dot(rd,n), .0, 1.); \n    vec3 refl=reflect(rd,n);\n    vec3 refr=refract(rd,n,1./1.33);\n    float spe=max(0.0, pow(clamp(dot(sun_dir, refl), 0.0, 1.0), 5.0));\n\n    vec3 Lo=4.0*dif*sun_col*sha;\n    Lo+=1.*amb*sky;\n    Lo+=2.5*pow(fre,8.)*vec3(1.);\n    Lo+=2.5*spe*vec3(1.);\n\tvec3 col=Lo*mate*0.2;\n    \n    float t_terrian=march_terrian(pos+1.*n, refl, 0.5, 500.);\n    vec3 reflcol=sky*.5;\n    \n    float falloff=0.;\n    \n    if(t_terrian<500.) \n    {\n        falloff=1.-smoothstep(0.5,500.,t_terrian);\n        reflcol=.4*falloff*falloff*render_terrian(pos+1.*n, refl, t_terrian, fragCoord);\n    }\n\n    vec3 refrcol=render_terrian(ro, rd, t1, fragCoord);\n    \n    falloff=1.-smoothstep(0.5,500.,t1-t);\n    col=mix(col,refrcol,falloff*falloff);\n      \n    col=mix(col, reflcol, fre);   \n    return col;\n}\n\n// sky from iq's rainforest  https://www.shadertoy.com/view/4ttSWf\nvec3 render_sky(vec3 ro, vec3 rd)\n{\n    // darker on top of the head\n    vec3 col=0.9*vec3(0.4,0.65,1.0)-rd.y*vec3(0.4,0.36,0.4);\n\n    float t=(1000.0-ro.y)/rd.y;\n    if(t>0.0)\n    {\n        vec2 uv=(ro+t*rd).xz-vec2(4710.,235.);\n        float cl=cloud(uv*0.0015);\n        float dl=smoothstep(-0.2,0.6,cl);\n        col=mix(col, vec3(1.0), 0.6*dl);\n    }\n    \n\t// sun glare    \n    float sun=clamp(dot(sun_dir,rd), 0.0, 1.0);\n    col+=0.6*vec3(1.0,0.6,0.3)*pow(sun, 32.0);\n    \n\treturn col;\n}\n\nvec3 scene(vec3 ro, vec3 rd, vec2 fragCoord, out float t)\n{\n    vec3 bg=vec3(.6,.8,1.1);\n    vec3 col=render_sky(ro, rd);\n    float t0=intersect_water(ro,rd);\n    float t1=march_terrian(ro, rd, 50., 2000.);\n    t=min(t0,t1);\n    \n  \tif(t>=2000.) return col;\n        \n    if(t1<t0)\n    {\n        col=render_terrian(ro, rd, t1, fragCoord);  \n    }\n    else\n    {\n        col=render_water(ro, rd, t0, t1, fragCoord, col);\n    }\n    \n    float sun=clamp(dot(sun_dir,rd), 0.0, 1.0);\n    col+=0.25*vec3(1.0,0.4,0.2)*pow(sun, 4.0);\n    col=mix(col,bg, 1.0-exp(-1.5e-7*t*t) );\n    \n    return col;\n}\n\n\nvec3 tonemap(vec3 x) \n{\n    const float a = 2.51;\n    const float b = 0.03;\n    const float c = 2.43;\n    const float d = 0.59;\n    const float e = 0.14;\n    return (x * (a * x + b)) / (x * (c * x + d) + e);\n}\n\nmat3 camera(vec3 ro, vec3 ta)\n{\n    vec3 f=normalize(ta-ro);\n    vec3 r=normalize(cross(f,vec3(0,1,0)));\n    vec3 u=normalize(cross(r,f));\n    return mat3(r,u,f);\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 q=fragCoord.xy/iResolution.xy;\n    vec2 p=q*2.-1.;\n    p.x*=iResolution.x/iResolution.y;\n    vec3 ro=vec3(0.,100.,-iTime*100.);\n    vec3 ta=ro+vec3(0,-0.1,-1.);\n        \n   \tmat3 cam=camera(ro, ta); \n    vec3 rd=normalize(cam*vec3(p.xy,PI/2.));\n    vec3 col=vec3(0.6,0.8,1.1);\n\n    float t=0.;\n    \n    col=scene(ro,rd,fragCoord.xy, t);\n    \n    col=tonemap(col);\n    col=pow(clamp(col,0.0,1.0),vec3(0.45)); \n    col=pow(col,vec3(0.85,1.,0.95));\n    \n #ifdef AA \n\t// temporal AA from iq's Rainforest: https://www.shadertoy.com/view/4ttSWf\n    vec2 o=hash2(float(iFrame))-0.5;\n\n    mat4 old_cam=mat4(textureLod(iChannel0,vec2(0.5,0.5)/iResolution.xy, 0.0),\n                      textureLod(iChannel0,vec2(1.5,0.5)/iResolution.xy, 0.0),\n                      textureLod(iChannel0,vec2(2.5,0.5)/iResolution.xy, 0.0),\n                      0.0, 0.0, 0.0, 1.0 );\n    \n    // world space\n    vec4 wpos=vec4(ro + rd*t,1.0);\n    // camera space\n    vec3 cpos=(wpos*old_cam).xyz; // note inverse multiply\n    // ndc space\n    vec2 npos=PI/2. * cpos.xy / cpos.z;\n    // screen space\n    vec2 spos=0.5 + 0.5*npos*vec2(iResolution.y/iResolution.x,1.0);\n    // undo dither\n    spos-=o/iResolution.xy;\n\t// raster space\n    vec2 rpos=spos * iResolution.xy;\n    \n    if(rpos.y<1.0 && rpos.x<3.0)\n    {\n    }\n\telse\n    {\n        vec3 ocol=textureLod(iChannel0, spos, 0.0).xyz;\n    \tif(iFrame==0) ocol=col;\n        col=mix(ocol, col, 0.4);\n    }\n\n    //----------------------------------\n                           \n\tif( fragCoord.y<1.0 && fragCoord.x<3.0 )\n    {\n        if(abs(fragCoord.x-2.5)<0.5) \n            fragColor=vec4(cam[2], -dot(cam[2],ro));\n        if(abs(fragCoord.x-1.5)<0.5) \n            fragColor=vec4(cam[1], -dot(cam[1],ro));\n        if(abs(fragCoord.x-0.5)<0.5) \n            fragColor=vec4(cam[0], -dot(cam[0],ro));\n    }\n    else\n#endif\n    {\n        fragColor.xyz=col;;\n    }\n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 1,
                        "ctype": "texture",
                        "id": 45,
                        "published": 1,
                        "sampler": {
                            "filter": "mipmap",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "repeat"
                        },
                        "src": "/media/a/3871e838723dd6b166e490664eead8ec60aedd6b8d95bc8e2fe3f882f0fd90f0.jpg"
                    },
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 257,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer00.png"
                    }
                ],
                "name": "Buffer A",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 257
                    }
                ],
                "type": "buffer"
            }
        ],
        "ver": "0.1"
    }
}