{
    "Shader": {
        "info": {
            "date": "1613845851",
            "description": "Crytek's SSAO.",
            "flags": 32,
            "hasliked": 0,
            "id": "WtyfR1",
            "likes": 14,
            "name": "SSAO (Screen Space AO)",
            "published": 3,
            "tags": [
                "3d",
                "ao",
                "ssao"
            ],
            "usePreview": 0,
            "username": "moranzcw",
            "viewed": 2032
        },
        "renderpass": [
            {
                "code": "// SSAO (Screen Space AO) - by moranzcw - 2021\n// Email: moranzcw@gmail.com\n// License Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.\n\n#define PI 3.14159265359\n#define AOradius 2.0\n#define Samples 64.0\n\n// --------------------------------------\n// oldschool rand() from Visual Studio\n// --------------------------------------\nint   seed = 1;\nvoid  srand(int s ) { seed = s; }\nint   rand(void)  { seed=seed*0x343fd+0x269ec3; return (seed>>16)&32767; }\nfloat frand(void) { return float(rand())/32767.0; }\n// --------------------------------------\n// hash by Hugo Elias\n// --------------------------------------\nint hash( int n ) { n=(n<<13)^n; return n*(n*n*15731+789221)+1376312589; }\n\nvec3 sphereVolumeRandPoint()\n{\n    vec3 p = vec3(frand(),frand(),frand()) * 2.0 - 1.0;\n    while(length(p)>1.0)\n    {\n        p = vec3(frand(),frand(),frand()) * 2.0 - 1.0;\n    }\n    return p;\n}\n\nfloat depth(vec2 coord)\n{\n    vec2 uv = coord*vec2(iResolution.y/iResolution.x,1.0);\n    return texture(iChannel0, uv).x;\n}\n\nfloat SSAO(vec2 coord)\n{\n    float cd = depth(coord);\n    float screenRadius = 0.5 * (AOradius / cd) / 0.53135;\n    float li = 0.0;\n    float count = 0.0;\n    for(float i=0.0; i<Samples; i++)\n    {\n        vec3 p = sphereVolumeRandPoint() * frand();\n        vec2 sp = vec2(coord.x + p.x * screenRadius, coord.y + p.y * screenRadius);\n        float d = depth(sp);\n        float at = pow(length(p)-1.0, 2.0);\n        li += step(cd + p.z * AOradius, d) * at;\n        count += at;\n    }\n    return li / count;\n}\n\nvec3 background(float yCoord) \n{\t    \n    return mix(vec3(0.1515, 0.2375, 0.5757), vec3(0.0546, 0.0898, 0.1953), yCoord);\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord ) \n{\n    // init random seed\n    ivec2 q = ivec2(fragCoord);\n    srand( hash(q.x+hash(q.y+hash(1117*iFrame))));\n    \n    // coordinate\n    vec2 uv = fragCoord/iResolution.xy;\n    vec2 coord = fragCoord/iResolution.y;\n    \n    float d = depth(coord);\n    vec3 ao = vec3(0.4) + step(d, 1e5-1.0) * vec3(0.8) * SSAO(coord);\n    vec3 color = mix(background(uv.y), ao, 1.0 - smoothstep(0.0, 0.99, d*d/1e3));;\n    \n    color = pow(color,vec3(1.0/2.2)); // gamma\n\tfragColor = vec4(color, 1.0);\n}\n ",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 257,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer00.png"
                    }
                ],
                "name": "Image",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 37
                    }
                ],
                "type": "image"
            },
            {
                "code": "// SSAO (Screen Space AO) - by moranzcw - 2021\n// Email: moranzcw@gmail.com\n// License Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.\n\n#define Epsilon 1e-2\n\nstruct Ray \n{ \n    vec3 origin, direction;\n};\n\nstruct Sphere \n{\n\tfloat radius;\n\tvec3 position;\n};\n\nSphere spheres[5];\n\nvoid initSpheres()\n{\n    spheres[0] = Sphere(0.5, vec3(0.0, 0.5, -0.2));\n    spheres[1] = Sphere(0.7, vec3(-1.7, 0.7, -0.8));\n    spheres[2] = Sphere(1.0, vec3(1.8, 1.0, -0.5));\n    spheres[3] = Sphere(2.0, vec3(0.0, 2.0, -2.8));\n    spheres[4] = Sphere(1000.0, vec3(0.0, -1000.0, 0.0));\n}\n\nfloat intersect(Sphere sphere, Ray ray)\n{\n\tvec3 op = sphere.position - ray.origin;\n\tfloat t1, t2 = Epsilon;\n    float b = dot(op, ray.direction);\n    float det = b * b - dot(op, op) + sphere.radius * sphere.radius;\n    \n\tif (det < 0.0)\n        return 0.0;\n    else\n        det = sqrt(det);\n    \n    t1 = b - det;\n    t2 = b + det;\n    if(t1 > Epsilon)\n        return t1;\n    if(t2 > Epsilon)\n        return t2;\n    return 0.0;\n}\n\nRay cameraRay(vec3 camPosition, vec3 lookAt, vec2 fragCoord)\n{\n    vec2 uv = 2. * fragCoord.xy / iResolution.xy - 1.;\n\n    vec3 cz = normalize(lookAt - camPosition);\n\tvec3 cx = normalize(cross(cz, vec3(0.0, 1.0, 0.0)));\n\tvec3 cy = normalize(cross(cx, cz));\n    \n    return Ray(camPosition, normalize(0.53135 * (iResolution.x/iResolution.y*uv.x * cx + uv.y * cy) + cz));\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord ) \n{\n    \n    // init spheres\n    initSpheres();\n    \n    // camera ray\n    vec3 camPosition = mix(vec3(-2.0, 3.0, 6.0), vec3(2.0, 3.0, 6.0), sin(iTime*0.3));\n    vec3 lookAt = vec3(0.0, 2.0, 0.0);\n    Ray ray = cameraRay(camPosition, lookAt, fragCoord);\n    \n\tvec3 color=vec3(0.0);\n    \n    // intersect\n    float t = 1e5;\n    int id;\n    for(int i=0; i<5; i++)\n    {\n        float temp = intersect(spheres[i], ray);\n        if(temp > Epsilon && temp < t)\n        {\n            t = temp;\n            id = i;\n        }\n    }\n    \n    float depth = t;\n    \n\tfragColor = vec4(depth, vec3(0.0));\n}\n",
                "description": "",
                "inputs": [],
                "name": "Buffer A",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 257
                    }
                ],
                "type": "buffer"
            }
        ],
        "ver": "0.1"
    }
}