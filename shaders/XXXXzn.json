{
    "Shader": {
        "info": {
            "date": "1709053273",
            "description": "Lit structures (mouseable)",
            "flags": 0,
            "hasliked": 0,
            "id": "XXXXzn",
            "likes": 19,
            "name": "Lots of Light",
            "published": 3,
            "tags": [
                "lighting",
                "structure"
            ],
            "usePreview": 0,
            "username": "dr2",
            "viewed": 341
        },
        "renderpass": [
            {
                "code": "#define Ul(Ow)if(Nt<SA){SA=Nt;TD=Ow;LM=Kb;}\n#define DV min(GW,0)\nvec3 LM,FX,Pv,Of;vec2 Xq,NO;float VW,Jt,Zb,PQ,IY;int GW,TD;const float By=3.1415927;const int RS=1,Cg=2,WZ=3,Av=4,YK=5,Vo=6,Qh=7;float GF(vec3 ZN,vec3 Bh,float QT){return length(max(abs(ZN)-Bh,0.))-QT;}float EU(vec3 ZN,float Pi,float AM){return length(vec3(ZN.xy,sign(ZN.z)*(max(0.,abs(ZN.z)-AM))))-Pi;}float Iq(vec3 ZN,vec3 Bh,float Wa){return length(vec2(length(max(abs(ZN.xy)-Bh.xy,0.))-Bh.z,ZN.z))-Wa;}float Tm(vec2 ZN){return max(ZN.x,ZN.y);}float Yt(vec2 ZN){return min(ZN.x,ZN.y);}float UX(vec3 ZN){return max(ZN.x,max(ZN.y,ZN.z));}float TY(float YO,float Az,float Pi){float AM;AM=clamp(0.5+0.5*(Az-YO)/Pi,0.,1.);return mix(Az-AM*Pi,YO,AM);}float Sn(float YO,float Az,float Pi){return-TY(-YO,-Az,Pi);}float QC(float RB,float Jp,float My,float Oj){return(1.-smoothstep(Jp-My,Jp+My,Oj))*smoothstep(RB-My,RB+My,Oj);}mat3 Em(float Bd,float Ko){vec2 Yc,SR,CS;Yc=vec2(Bd,Ko);SR=cos(Yc);CS=sin(Yc);return mat3(SR.y,0.,-CS.y,0.,1.,0.,CS.y,0.,SR.y)*mat3(1.,0.,0.,0.,SR.x,-CS.x,0.,CS.x,SR.x);}vec2 Zw(vec2 Kb,float BL){vec2 LI;LI=sin(BL+vec2(0.5*By,0.));return vec2(dot(Kb,vec2(LI.x,-LI.y)),dot(Kb.yx,LI));}vec3 ML(vec3 Rg){return Rg.z*mix(vec3(1.),clamp(abs(fract(Rg.xxx+vec3(1.,2./3.,1./3.))*6.-3.)-1.,0.,1.),Rg.y);}const float ZJ=43758.54;float Cx(vec2 ZN){return fract(sin(dot(ZN,vec2(37.,39.)))*ZJ);}vec2 Ei(float ZN){return fract(sin(ZN+vec2(0.,1.))*ZJ);}vec2 FT(vec2 ZN){vec2 Bu=vec2(37.,39.);return fract(sin(dot(ZN,Bu)+vec2(0.,Bu.x))*ZJ);}vec4 HE(vec3 ZN){vec3 Df=vec3(37.,39.,41.);return fract(sin(dot(ZN,Df)+vec4(0.,Df.xy,Df.x+Df.y))*ZJ);}float IH(float ZN){vec2 HI;float DR,ON;DR=floor(ZN);ON=fract(ZN);ON=ON*ON*(3.-2.*ON);HI=Ei(DR);return mix(HI.x,HI.y,ON);}float Ks(vec2 ZN){vec2 HI,DR,ON;DR=floor(ZN);ON=fract(ZN);ON=ON*ON*(3.-2.*ON);HI=mix(FT(DR),FT(DR+vec2(0.,1.)),ON.y);return mix(HI.x,HI.y,ON.x);}float Md(vec3 ZN){vec4 HI;vec3 DR,ON;DR=floor(ZN);ON=fract(ZN);ON*=ON*(3.-2.*ON);HI=mix(HE(DR),HE(DR+vec3(0.,0.,1.)),ON.z);return mix(mix(HI.x,HI.y,ON.x),mix(HI.z,HI.w,ON.x),ON.y);}float Gk(float ZN){float Ez,a;Ez=0.;a=1.;for(int FC=0;FC<5;FC++){Ez+=a*IH(ZN);a*=0.5;ZN*=2.;}return Ez*(1./1.9375);}float HV(vec2 ZN){float Ez,a;Ez=0.;a=1.;for(int FC=0;FC<5;FC++){Ez+=a*Ks(ZN);a*=0.5;ZN*=2.;}return Ez*(1./1.9375);}float JG(vec3 ZN,vec3 DA){vec3 Bh;float a;Bh=vec3(0.);a=1.;for(int FC=0;FC<5;FC++){Bh+=a*vec3(Ks(ZN.yz),Ks(ZN.zx),Ks(ZN.xy));a*=0.5;ZN*=2.;}return dot(Bh,abs(DA));}vec3 Ck(vec3 ZN,vec3 DA,float Ez){vec4 Xd;vec3 g;vec2 Zs=vec2(0.1,0.);for(int FC=DV;FC<4;FC++)Xd[FC]=JG(ZN+((FC<2)?((FC==0)?Zs.xyy:Zs.yxy):((FC==2)?Zs.yyx:Zs.yyy)),DA);g=Xd.xyz-Xd.w;return normalize(DA+Ez*(g-DA*dot(DA,g)));}void HZ(){vec2 AM;AM=FT(13.1*Xq+0.1);NO=1.+step(0.33,AM)+2.*step(0.67,AM);Pv.xz=0.5*floor(4.8/NO);Pv.y=0.25*floor(2.*Yt(Pv.xz));}float Rk(vec3 ZN){vec3 Kb;vec2 w,Xd;float SA,Nt,Bh;SA=VW;Kb=ZN;Kb.xz-=Zb*(Xq+0.5);Kb.y-=0.005;Nt=GF(Kb,vec3(vec2(3.),0.005).xzy,0.001);Ul(Vo);if(Pv.y>0.){Kb.y-=Pv.y+0.002;Kb.xz=mix(Kb.xz,abs(Kb.xz)-1.5,step(1.5,NO));Kb.xz=mix(Kb.xz,abs(Kb.xz)-0.75,step(2.5,NO));Nt=GF(Kb,vec3(Pv.xz-0.001,Pv.y).xzy,0.001);Ul(RS);w=mod(Kb.xz+0.0625,0.125)-0.0625;Xd=abs(Kb.xz)-Pv.xz;Nt=max(Iq(vec3(Xd.y,Kb.y,w.x),vec3(0.04,Pv.y+0.05,0.04),0.01),Xd.x+0.0625);Ul(WZ);Nt=max(Iq(vec3(Xd.x,Kb.y,w.y),vec3(0.04,Pv.y+0.05,0.04),0.01),Xd.y+0.0625);Ul(WZ);Nt=max(EU(vec3(w.x,Xd.y,Kb.y),0.02,Pv.y),Xd.x+0.0625);Ul(Av);Nt=max(EU(vec3(Xd.x,w.y,Kb.y),0.02,Pv.y),Xd.y+0.0625);Ul(Av);Nt=EU(vec3(Xd,Kb.y),0.03,Pv.y);Ul(YK);Nt=Iq(vec3(Kb.xz,Kb.y-Pv.y-0.01),vec3(Pv.xz-0.13,0.05),0.02);Ul(WZ);Nt=Iq(vec3(Kb.xz,Kb.y+Pv.y-0.01),vec3(Pv.xz+0.03,0.05),0.02);Ul(WZ);Bh=length(Kb.xz)-0.4*Yt(Pv.xz);Nt=max(max(Bh,abs(Kb.y-Pv.y-0.03)-0.03),min(Tm(abs(mod(Kb.xz+0.0125,0.025)-0.0125)-0.0075),-Bh-0.015));Ul(Cg);}Kb=ZN;Nt=Kb.y;Ul(Qh);return SA;}float UG(vec3 XL,vec3 QT){vec3 SE,ZN;bool GB;float QP,Nt,Bh,ED,CO;if(QT.x==0.)QT.x=1e-4;if(QT.y==0.)QT.y=1e-4;if(QT.z==0.)QT.z=1e-4;SE=1./QT;CO=1e-3;GB=true;QP=0.;for(int FC=DV;FC<240;FC++){ZN=XL+QP*QT;if(GB){Xq=floor(ZN.xz/Zb);ED=Yt((Zb*(Xq+step(0.,QT.xz))-XL.xz)*SE.xz);HZ();GB=false;}Nt=Rk(ZN);Bh=max(QP,ED);if(QP+Nt<Bh){QP+=Nt;}else{QP=Bh+CO;GB=true;}if(Nt<CO||QP>VW||ZN.y<0.)break;}return QP;}vec3 SV(vec3 ZN){vec4 Xd;vec2 Zs;Zs=1e-4*vec2(1.,-1.);for(int FC=DV;FC<4;FC++){Xd[FC]=Rk(ZN+((FC<2)?((FC==0)?Zs.xxx:Zs.xyy):((FC==2)?Zs.yxy:Zs.yyx)));}Xd.x=-Xd.x;return normalize(2.*Xd.yzw-dot(Xd,vec4(1.)));}vec3 Lv(vec2 Kb){vec2 Xu,AQ;Xu=smoothstep(0.02,0.03,abs(fract(Kb+0.5)-0.5));Kb=fract(Kb)-0.5;AQ=0.07*By*smoothstep(0.4,0.47,abs(Kb.xy))*sign(Kb.xy);if(abs(Kb.x)<abs(Kb.y))AQ.x=0.;else AQ.y=0.;return vec3(AQ.x,0.8+0.2*Xu.x*Xu.y,AQ.y);}vec2 JK(float Kb){float Xu,AQ;Xu=smoothstep(0.02,0.03,abs(fract(Kb+0.5)-0.5));Kb=fract(Kb)-0.5;AQ=0.07*By*smoothstep(0.4,0.47,abs(Kb))*sign(Kb);return vec2(AQ,0.8+0.2*Xu);}\nvec4 Pz(vec3 XL,vec3 QT,inout vec3 Jc){vec4 JX,Wn,EQ;vec3 Up;vec2 La;La=FT(39.1*Xq+0.1);Wn=vec4(ML(vec3(La.x,0.5,0.6+0.2*La.y)),0.1);EQ=vec4(ML(vec3(La.x,0.9,1.)),-1.);if(TD==RS){JX=Wn;if(Jc.y>0.99){if(length(LM.xz)<length(0.4*Yt(Pv.xz)))JX=vec4(0.5*EQ.rgb,-1.);}else{Up.xy=JK(8.*LM.y);JX*=Up.y;if(abs(Jc.x)>abs(Jc.z))Jc.yx=Zw(Jc.yx,-Up.x*sign(Jc.x));else Jc.yz=Zw(Jc.yz,-Up.x*sign(Jc.z));}}else if(TD==WZ){JX=vec4(EQ.rgb*(0.6+0.4*smoothstep(-0.4,0.4,sin(0.5*By*(Jt/Pv.y+2.*La.y)))),-1.);}else if(TD==Av){JX=vec4(EQ.rgb*(0.5+0.5*smoothstep(0.,0.2,sin(2.*By*(Jt-4.*LM.y/Pv.y+La.y)))),-1.);}else if(TD==YK){JX=vec4(EQ.rgb*(0.5+0.5*smoothstep(0.,0.2,sin(2.*By*(Jt+4.*LM.y/Pv.y+La.y)))),-1.);}else if(TD==Cg){JX=Wn;if(length(LM.xz)>0.4*Yt(Pv.xz)-0.015)JX=vec4(EQ.rgb*(0.4+0.6*smoothstep(0.,0.2,sin(16.*atan(LM.z,LM.x)+8.*By*Jt))),-1.);}else if(TD==Vo){Up=Lv(8.*XL.xz);JX=vec4(0.5,0.5,0.5,0.1)*Up.y;if(Jc.y>0.99){if(Up.x==0.)Jc.yz=Zw(Jc.yz,Up.z);else Jc.yx=Zw(Jc.yx,Up.x);}}else if(TD==Qh){Up=Lv(4.*XL.xz);JX=vec4(0.3,0.3,0.35,0.)*Up.y;if(Up.x==0.)Jc.yz=Zw(Jc.yz,Up.z);else Jc.yx=Zw(Jc.yx,Up.x);}return JX;}vec3 CB(vec3 QT,float Go){vec3 Le,Nx,RW;vec2 Kb;float Ez;Le=-1./max(abs(QT),0.0001);Nx=-sign(QT)*step(Le.zxy,Le)*step(Le.yzx,Le);RW=UX(Le)*QT;Kb=atan(vec2(dot(RW.zxy,Nx),dot(RW.yzx,Nx)),vec2(1.))/By;Ez=0.57*(HV(11.*dot(0.5*(Nx+1.),vec3(1.,2.,4.))+131.13*Go*Kb)+HV(13.*dot(0.5*(Nx+1.),vec3(1.,2.,4.))+171.13*Go*Kb.yx));return 4.*vec3(1.,1.,0.8)*pow(Ez,16.);}vec3 OR(vec3 QT){vec3 Im,WI,Jc;float BP,NK,Ql;if(QT.y<0.02*Gk(128.*mod(atan(QT.x,QT.z)/(2.*By)+0.625,1.))){Im=0.1*vec3(0.4,0.5,0.8);}else{WI=normalize(vec3(0.6,0.04,1.));BP=0.025;Im=vec3(0.06,0.06,0.03)*pow(clamp(dot(QT,WI),0.,1.),16.);NK=dot(QT,WI);Ql=NK*NK-1.+BP*BP;if(Ql>0.){Ql=NK-sqrt(Ql);if(Ql>0.){Jc=normalize((Ql*QT-WI)/BP);Im+=vec3(1.,0.9,0.5)*(0.07+0.93*clamp(dot(vec3(-0.77,0.4,0.5),Jc)*(1.-0.3*Md(8.*Jc)),0.,1.));}}else Im+=CB(QT,8.);}return Im;}vec3 Ng(vec3 XL,vec3 QT){vec4 JX;vec3 Im,Jc,LZ,KJ,Hn;vec2 Hr;float XH,Mu,ID;Hr=vec2(0.);LZ=OR(QT);Im=LZ;XH=UG(XL,QT);if(QT.y<0.&&XH>=VW){XH=-XL.y/QT.y;TD=Qh;}if(XH<VW){XL+=XH*QT;Jc=(TD!=Qh)?SV(XL):vec3(0.,1.,0.);JX=Pz(XL,QT,Jc);if(Hr.x>0.)Jc=Ck(Hr.x*LM,Jc,Hr.y);if(JX.a>=0.){Hn=vec3(0.,0.,-1.);Hn.yz=Zw(Hn.yz,0.25*By);Hn.xz=Zw(Hn.xz,-PQ-IY);KJ=Of-XL;Mu=length(KJ);KJ/=Mu;ID=0.3+0.7*smoothstep(-0.02,0.02,dot(Hn,KJ)-cos(0.15*By))*step(-dot(Jc,KJ),0.)/(1.+0.01*Mu*Mu);Im=ID*JX.rgb*(0.2+0.8*max(dot(Jc,FX),0.))+JX.a*pow(max(dot(FX,reflect(QT,Jc)),0.),32.);}else Im=JX.rgb*(0.6-0.4*dot(Jc,QT));Im=mix(LZ,Im,min(1.,exp2(1.-5.*XH/VW)));}return clamp(Im,0.,1.);}vec3 OA(float HI){vec3 ZN;float Dj,Bh,XY;Dj=2.*Zb;ZN.y=0.;Bh=mod(HI,11.);if(Bh<7.)ZN.xz=(Bh<4.)?vec2(0.,Bh):vec2(Bh-4.,4.);else ZN.xz=(Bh<9.)?vec2(3.,11.-Bh):vec2(12.-Bh,2.);XY=floor(HI/11.);if(mod(XY,2.)==0.)ZN.x*=-1.;else ZN.x-=1.;ZN.z+=2.*XY;ZN.xz*=Dj;return ZN;}void Nc(float Bh,out vec3 ZN,out float Ko){vec3 Sj,Qy,FG;Sj=OA(Bh+0.1);Qy=OA(Bh-0.1);FG=Sj-Qy;ZN=0.5*(Sj+Qy);Ko=0.5*By-atan(FG.z,FG.x);}void mainImage(out vec4 TU,in vec2 VF){mat3 Lr,KN;vec4 Ae,Pe;vec3 XL,QT,Im;vec2 UC,TH,Vs;float VJ,Bd,Ko,PU,GS,Zf,MP;\nGW=iFrame;UC=iResolution.xy;TH=2.*VF.xy/UC-1.;TH.x*=UC.x/UC.y;Jt=iTime;Pe=iDate;Ae=iMouse;Ae.xy=Ae.xy/UC-0.5;\nJt=mod(Jt,18000.)+30.*floor(Pe.w/3600.);GS=UC.x/UC.y;VJ=0.1;MP=VJ*Jt;Zb=8.;Nc(MP+0.1,Of,PQ);Of.y=2.;Nc(MP,XL,Ko);XL.y=0.8+1.7*QC(0.25,0.75,0.15,fract(0.05*Jt));XL.xz+=0.001;Bd=-0.02*By;IY=0.;if(Ae.z>0.){IY+=2.*By*Ae.x;Ko+=2.*By*Ae.x;Bd+=0.6*By*Ae.y;}else{Ko+=0.5*By*QC(0.25,0.75,0.2,fract(0.05*Jt))*sign(fract(0.025*Jt)-0.5);}IY=clamp(IY,-0.5*By,0.5*By);Bd=clamp(Bd,-0.25*By,0.25*By);KN=Em(Bd-0.03*By,Ko);VW=200.;FX=KN*normalize(vec3(0.5,1.,-1.));PU=3.;const float Fl=3.;Im=vec3(0.);Zf=2.*mod(dot(mod(floor(0.5*(TH+1.)*UC),2.),vec2(1.)),2.)-1.;for(float a=float(DV);a<Fl;a++){Vs=(TH+step(1.5,Fl)*Zw(vec2(0.5/UC.y,0.),Zf*(0.667*a+0.5)*By))/PU;QT=KN*normalize(vec3(2.*tan(0.5*atan(Vs.x/GS))*GS,Vs.y,1.));Im+=(1./Fl)*Ng(XL,QT);}TU=vec4(Im,1.);}\n",
                "description": "",
                "inputs": [],
                "name": "Image",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 37
                    }
                ],
                "type": "image"
            }
        ],
        "ver": "0.1"
    }
}