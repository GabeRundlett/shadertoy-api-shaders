{
    "Shader": {
        "info": {
            "date": "1695501287",
            "description": "Latte Art simulation. (Use the mouse to become a barista) ",
            "flags": 32,
            "hasliked": 0,
            "id": "csdcW2",
            "likes": 25,
            "name": "Latte Art",
            "published": 3,
            "tags": [
                "fluid"
            ],
            "usePreview": 0,
            "username": "wyatt",
            "viewed": 292
        },
        "renderpass": [
            {
                "code": "// Fork of \"Shader Fluid\" by wyatt. https://shadertoy.com/view/mddyWn\n// 2023-09-23 13:52:35\n\nfloat segment (vec2 p, vec2 a, vec2 b) {\n        return length(p-a-(b-a)*clamp(dot(p-a,b-a)/dot(b-a,b-a),0.,1.));\n    }\n    vec4 T(vec3 p ) {\n        return A(p.xz*.8*r.y+.5*r);\n    }\nfloat map (vec3 p, out bool b) {\n    b = false;\n    float d = 1e9;\n    d = min(d,length(p)-.65);\n    d = max(d,p.y);\n    d = max(d,-length(p)+.55);\n    d = min(d,length(vec2(length(p.xz)-.6,p.y))-.05);\n    d = min(d,max(-length(p)+.6,length(vec2( length(p.xy-vec2(.62,-.3))-.2,p.z))-.06));\n    d = min(d,segment(vec2(length(p.xz),p.y),vec2(0,-.8),vec2(.5,-.7))-.05);\n    d = min(d,segment(vec2(length(p.xz),p.y+.1-.2*length(p.xz)),vec2(.5,-.65),vec2(.9,-.6))-.05);\n    \n    float m = max(length(p)-.65,p.y+.1);\n    \n    if (m < d) {\n        b = true;\n        vec4 _ = T(p);\n        m -=  .01*_.z+.1*_.w;\n        d = m;\n    }\n    return d;\n}\nvec3 normal (vec3 p) {\n    vec2 e = vec2(1e-4,0);\n    bool b;\n    return normalize(vec3 (\n        map(p+e.xyy,b)-map(p-e.xyy,b),\n        map(p+e.yxy,b)-map(p-e.yxy,b),\n        map(p+e.yyx,b)-map(p-e.yyx,b)\n    ));\n}\nMain {\n //if (iFrame%8>0) discard;\n    vec3 p = vec3(0,-.3,-3.5);\n    vec3 d = normalize(vec3(2.*(U-.5*R)/R.y,4));\n    float t = -.8;\n    p.yz *= mat2(cos(t),sin(t),-sin(t),cos(t));\n    d.yz *= mat2(cos(t),sin(t),-sin(t),cos(t));\n    float m = 0.;\n    bool b;\n    for (float i = 0.; i < 60.; i++) {\n        m += map(p+d*m,b);\n        if (m > 10.) {m=10.;break;}\n    }\n    \n    if (b) {\n        vec3 q = p+d*m;\n        vec3 n = normal(q);\n        float t = T(q).z;\n        Q = vec4(.3,.1,.1,1);\n        float bb = 0.;\n        \n        Q += texture(iChannel1,reflect(d,n))*.5+.2*texture(iChannel2,reflect(d,n));\n        if (m==10.) Q = vec4(0);\n        Q = mix(Q,vec4(.3,.1,.1,1)+.84+.2*n.zzzz,min(10.*t,1.));\n     } else {\n        vec3 n = normal(p+d*m);\n        Q = vec4(1,.9,.8,1)*(.8+.2*n.y)*(.8+.1*texture(iChannel1,reflect(d,n))+.1*texture(iChannel2,reflect(d,n)));\n        if (m==10.) Q = .04+.16*sin(4.8+.3*U.x/R.x+vec4(1,2,3,4));\n    }\n    \n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 1,
                        "ctype": "cubemap",
                        "id": 24,
                        "published": 1,
                        "sampler": {
                            "filter": "mipmap",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "false",
                            "wrap": "clamp"
                        },
                        "src": "/media/a/488bd40303a2e2b9a71987e48c66ef41f5e937174bf316d3ed0e86410784b919.jpg"
                    },
                    {
                        "channel": 2,
                        "ctype": "cubemap",
                        "id": 25,
                        "published": 1,
                        "sampler": {
                            "filter": "mipmap",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "false",
                            "wrap": "clamp"
                        },
                        "src": "/media/a/550a8cce1bf403869fde66dddf6028dd171f1852f4a704a465e1b80d23955663.png"
                    },
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 257,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer00.png"
                    }
                ],
                "name": "Image",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 37
                    }
                ],
                "type": "image"
            },
            {
                "code": "#define R iResolution.xy\n#define A(U) texture(iChannel0,(U)/R)\n#define B(U) texture(iChannel1,(U)/R)\n#define Main void mainImage(out vec4 Q, vec2 U) \n\n#define density 1.\n#define gravity .5\n\n#define K .05\n\n\n\n#define r R",
                "description": "",
                "inputs": [],
                "name": "Common",
                "outputs": [],
                "type": "common"
            },
            {
                "code": "Main {\n\n    Q = A(U);\n    \n    vec4 n = A(U+vec2(0,1));\n    vec4 e = A(U+vec2(1,0));\n    vec4 s = A(U-vec2(0,1));\n    vec4 w = A(U-vec2(1,0));\n\n    Q.xy += .5*(0.25*(n.xy+e.xy+s.xy+w.xy)-Q.xy)-\n        .2*vec2(e.w-w.w,n.w-s.w);\n    Q.xy *= .999;\n    \n    if (length(U-.5*r)>.45*r.y) Q.xyz *= 0.;\n    \n    vec4 _m = A(vec2(.5));\n    vec2 mu = U-_m.xy;\n    vec2 dv = .004*(_m.xy-_m.zw);\n    if (length(dv)>.05) dv = .08*normalize(dv);\n    if (iMouse.z>0.&&iMouse.w < 1.) \n        Q =\n            mix(Q,\n            \n                vec4(Q.xy+dv,1.,Q.w+.04*exp(-100.*length(dv))),\n            \n                exp(-vec4(.002,.002,.02,.01)*dot(mu,mu))\n             );\n    \n    \n    \n    if (iFrame < 1 ) Q = vec4(0,0,0,.1);\n\n    \n    if (U.x < 1. && U.y < 1.) Q = A(U);\n    else if (U.x < 3. && U.y < 3.) Q = vec4(0);\n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 260,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer03.png"
                    }
                ],
                "name": "Buffer A",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 257
                    }
                ],
                "type": "buffer"
            },
            {
                "code": "Main\n{\n    Q = A(U);\n    vec4 dQ = vec4(0);\n    \n    for(int x=-1;x<=1;x++)\n    for(int y=-1;y<=1;y++)  if(abs(x)!=abs(y))\n    {\n        vec2 u = vec2(x,y);\n        vec4 q = A(U+u);\n        vec2 a = Q.xy,\n             b = q.xy+u;\n       float ab = dot(u,b-a);\n       float i = dot(u,(0.5*u-a))/ab;\n      {\n           float j = .5;//+.1*max(1.-q.w,0.);\n           float k = .5;//+.1*max(1.-Q.w,0.);\n           float wa = 0.25*Q.w*min(i,j)/j;\n           float wb = 0.25*q.w*max(k+i-1.,0.)/k;\n            dQ += vec4(Q.xyz,1)*wa+vec4(q.xyz,1)*wb;\n      }\n        \n    }\n    if (dQ.w>0.)dQ.xyz/=dQ.w;\n    Q = dQ;\n    \n    \n    if (U.x < 1. && U.y < 1.) Q = A(U);\n    else if (U.x < 3. && U.y < 3.) Q = vec4(0);\n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 257,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer00.png"
                    }
                ],
                "name": "Buffer B",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 258
                    }
                ],
                "type": "buffer"
            },
            {
                "code": "Main {\n\n    Q = A(U);\n    \n    vec4 n = A(U+vec2(0,1));\n    vec4 e = A(U+vec2(1,0));\n    vec4 s = A(U-vec2(0,1));\n    vec4 w = A(U-vec2(1,0));\n\n    Q.xy += .5*(0.25*(n.xy+e.xy+s.xy+w.xy)-Q.xy)-\n        .2*vec2(e.w-w.w,n.w-s.w);\n    Q.xy *= .999;\n    \n    if (length(U-.5*r)>.45*r.y) Q.xyz *= 0.;\n    \n    vec4 _m = A(vec2(.5));\n    vec2 mu = U-_m.xy;\n    vec2 dv = .004*(_m.xy-_m.zw);\n    if (length(dv)>.05) dv = .08*normalize(dv);\n    if (iMouse.z>0.&&iMouse.w < 1.) \n        Q =\n            mix(Q,\n            \n                vec4(Q.xy+dv,1.,Q.w+.04*exp(-100.*length(dv))),\n            \n                exp(-vec4(.002,.002,.02,.01)*dot(mu,mu))\n             );\n    \n    \n    \n    if (iFrame < 1 ) Q = vec4(0,0,0,.1);\n\n    \n    if (U.x < 1. && U.y < 1.) Q = A(U);\n    else if (U.x < 3. && U.y < 3.) Q = vec4(0);\n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 258,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer01.png"
                    }
                ],
                "name": "Buffer C",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 259
                    }
                ],
                "type": "buffer"
            },
            {
                "code": "float segment (vec2 p, vec2 a, vec2 b) {\n        return length(p-a-(b-a)*clamp(dot(p-a,b-a)/dot(b-a,b-a),0.,1.));\n    }\n    vec4 T(vec3 p ) {\n        return A(p.xz*.8*r.y+.5*r);\n    }\nfloat map (vec3 p, out bool b) {\n    b = false;\n    float d = 1e9;\n    d = min(d,length(p)-.65);\n    d = max(d,p.y);\n    d = max(d,-length(p)+.55);\n    d = min(d,length(vec2(length(p.xz)-.6,p.y))-.05);\n    d = min(d,max(-length(p)+.6,length(vec2( length(p.xy-vec2(.62,-.3))-.2,p.z))-.06));\n    d = min(d,segment(vec2(length(p.xz),p.y),vec2(0,-.8),vec2(.5,-.7))-.05);\n    d = min(d,segment(vec2(length(p.xz),p.y+.1-.2*length(p.xz)),vec2(.5,-.65),vec2(.9,-.6))-.05);\n    \n    float m = max(length(p)-.65,p.y+.1);\n    \n    if (m < d) {\n        b = true;\n        vec4 _ = T(p);\n        m -=  .01*_.z+.1*_.w;\n        d = m;\n    }\n    return d;\n}\nMain\n{\n    Q = A(U);\n    vec4 dQ = vec4(0);\n    \n    for(int x=-1;x<=1;x++)\n    for(int y=-1;y<=1;y++)  if(abs(x)!=abs(y))\n    {\n        vec2 u = vec2(x,y);\n        vec4 q = A(U+u);\n        vec2 a = Q.xy,\n             b = q.xy+u;\n       float ab = dot(u,b-a);\n       float i = dot(u,(0.5*u-a))/ab;\n      {\n           float j = .5;//+.1*max(1.-q.w,0.);\n           float k = .5;//+.1*max(1.-Q.w,0.);\n           float wa = 0.25*Q.w*min(i,j)/j;\n           float wb = 0.25*q.w*max(k+i-1.,0.)/k;\n            dQ += vec4(Q.xyz,1)*wa+vec4(q.xyz,1)*wb;\n      }\n        \n    }\n    if (dQ.w>0.)dQ.xyz/=dQ.w;\n    Q = dQ;\n    \n    \n    if (U.x < 1. && U.y < 1.) {\n       U = iMouse.xy;\n       vec3 p = vec3(0,-.3,-3.5);\n        vec3 d = normalize(vec3(2.*(U-.5*R)/R.y,4));\n        float t = -.8;\n        p.yz *= mat2(cos(t),sin(t),-sin(t),cos(t));\n        d.yz *= mat2(cos(t),sin(t),-sin(t),cos(t));\n        float m = 0.;\n        bool b;\n        for (float i = 0.; i < 60.; i++) {\n            m += map(p+d*m,b);\n            if (m > 10.) {m=10.;break;}\n        }\n        Q.zw = Q.xy;\n        Q.xy = (p + d*m).xz;\n        Q.xy = Q.xy*.8*r.y+.5*r;\n        if (Q.z < 1.) Q.zw = Q.xy;\n    }\n    else if (U.x < 3. && U.y < 3.) Q = vec4(0);\n    \n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 259,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer02.png"
                    }
                ],
                "name": "Buffer D",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 260
                    }
                ],
                "type": "buffer"
            }
        ],
        "ver": "0.1"
    }
}