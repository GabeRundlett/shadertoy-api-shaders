{
    "Shader": {
        "info": {
            "date": "1630956615",
            "description": "sRGB to CIELab D65 and CIELab D65 to sRGB conversions.",
            "flags": 32,
            "hasliked": 0,
            "id": "ssGGRR",
            "likes": 3,
            "name": "CIELab D65 roundtrip",
            "published": 3,
            "tags": [
                "color",
                "cielab",
                "ciexyz"
            ],
            "usePreview": 0,
            "username": "miyaokamarina",
            "viewed": 262
        },
        "renderpass": [
            {
                "code": "void mainImage(out vec4 col, in vec2 pos) {\n    col = texture(in0, pos / res);\n\n    vec3 tmp = col.rgb;\n\n    tmp = srgb_to_lrgb(tmp);\n    tmp = rgb_to_xyz(tmp);\n    tmp = xyz_to_lab(tmp);\n    tmp = lab_to_xyz(tmp);\n    tmp = xyz_to_rgb(tmp);\n    tmp = lrgb_to_srgb(tmp);\n\n    col.rgb = tmp;\n}\n",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 257,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer00.png"
                    }
                ],
                "name": "Image",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 37
                    }
                ],
                "type": "image"
            },
            {
                "code": "#define PI2  6.283185307179586\n\n#define D    0.206896558 // δ\n#define D23  0.128418549 // 3δ²\n#define ID23 7.7870368   // 1 / 3δ²\n#define D3   0.008856452 // δ³\n#define C    0.13793103  // 4 / 29\n\n#define cbrt(x) pow(x, vec3(0.33333333))\n#define cube(x) (x * x * x)\n\nconst mat3 RGB_TO_XYZ = mat3(\n    0.4124, 0.3576, 0.1805,\n    0.2126, 0.7152, 0.0722,\n    0.0193, 0.1192, 0.95050\n);\n\nconst mat3 XYZ_TO_RGB = mat3(\n    +3.2406, -1.5372, -0.4986,\n    -0.9689, +1.8758, +0.0415,\n    +0.0557, -0.2040, +1.0570\n);\n\nvec2 ratio_fix(vec2 res) {\n    float rmax  = max(res.x, res.y);\n    float rmin  = min(res.x, res.y);\n    float ratio = rmax / rmin;\n    float fx    = mix(1.0, ratio, res.x > res.y);\n    float fy    = mix(1.0, ratio, res.y > res.x);\n\n    return vec2(fx, fy);\n}\n\n//=============================================//\n//=  RGB → XYZ                                =//\n//=  XYZ → RGB                                =//\n//=                                           =//\n//=  Ref: https://en.wikipedia.org/wiki/SRGB  =//\n//=============================================//\n\n// srgb to linear rgb\nvec3 srgb_to_lrgb(vec3 c) {\n    return mix(\n        pow((c + 0.055) * 0.94786727, vec3(2.4)),\n        c * 0.07739938,\n        lessThanEqual(c, vec3(0.04045))\n    );\n}\n\n// linear rgb to srgb\nvec3 lrgb_to_srgb(vec3 c) {\n    return mix(\n        1.055 * pow(c, vec3(0.41666666)) - 0.055,\n        12.29 * c,\n        lessThanEqual(c, vec3(0.0031308))\n    );\n}\n\nvec3 rgb_to_xyz(vec3 rgb) {\n    return srgb_to_lrgb(rgb) * RGB_TO_XYZ;\n}\n\nvec3 xyz_to_rgb(vec3 xyz) {\n    return lrgb_to_srgb(xyz * XYZ_TO_RGB);\n}\n\n//===========================================================//\n//=  XYZ → LAB                                              =//\n//=  LAB → XYZ                                              =//\n//=                                                         =//\n//=  Ref: https://en.wikipedia.org/wiki/CIELAB_color_space  =//\n//===========================================================//\n\n// f(t)\nvec3 lab_f(vec3 t) {\n    return mix(\n        t * ID23 + C,\n        cbrt(t),\n        greaterThan(t, vec3(D3))\n    );\n}\n\n// f⁻¹(t)\nvec3 lab_g(vec3 t) {\n    return mix(\n        D23 * (t - C),\n        cube(t),\n        greaterThan(t, vec3(D))\n    );\n}\n\nvec3 xyz_to_lab(vec3 xyz) {\n    xyz *= vec3(1.05207785, 1.0, 0.9182736);\n    xyz  = lab_f(xyz);\n\n    return vec3(\n        116.0 * xyz.y - 16.0,\n        500.0 * (xyz.x - xyz.y),\n        200.0 * (xyz.y - xyz.z)\n    );\n}\n\nvec3 lab_to_xyz(vec3 lab) {\n    lab.x += 16.0;\n    lab   *= vec3(0.0086206896, 0.002, 0.005);\n    lab    = vec3(lab.x + lab.y, lab.x, lab.x - lab.z);\n    lab    = lab_g(lab);\n    lab   *= vec3(0.9505, 1.0000, 1.0890);\n\n    return lab;\n}\n\nvec4 rgb_to_lab(vec4 rgb) {\n    rgb.xyz  = rgb_to_xyz(rgb.rgb);\n    rgb.xyz  = xyz_to_lab(rgb.xyz);\n    rgb.xyz *= vec3(0.01, 0.0078125, 0.0078125);\n\n    return rgb;\n}\n\nvec4 lab_to_rgb(vec4 lab) {\n    lab.xyz *= vec3(100, 128, 128);\n    lab.xyz  = lab_to_xyz(lab.xyz);\n    lab.xyz  = xyz_to_rgb(lab.xyz);\n\n    return lab;\n}\n\nvec3 hsluv(float h, float s, float l) {\n    const float[6] N = float[6](\n        /* [1, 1] :: 632260 * M[2] - 126452 * M[1] */ -120846.0,\n        /* [1, 2] :: 284517 * M[0] -  94839 * M[2] */ 969398.0,\n        /* [2, 1] :: 632260 * M[5] - 126452 * M[4] */ -210946.0,\n        /* [2, 2] :: 284517 * M[3] -  94839 * M[5] */ -279707.0,\n        /* [3, 1] :: 632260 * M[8] - 126452 * M[7] */ 694074.0,\n        /* [3, 2] :: 284517 * M[6] -  94839 * M[8] */ -84414.0\n    );\n\n    float hsin = sin(h);\n    float hcos = cos(h);\n\n    float a = l + 16.0;\n    float r;\n    float g;\n    float b = a * 0.0086206896;\n\n    float c;\n    float d;\n    float e = 769860.0 * l;\n\n    int i;\n\n    a = cube(a) / 1560896.0;  //                            a is sub1\n    a = mix(l / 903.0, a, a > 0.01); //                     a is sub2\n\n    h = 3.402823466e+38;          //                        h is cmax\n\n    for (; i < 6; ) {\n        r = N[i++] * a;\n        g = N[i++] * a * hcos;\n\n        c = e * a / (r * hsin - g); //                      c is length\n        h = mix(h, min(h, c), c >= 0.0); //                 h is cmax\n\n        c = e * (a - 1.0) / ((r + 126452.0) * hsin - g); // c is length\n        h = mix(h, min(h, c), c >= 0.0); //                 h is cmax\n    }\n\n    h = h * 0.01 * s / (13.0 * l); //                       h is c / (13 * l)\n\n    s = hcos * h + 0.19783; //                              s is varU\n    h = 1.0 / (hsin * h + 0.4683); //                       h is 1 / varV\n\n    l = mix(cube(b), l / 903.0, l <= 8.0); //               l is y\n    s = 9.0 * l * h * s * 0.25; //                          s is x\n    h = 3.0 * l * h - s * 0.33333333 - 5.0 * l; //          h is z\n\n    return xyz_to_rgb(vec3(s, l, h));\n}\n\n#define res iResolution.xy\n#define in0 iChannel0\n",
                "description": "",
                "inputs": [],
                "name": "Common",
                "outputs": [],
                "type": "common"
            },
            {
                "code": "//==============//\n//= Test image =//\n//==============//\n\n#define MANDELBROT_ITERATIONS 180\n\n//= Mandelbrot escape time function =//\nfloat escape_time(vec2 xy) {\n    vec2 t;\n    vec2 u;\n\n    for(int i; i < MANDELBROT_ITERATIONS; i++) {\n        t.y = 2.0 * t.x * t.y + xy.y;\n        t.x = u.x - u.y + xy.x;\n        u = t * t;\n\n        if (u.x + u.y > 4.0) return float(i) * 0.01;\n    }\n\n    return 0.0;\n}\n\nvoid mainImage(out vec4 col, in vec2 pos) {\n    vec2 fix = ratio_fix(res); // Calculate aspect ratio fix.\n\n    vec2 xy = pos;\n    vec2 uv = pos / res;\n\n    xy /= res;       //          Normalize ccordinates.\n    xy *= fix;       //          Fix aspect ratio.\n    xy -= fix * 0.5; //          Center origin.\n\n    xy -= vec2(+3.0, -0.3); //   Move origin.\n    xy *= 0.5; //                Scale origin (less is deeper).\n\n    float t = escape_time(xy);\n\n    col  = vec4(hsluv(uv.y * 0.74 * PI2, 100.0, pow(t, 0.5) * 100.0), 1);\n}\n",
                "description": "",
                "inputs": [],
                "name": "Buffer A",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 257
                    }
                ],
                "type": "buffer"
            }
        ],
        "ver": "0.1"
    }
}