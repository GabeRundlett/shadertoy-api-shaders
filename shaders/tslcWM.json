{
    "Shader": {
        "info": {
            "date": "1584946654",
            "description": " it's not perfect, but hey rasterization of a buttload of triangles in shadertoy :D\n\n",
            "flags": 32,
            "hasliked": 0,
            "id": "tslcWM",
            "likes": 10,
            "name": "JFA Rasterization",
            "published": 3,
            "tags": [
                "rasterization",
                "jfa"
            ],
            "usePreview": 0,
            "username": "wyatt",
            "viewed": 604
        },
        "renderpass": [
            {
                "code": "// Fork of \"JFA Triangles\" by wyatt. https://shadertoy.com/view/WsscWN\n// 2020-03-23 06:23:32\n\n// Fork of \"JFA Caustic\" by wyatt. https://shadertoy.com/view/wdsyDH\n// 2020-03-21 19:07:23\nvec4 fractal (vec2 U) {\n\tU = 4.*U-2.+vec2(.5,-.3);\n    vec2 z = U;\n    for (float i = 0.; i < 20.;i++) {\n    \tz = vec2(z.x*z.x-z.y*z.y,2.*z.x*z.y)-U;\n        if (length(z)>4.) return 0.5+0.5*sin(vec4(1,2,3,4)+.1*i);\n    }\n    return vec4(1);\n        \n}\nvec3 norm (float i) {\n\tvec2 u = unpack(i);\n    vec4\n        q = A(shape(u)),\n        n = A(shape(u+vec2(0,O.y))),\n        e = A(shape(u+vec2(O.x,0))),\n        s = A(shape(u-vec2(0,O.y))),\n        w = A(shape(u-vec2(O.x,0)));\n    return normalize(vec3(\n        length(e-q)-length(w-q),\n        length(n-q)-length(s-q),\n        1\n    ));\n}\nvec3 color (float i) {\n    vec2 u = unpack(i);\n\treturn vec3(u/R,1);\n}\nvec4 Qout (vec2 u) {\n    vec2 U = gl_FragCoord.xy;\n    vec4 Q = vec4(0);\n\tvec4 b = B(u);\n    vec3 a = P(b.x).xyz;\n    vec3 aa = P(b.y).xyz;\n    vec3 aaa = P(b.z).xyz;\n    vec3 c = color(b.x);\n    vec3 cc = color(b.y);\n    vec3 ccc = color(b.z);\n    \n    vec3 n = norm(b.x);\n    vec3 nn = norm(b.y);\n    vec3 nnn = norm(b.z);\n    vec3 by = bary(U,a.xy,aa.xy,aaa.xy);\n    Q.xyz = (by.x*c+by.y*cc+by.z*ccc);\n    Q = fractal(Q.xy);\n    Q.xyz *= 0.5+0.5*(by.x*n+by.y*nn+by.z*nnn).x;\n    if (triangle(U,b)>1.) Q = 0.5+0.1*D(U);\n    Q.w = 1.;\n    return Q;\n}\nMain {\n    Q  = Qout(unpack(C(U).w));\n    \n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 257,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "repeat"
                        },
                        "src": "/media/previz/buffer00.png"
                    },
                    {
                        "channel": 1,
                        "ctype": "buffer",
                        "id": 258,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "repeat"
                        },
                        "src": "/media/previz/buffer01.png"
                    },
                    {
                        "channel": 2,
                        "ctype": "buffer",
                        "id": 259,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "repeat"
                        },
                        "src": "/media/previz/buffer02.png"
                    },
                    {
                        "channel": 3,
                        "ctype": "buffer",
                        "id": 260,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "repeat"
                        },
                        "src": "/media/previz/buffer03.png"
                    }
                ],
                "name": "Image",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 37
                    }
                ],
                "type": "image"
            },
            {
                "code": "#define R iResolution.xy\n#define A(U) texelFetch(iChannel0,ivec2(mod((U),R)),0)\n#define B(U) texelFetch(iChannel1,ivec2(mod((U),R)),0)\n#define C(U) texelFetch(iChannel2,ivec2(mod((U),R)),0)\n#define D(U) texelFetch(iChannel3,ivec2(mod((U),R)),0)\n#define Main void mainImage (out vec4 Q, vec2 U) \n#define Init if (iFrame < 1) \n#define Border if (U.x<1.||R.x-U.x<1.||U.y<1.||R.y-U.y<1.)\n#define T(U) A((U)-dt*A(U).xy)\n#define NeighborhoodT vec4 n = T(U+vec2(0,1)), e = T(U+vec2(1,0)), s = T(U-vec2(0,1)), w = T(U-vec2(1,0)), m = 0.25*(n+e+s+w);\n#define Neighborhood vec4 n = A(U+vec2(0,1)), e = A(U+vec2(1,0)), s = A(U-vec2(0,1)), w = A(U-vec2(1,0)), m = 0.25*(n+e+s+w);\n#define grd 0.25*vec2(e.z-w.z,n.z-s.z)\n#define div 0.25*(e.x-w.x+n.y-s.y)\n#define ro(a) mat2(cos(a),sin(-a),sin(a),cos(a))\n#define I 11\n#define O vec2(6.,3.)\n#define pi2 6.28318530718\n//#define shape(U) round(mod((U),R)/O)*O\n#define shape(U) (round(clamp((U),vec2(30),R-vec2(30,5))/O)*O)\n\n//Dave H :\nvec3 hash33(vec3 p3)\n{\n\tp3 = fract(p3 * vec3(.1031, .1030, .0973));\n    p3 += dot(p3, p3.yxz+33.33);\n    return fract((p3.xxy + p3.yxx)*p3.zyx);\n}\nfloat pie (vec2 p, vec2 a, vec2 b) {\n\tvec2 m = 0.5*(a+b); // midpoint\n    if (length(a-b)<1e-3) return 1e3; // ignore self\n\treturn abs(dot(p-m,b-m)/dot(b-m,b-m)); // pojection\n} \nfloat sg (vec2 p, vec2 a, vec2 b) {\n    float i = clamp(dot(p-a,b-a)/dot(b-a,b-a),0.,1.);\n\treturn (length(p-a-(b-a)*i));\n}\nvec2 cc (vec2 a, vec2 b, vec2 c) {\n    vec2 ab = 0.5*(a+b), ac = 0.5*(a+c);\n\tfloat m1 = (a.x-b.x)/(b.y-a.y), m2 = (a.x-c.x)/(c.y-a.y);\n    float b1 = ab.y-m1*ab.x, b2 = ac.y-m2*ac.x;\n    float x = (b1-b2)/(m2-m1);\n    return vec2(x,m1*x+b1);\n}\n\nfloat ssg (vec2 p, vec2 a, vec2 b) {\n    float i = clamp(dot(p-a,b-a)/dot(b-a,b-a),0.,1.);\n\treturn sign(dot(p-a,(b-a).yx*vec2(1,-1)))*length(p-a-(b-a)*i);\n}\nfloat tri (vec2 U, vec4 a, vec4 aa, vec4 aaa) {\n    if (length(a.xy-aaa.xy)<1e-3||length(aa.xy-aaa.xy)<1e-3||length(a.xy-aa.xy)<1e-3) return 1e3;\n    float ab = ssg(U,a.xy,aa.xy),\n          bc = ssg(U,aa.xy,aaa.xy),\n          ca = ssg(U,aaa.xy,a.xy),\n          l = min(abs(ab),min(abs(bc),abs(ca))),\n          s = (ab<0.&&bc<0.&&ca<0.)||(ab>0.&&bc>0.&&ca>0.)?-1.:1.;\n\tif (s*l>=0.) return l*s;\n   \tab=abs(ab)*sg(aaa.xy,a.xy,aa.xy);\n    bc=abs(bc)*sg(a.xy,aa.xy,aaa.xy);\n    ca=abs(ca)*sg(aa.xy,aaa.xy,a.xy);\n    float depth = -(ab*aaa.z+bc*a.z+ca*aa.z);\n    return depth;\n}\n#define F(rr,l,ll) (7e-2*(rr)/(l)*((l)-(ll))*exp(-.02*(ll)))\nvec3 bary (vec2 p, vec2 a, vec2 aa, vec2 aaa) {\n    return vec3(\n        sg(p,aa,aaa)/sg(a,aa,aaa),\n        sg(p,aaa,a)/sg(aa,aaa,a),\n    \tsg(p,a,aa)/sg(aaa,a,aa)\n    );\n}\n//#define pack(u) float(packUnorm2x16((u).xy/R))\n//#define unpack(i) (unpackUnorm2x16(uint(i))*R)\n#define pack(u) ((u).x+(u).y*R.x)\n#define unpack(i) vec2(mod((i),R.x),(i)/R.x)\n#define get(i) A(unpack(i))\n#define perspect(q) vec4((q.xy-0.5*R)*2./(3.+q.z/R.y)+0.5*R,R.x-q.z,1)\n#define P(i) perspect(get(i))\n#define triangle(U,w) tri((U), P((w).x), P((w).y),P((w).z))\n",
                "description": "",
                "inputs": [],
                "name": "Common",
                "outputs": [],
                "type": "common"
            },
            {
                "code": "vec3 force (vec2 U, vec2 r, vec4 q) {\n\tvec2 v = shape(U+O*r);\n    vec4 n = A(v);\n    vec3 rr = n.xyz-q.xyz;\n    float l = length(rr);\n    float ll = length(v-U);\n    if (l>0.)\n        return F(rr,l,ll);\n    return vec3(0);\n}\nMain {\n    \n    Q = A(U);\n    vec4 q = Q;\n    for (int x = -5; x<=5; x++) {\n        Q.xyz += force(U,vec2(x,0),q);\n        Q.xyz += force(U,vec2(0,x),q);\n    }\n    Q += D(U);\n    Init Q = vec4(shape(U),0,1);\n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 257,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "repeat"
                        },
                        "src": "/media/previz/buffer00.png"
                    },
                    {
                        "channel": 3,
                        "ctype": "buffer",
                        "id": 260,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer03.png"
                    }
                ],
                "name": "Buffer A",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 257
                    }
                ],
                "type": "buffer"
            },
            {
                "code": "Main {\n    if (iFrame<1) {\n      \t\n        vec2 o = O;\n        int z = int(U.x+R.x*U.y)%7;\n        if (z==1||z==3) o = -o;\n        vec2 a = shape(U);\n        vec2 aa = shape(U+vec2(o.x,0));\n        vec2 aaa = shape(U+vec2(0,o.y));\n        Q = vec4(\n            pack(a.xy),\n            pack(aa.xy),\n            pack(aaa.xy),\n            1\n        );\n        \n        \n    } else Q = B(U);\n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 257,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "repeat"
                        },
                        "src": "/media/previz/buffer00.png"
                    },
                    {
                        "channel": 1,
                        "ctype": "buffer",
                        "id": 258,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "repeat"
                        },
                        "src": "/media/previz/buffer01.png"
                    }
                ],
                "name": "Buffer B",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 258
                    }
                ],
                "type": "buffer"
            },
            {
                "code": "// Hierarchical Sort\nvoid comp (inout vec4 Q, inout vec4 r, float l, float i) {\n\tif (l<r.x) {\n        Q.yz = Q.xy;\n        r.yz = r.xy;\n        Q.x = i;\n        r.x = l;\n    } else if (l<r.y&&l>r.x) {\n        Q.z = Q.y;\n        r.z = r.y;\n        Q.y = i;\n        r.y = l;\n    } else if (l<r.z&&l>r.y) {\n        Q.z = i;\n        r.z = l;\n    }\n}\nvoid X (inout vec4 Q, inout vec4 r, vec2 U, vec2 u) {\n        vec4 b,c;float l,i;\n        if (iFrame%I==0) {\n            i = pack(U+u); \n            b = B(U+u);\n            l = triangle(U,b);\n            comp(Q,r,l,i);\n            i = Q.w; \n            b = B(unpack(Q.w));\n            l = triangle(U,b);\n            comp(Q,r,l,i);\n        } else {\n            c = C(U+u);\n            b = B(unpack(c.x));\n            i = c.x;\n            l = triangle(U,b);\n            comp(Q,r,l,i);\n            b = B(unpack(c.y));\n            i = c.y;\n            l = triangle(U,b);\n            comp(Q,r,l,i);\n            b = B(unpack(c.z));\n            i = c.z;\n            l = triangle(U,b);\n            comp(Q,r,l,i);\n        }\n    \t\n}\nvoid Y(inout vec4 Q, inout vec4 r, vec2 U, vec2 u) {\n\tfloat i, l; vec4 c, b;\n    c = C(U+u);\n    b = B(unpack(c.x));\n    i = c.x;\n    l = triangle(U,b);\n    if (l<r.w) {\n    \tr.w = l;\n        Q.w = i;\n    }\n    b = B(unpack(c.w));\n    i = c.w;\n    l = triangle(U,b);\n    if (l<r.w) {\n    \tr.w = l;\n        Q.w = i;\n    }\n    \n}\nMain {\n    Q = C(U);\n    vec4 r = vec4(\n        triangle(U,B(unpack(Q.x))),\n        triangle(U,B(unpack(Q.y))),\n        triangle(U,B(unpack(Q.z))),\n        triangle(U,B(unpack(Q.w)))\n    );\n    if ((iFrame+int(U.x+R.x*U.y))%2==0&&iFrame%I==0) {\n    \tQ = vec4(1e9);\n    \tr = vec4(1e9);\n\t}\n    float k = exp2(float(-1+I-(iFrame%I)));\n    X(Q,r,U,vec2(0,k));\n    X(Q,r,U,vec2(k,0));\n    X(Q,r,U,vec2(0,-k));\n    X(Q,r,U,vec2(-k,0));\n    Y(Q,r,U,vec2(0,1));\n    Y(Q,r,U,vec2(1,0));\n    Y(Q,r,U,vec2(0,-1));\n    Y(Q,r,U,vec2(-1,0));\n    Y(Q,r,U,vec2(0,0));\n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 257,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer00.png"
                    },
                    {
                        "channel": 1,
                        "ctype": "buffer",
                        "id": 258,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "repeat"
                        },
                        "src": "/media/previz/buffer01.png"
                    },
                    {
                        "channel": 2,
                        "ctype": "buffer",
                        "id": 259,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "repeat"
                        },
                        "src": "/media/previz/buffer02.png"
                    }
                ],
                "name": "Buffer C",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 259
                    }
                ],
                "type": "buffer"
            },
            {
                "code": "vec3 force (vec2 U, vec2 r, vec4 q) {\n\tvec2 v = shape(U+O*r);\n    vec4 n = A(v);\n    vec3 rr = n.xyz-q.xyz;\n    float l = length(rr);\n    float ll = length(v-U);\n    if (l>0.)\n        return F(rr,l,ll);\n    return vec3(0);\n}\nMain {\n    U = shape(U);\n\tQ = D(U);\n    vec4 q = A(U);\n    float m = (U.y<20.*R.y)?5.:1.;\n    for (int x = -5; x<=5; x++) {\n        Q.xyz += force(U,vec2(x,0),q)/m;\n        Q.xyz += force(U,vec2(0,x),q)/m;\n    }\n    Q.y -= m*6e-3;\n    Q.xyz *= 0.999;\n    \n    if (U.y>R.y-20.) {\n        Q.xyz *= 0.5;\n    \tU = shape(U);\n    \tvec4 p = vec4(U,0,0);\n        p.x = 0.8*(p.x-0.5*R.x)+0.5*R.x;\n       p.y += 20.;\n        float a = 0.5*sin(6e-3*float(iFrame));\n        \n        p.x -= 0.5*R.x;\n        p.xz *= ro(pi2*a);\n        p.x += 0.5*R.x;\n        if (iMouse.z>0.) {\n            p.xy += iMouse.xy/R*200.-100.;\n            Q.xyz *= 0.5;\n        }\n        Q.xyz += (p.xyz-q.xyz);\n    }\n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "buffer",
                        "id": 257,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer00.png"
                    },
                    {
                        "channel": 3,
                        "ctype": "buffer",
                        "id": 260,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "clamp"
                        },
                        "src": "/media/previz/buffer03.png"
                    }
                ],
                "name": "Buffer D",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 260
                    }
                ],
                "type": "buffer"
            }
        ],
        "ver": "0.1"
    }
}