{
    "Shader": {
        "info": {
            "date": "1531290216",
            "description": "Ray cast to a cylinder example, with UV calculation. Not using SDF raymarching, use direct intersection functions.",
            "flags": 0,
            "hasliked": 0,
            "id": "4ltcRn",
            "likes": 9,
            "name": "Ray cast to a cylinder",
            "published": 3,
            "tags": [
                "ray",
                "cylinder",
                "cast",
                "match"
            ],
            "usePreview": 1,
            "username": "0xAA55",
            "viewed": 823
        },
        "renderpass": [
            {
                "code": "\nfloat PI = 3.1415926535897932384626;\nvec3 eyepos = vec3(0.0, 0.0, -5.0);\nvec2 yawpitch = vec2(0, 0);\n\nstruct cylinder_t\n{\n    vec3 p;\n\tfloat height;\n\tfloat radius;\n    mat3 r;\n};\n\nmat3 rot_x(float ang)\n{\n    float sang = sin(ang);\n    float cang = cos(ang);\n    return mat3\n    (\n        vec3(1.0, 0.0, 0.0),\n        vec3(0.0, cang,-sang),\n        vec3(0.0, sang, cang)\n    );\n}\n\nmat3 rot_y(float ang)\n{\n    float sang = sin(ang);\n    float cang = cos(ang);\n    return mat3\n    (\n        vec3( cang, 0.0, sang),\n        vec3(  0.0, 1.0, 0.0),\n        vec3(-sang, 0.0, cang)\n    );\n}\n\nmat3 rot_z(float ang)\n{\n    float sang = sin(ang);\n    float cang = cos(ang);\n    return mat3\n    (\n        vec3( cang, sang, 0.0),\n        vec3(-sang, cang, 0.0),\n        vec3(0.0, 0.0, 1.0)\n    );\n}\n\nmat3 rot_axis(vec3 v, float ang)\n{\n    float sang = sin(ang);\n    float cang = cos(ang);\n    return mat3\n    (\n        vec3\n        (\n            (1.0 - cang) * v.x * v.x + cang,\n            (1.0 - cang) * v.x * v.y - sang * v.z,\n            (1.0 - cang) * v.x * v.z + sang * v.y\n        ),\n        vec3\n        (\n            (1.0 - cang) * v.y * v.x + sang * v.z,\n            (1.0 - cang) * v.y * v.y + cang,\n            (1.0 - cang) * v.y * v.z - sang * v.x\n        ),\n        vec3\n        (\n            (1.0 - cang) * v.z * v.x - sang * v.y,\n            (1.0 - cang) * v.z * v.y + sang * v.x,\n            (1.0 - cang) * v.z * v.z + cang\n        )\n    );\n}\n    \nmat3 rot_yaw_pitch_roll(vec3 ypr)\n{\n    return rot_z(ypr.z) * rot_x(ypr.y) * rot_y(ypr.x);\n}\n\nbool cylinder_raycast(cylinder_t cylinder, vec3 orig, vec3 dir, out vec3 castpoint, out vec3 normal, out vec2 uv, out float intersect_dist, inout bool isfrominside)\n{\n\t// mat3 minv = inverse(cylinder.r);\n\tvec3 local_orig = cylinder.r * (orig - cylinder.p);\n\tvec3 local_dir = cylinder.r * dir;\n\tfloat r = cylinder.radius;\n\tfloat rsq = r * r;\n\tfloat hh = cylinder.height / 2.;\n\t\n\tbool isinside = false;\n\t\n\tfloat ray_proj = dot(-local_orig.xz, normalize(local_dir.xz));\n\tfloat orig_to_axis_dist_sq = dot(local_orig.xz, local_orig.xz);\n\tfloat axis_to_ray_sq = max(0., orig_to_axis_dist_sq - ray_proj * ray_proj);\n\tif(axis_to_ray_sq > rsq) return false;\n\tfloat foo = sqrt(rsq - axis_to_ray_sq);\n    float dist1 = ray_proj - foo;\n    float dist2 = ray_proj + foo;\n\tif(orig_to_axis_dist_sq < rsq && abs(local_orig.y) <= hh) isinside = true;\n\tif(isinside && !isfrominside) return false;\n\tif(isfrominside) intersect_dist = dist2 / length(local_dir.xz);\n\telse intersect_dist = dist1 / length(local_dir.xz);\n\t\n\tvec3 local_cast = local_orig + local_dir * intersect_dist;\n\tvec3 local_normal = vec3(local_cast.xz, 0.).xzy / r * (isfrominside ? -1.:1.);\n\t\n\tif(abs(local_cast.y) > hh)\n\t{\n\t\tfloat plane1 = (local_orig.y - hh) / (-local_dir.y);\n\t\tfloat plane2 = (local_orig.y + hh) / (-local_dir.y);\n        if(isfrominside) intersect_dist = max(plane1, plane2);\n        else intersect_dist = min(plane1, plane2);\n\t\tlocal_normal = vec3(0, -sign(local_dir.y), 0);\n\t\tlocal_cast = local_orig + local_dir * intersect_dist;\n\t\tif(length(local_cast.xz) > r) return false;\n\t\tuv = (local_cast.xz + vec2(r)) / (r * 2.);\n\t}\n\telse\n\t{\n\t\tuv.x = (atan(local_normal.z, local_normal.x) / PI) * .5 + .5;\n        uv.y = (local_cast.y + hh) / cylinder.height;\n\t}\n\t\n\tcastpoint = orig + dir * intersect_dist;\n\tnormal = local_normal * cylinder.r;\n\tisfrominside = isinside;\n\n    return true;\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n\tvec2 xy = (fragCoord.xy - iResolution.xy * .5) / iResolution.y;\n    \n    vec2 mouse_rotation = ((iMouse.xy / iResolution.y) * 2. -1.) * PI;\n    if(length(iMouse.xy) < 0.000001) mouse_rotation = vec2(0);\n    \n\tvec2 yawpitch = vec2(mouse_rotation.x, -mouse_rotation.y);\n    mat3 viewmat = rot_yaw_pitch_roll(vec3(yawpitch, 0));\n    \n    mat3 rot_m = rot_yaw_pitch_roll(vec3(iTime * .3, iTime * .2, iTime * .1));\n    \n    vec3 ray = normalize(vec3(xy, 1)) * viewmat;\n    vec3 eyepos = vec3(0., 0., -5.) * viewmat;\n    \n    vec4 color = vec4(.2, .5, 1., 1.);\n    \n    vec3 castpnt, castnormal;\n    vec2 castuv;\n    float castdist;\n    bool isfrominside = false;\n\n    cylinder_t cyl = cylinder_t(vec3(0, 0, 0), 5., 1., rot_m);\n    \n    isfrominside = false;\n    // if(xy.x > 0.)isfrominside = true;\n    if(cylinder_raycast(cyl, eyepos, ray, castpnt, castnormal, castuv, castdist, isfrominside))\n\t{\n        // color = vec4(castdist - 4.5 + sin(iTime));\n        // color = vec4(castnormal * .5 + .5, 1.);\n        color = texture(iChannel0, castuv);\n        // color = texture(iChannel0, castnormal);\n        // color = vec4(castuv, 0., 1.);\n\t}\n    \n\tfragColor = color;\n}",
                "description": "",
                "inputs": [
                    {
                        "channel": 0,
                        "ctype": "texture",
                        "id": 5,
                        "published": 1,
                        "sampler": {
                            "filter": "linear",
                            "internal": "byte",
                            "srgb": "false",
                            "vflip": "true",
                            "wrap": "repeat"
                        },
                        "src": "/media/a/8de3a3924cb95bd0e95a443fff0326c869f9d4979cd1d5b6e94e2a01f5be53e9.jpg"
                    }
                ],
                "name": "Image",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 37
                    }
                ],
                "type": "image"
            }
        ],
        "ver": "0.1"
    }
}