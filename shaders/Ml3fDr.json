{
    "Shader": {
        "info": {
            "date": "1539200122",
            "description": "//self  : https://www.shadertoy.com/view/Ml3fDr\n//parent: https://www.shadertoy.com/view/MtcfWn\n//bell  : https://www.shadertoy.com/view/llG3Ry\n\nbrought to you by the letter B, D is dor Drums, are next.",
            "flags": 8,
            "hasliked": 0,
            "id": "Ml3fDr",
            "likes": 5,
            "name": "fm bubbles and bells",
            "published": 3,
            "tags": [
                "fm",
                "fourier",
                "bell",
                "instrument",
                "dft"
            ],
            "usePreview": 0,
            "username": "ollj",
            "viewed": 640
        },
        "renderpass": [
            {
                "code": "//\"audiovisual\" tag means it uses moudular arithmetic (fourier analysis, roots of unity)\n//, or at least some sort of audio-visualization, if only a blinking lights show\n//,to use the same functions to render audio and video\n//all code is in commons tab\n\n\nvoid mainImage(out vec4 o,vec2 u){o=image(u,iMouse.xyzw,iResolution.xy,iTime);}\n//vec2 mainSound( in int samp,float t){return sound(t);}\n",
                "description": "",
                "inputs": [],
                "name": "Image",
                "outputs": [
                    {
                        "channel": 0,
                        "id": 37
                    }
                ],
                "type": "image"
            },
            {
                "code": "//\"audiovisual\" tag means it uses moudular arithmetic (fourier analysis, roots of unity)\n//, or at least some sort of audio-visualization, if only a blinking lights show\n//,to use the same functions to render audio and video\n//all code is in commons tab\n\n\n//void mainImage(out vec4 o,vec2 u){o=image(u,iMouse.xyzw,iResolution.xy,iTime);}\nvec2 mainSound( in int samp,float t){return sound(t);}\n",
                "description": "",
                "inputs": [],
                "name": "Sound",
                "outputs": [],
                "type": "sound"
            },
            {
                "code": "//self  : https://www.shadertoy.com/view/Ml3fDr\n//parent: https://www.shadertoy.com/view/MtcfWn\n//bell  : https://www.shadertoy.com/view/llG3Ry\n\n#define doReverb true\n\n//end of UI modes, start of common code:\n\n\n#define vec1 float\n#define dd(a) dot(a,a)\n#define u2(a) ((a)*2.-1.)\n#define u5(a) ((a)*.5+.5)\n#define sat(a) clamp(a,0.,1.)\n\n#define pi acos(-1.)\n#define pi2(a) (2.*pi*(a))\n#define co2p(a) cos(pi2(a))\n#define si2p(a) sin(pi2(a))\nfloat Sine(float t,float f){return si2p(f*t);}\n\n\nfloat Tri(float t){return u2(abs(fract(t)-.5)*2.);}\nfloat Saw(float t){return -u2(fract(t));}//is time reversed\n//float Tri( float t ){\treturn abs(fract( t ) * 4.0-2.0)-1.0;}\n//float Saw( float t ){\treturn fract( t ) * 2.0-1.0;}\nfloat Cos( float t ){\treturn cos( t * radians(360.0) );}\n\nfloat Square( float t ){\treturn step( fract(t), 0.5 ) * 2.0-1.0;}\n\nfloat saw_wave(float t){return fract(t)-.5;}\nfloat Squ(float t){return u2(step(fract(t),.5));}\nfloat square_wave(float t){return (fract(t)>.5) ? 0.125 : -0.1;}\n\nfloat sinsaw_wave(float t){float x=fract(t);return .5-x*x;}\nfloat sin_wave(float t){return sin(pi*2.*t);}\n\n\nstruct w11{vec1 a;vec1 b;};\nstruct w12{vec1 a;vec2 b;};\nstruct w13{vec1 a;vec3 b;};\nstruct w14{vec1 a;vec4 b;};\n\nvec3 mx(vec3 a,vec3 b,vec3 c){return mix(a,b,c);}\nvec3 mx(float a,vec3 b,vec3 c){return mix(vec3(a),b,c);}\nvec2 cs(float a){return vec2(cos(a),sin(a));}\nvec1 suv(vec4 a){return dot(vec4(1),a);}vec1 suv(vec3 a){return dot(vec3(1),a);}vec1 suv(vec2 a){return a.x+a.y;}//sum of vector\n\n\n//MdjXWc is Created by Dmitry Andreev-and'2014\n//...License Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.\n\nfloat noise1(float t, float seed){return 1.0+sin(t * 0.02 * seed+sin(t * 0.05 * seed)) * 0.25;}\n\n// Hash from https://www.shadertoy.com/view/4djSRW\nvec2 hash2(vec2 p\n){p  = fract(p * vec2(5.3983, 5.4427));\n    p += dot(p.yx, p.xy+ vec2(21.5351, 14.3137));\n    return fract(vec2(p.x * p.y * 95.4337, p.x * p.y * 97.597));}\n\nvec2 noise2(float t){return hash2(vec2(t, t * 1.423)) * 2.0-1.0;}\n\n\n//https://www.shadertoy.com/view/MdjXWc\nfloat remap(float l, float h, float x){return clamp((x-l) / (h-l), 0.0, 1.0);}\n\n\nfloat dumbSequence(float t){return floor(fract(t*(sqrt(5.)*.5+.5))*8.);}\n\n\n//rgba colorspace matrices\n#define ab012(a,b)(a+b*vec3(0,1,2))//desaturation.rgb kernel;b scales offset\n//rainbow*()ro from purple to purple for range[0..1],this makes ab012()desaturate into semi-gaussian scattering.\nvec3 rainbow(float a,float b){return u5(cos(2.*pi*ab012(a,b)));}//sine rainbow with offsets,desaturates colors for small b\nvec3 rainbow2(float a,float b){return abs(u2(fract(ab012(a,b))));}//triangle rainbow with offsets,desaturates colors for small b\nvec3 rainbow(float a){return rainbow(a,1./3.);}\nvec3 rainbow2(float a){return rainbow2(a,1./3.);}\n#define ToRgb(a) return c.z*mix(vec3(1.),sat(a(-c.x)),c.y);}\nvec3 angleToColor(vec3 c){ToRgb(rainbow)//cos-mix\n//vec3 hsv2rgb(vec3 c){ToRgb(rainbow2)//linear-mix not identical to the below, but close\nvec3 hsv2rgb(const vec3 c){return c.z*mix(vec3(1.),sat(abs(fract(c.x+vec3(3,2,1)/3.)*6.-3.)-1.),c.y);}\nvec3 rgb2hsv(vec3 a){vec4 K=vec4(0,-1,2,-3)/3.//https://www.shadertoy.com/view/MdGfWm\n ;vec4 P=mix(vec4(a.bg,K.wz),vec4(a.gb,K.xy),step(a.b,a.g));vec4 Q=mix(vec4(P.xyw,a.r),vec4(a.r,P.yzx),step(P.x,a.r))\n ;float D=Q.x-min(Q.w,Q.y),E=1e-10;return vec3(abs(Q.z+(Q.w-Q.y)/(6.*D+E)),D/(Q.x+E),Q.x);}\n//vec3 HsvToRgb(vec3 c){vec3 p;p=abs(fract(c.xxx+vec3(3,2,1)/3.)*6.-3.);return c.z*mix(vec3(1),sat(p-1.),c.y);}\n//general [Poeter-Duff] \"Compositing Digital Images\" siggraph 1984;\n//https://en.wikipedia.org/wiki/Alpha_compositing\n//https://doc.qt.io/archives/qq/qq17-compositionmodes.html \n//#define pdC(a,b,c,d,m,f)mix(a,b,m.w)*c*d*f+pdCx(a,b,c,d,m)\nvec3 pdC(vec3 a,vec3 b,float c,float d,vec4 m,float f){return mix(a,b,m.w)*f*c*d+b*m.z*(1.-c)+a*m.y*(1.-d);}//many contextual simplifications possible.\n#define pdA(c,d,m)suv(m*vec3(c*d,c*(1.-d),d*(1.-c)))\n//#define pdA(c,d,m)m.x*c*d+m.y*c*(1.-d)+m.z*d*(1.-c)\n//xor case is simpler,likely worth making it a subroutine of pdC;\n//#define pdCx(a,b,c,d,m)m.y*a*(1.-d)+m.z*b*(1.-c)\n//vec3 pdCx(vec3 a,vec3 b,float c,float d){return a*d+b*c;}\nvec4 pd(vec4 a,vec4 b,vec4 m,float f){\n vec4 r=vec4(pdC(a.rgb,b.rgb,a.w,b.w,m,f),1);//ceneral case color\n r.w=pdA(a.w,b.w,m.rgb);//general case alpha is sometimes neglible.\n return r;}\n//return a*a.w+b*b.w*(1.-a.w);//general case reduction shortcut\nvec4 sOver(vec4 a,vec4 b){return pd(a,b,vec4(1,1,1,0),1.);}\nvec4 sAtop(vec4 a,vec4 b){return pd(a,b,vec4(1,0,1,0),1.);}\nvec4 sIn (vec4 a,vec4 b){return pd(a,b,vec4(1,0,0,1),1.);}\nvec4 sXor(vec4 a,vec4 b){return pd(a,b,vec4(0,1,1,1),0.);}\nvec4 sOut(vec4 a,vec4 b){return pd(a,b,vec4(0,0,1,0),0.);}\nvec4 sCut(vec4 a,vec4 b){return pd(a,b,vec4(0,0,1,1),0.);}\n\n\n\n\n//https://www.shadertoy.com/view/MdjXWc\nvec2 lpnoise(float t, float fq//FM lp-noise for reverb\n){t*=fq\n ;float f=fract(t)\n ;vec2 r=floor(t-f+vec2(0,1))/fq\n ;f=smoothstep(0.,1.,f)//;f=step(f,0.)//harder and faster\n ;return mix(noise2(r.x),noise2(r.y),f);}\n\n                        \n//https://www.shadertoy.com/view/MdjXWc\nvec2 synthWave(float t\n){bool do_reverb = mod(t, 8.0) > 4.0\n ;float m = mod(t, 2.0)\n ;vec2 f=cs(t-m)\n ;float f0 =220.*cos(t-m)+880.//FM over time makes it easier to debug timing.\n ;f0+=cos(2.*t)*440.\n     // this cos()  illustrates the reverb in the dft(), as cos() breaks some symmetry ofer time.\n ;vec2 w = vec2(co2p(m * f0) * exp(-m * 2.5))\n #ifdef doReverb\n ;vec2 r=lpnoise(m, 100.)\n        +lpnoise(m, 550.)*.2\n        +lpnoise(m,1050.)*.1*exp(-t*5.)//3 octaves of overtones.\n ;float a=exp(-m*2.)//exponential falloff for reverb\n ;w+=(co2p(m*f0+r*.1)-co2p(m*f0))*a//differential of 2 offset samples. pigmentation-interferrence.\n #endif\n ;w*=1.-exp(-m*800.)//instrument falloff hull\n ;return w;}\n\n\n\nfloat rand(float a){return fract(sin(a) * 43758.5453123);}\nfloat noise(float a){return sin(mix(rand(floor(a)),rand(floor(a+1.)),fract(a)));}\nfloat fbm(float a\n){float s=0.\n ;for (float i=1.;i<5.;i++\n ){s+=noise(a)/i\n  ;a*=2.\n  ;}return s;}\n\n\nfloat fourier(float a){return .25*sin(a)+.25*sin(2.*a+.2)+.5*sin(4.*a+.3);}\nvec2 teslaCoil( float t//https://www.shadertoy.com/view/4lcXDM\n){float m=mod(t,15.)\n ;if (m<3.)return vec2(0)\n ;return vec2(4.*fourier(400.*t)// base wave\n *pow(fbm(20.*noise(40.*t)*t) //amplitude modulation\n ,2.))\n ;}\n\n    \n\n// converts a MIDI note number to a frequency\n// <http://en.wikipedia.org/wiki/MIDI_Tuning_Standard>\nfloat midi_freq(int m){return 440.*pow(2.,float(m-69)/12.);}\n\nfloat wav(float hz, float dB,float time\n){return 20.*pow(10.,dB/10.)*(pow(sin(pi*hz*time), 2.)-.5);}\n\n//ldlSD2 is band limited waves are less hurting, Written by Alan Wolfe\n//http://demofox.org/\n//http://blog.demofox.org/\n//http://blog.demofox.org/2012/06/18/diy-synth-3-sampling-mixing-and-band-limited-wave-forms/\n\n\n// the frequency of the tone\n#define TONE_FREQUENCY \t440.+(cos(t*0.61))*u5(-cos(t*3.61))*2.\n//the waveform refreshes every fpsWave-frames, because 60 fps flickers too much oif there is any aperiodic phase shift.\n#define fpsWave 7.\n// how long each tone plays, in seconds\n#define TONE_LENGTH 2.\n// how long to fade in and out each wave form\n#define epsEnv  (TONE_LENGTH*.3)\n// how many harmonics (sine waves) for each bandlimited wave form\n#define NUM_HARMONICS_SQU \t11.\n#define NUM_HARMONICS_SAW \t9.\n#define NUM_HARMONICS_TRI\t3.\n//https://www.shadertoy.com/view/ldlSD2\n//band limited waves are less hurting\n#define iterSawBL(t,i) sin(pi*2.*t*(i+1.))/(i+1.)\n#define iterSquBL2(t,i) sin(pi*2.*t*i)/i\n#define iterSquBL(t,i) iterSquBL2(t,(i*2.+1.))\n#define iterTriBl2(t,h,i) (sin(pi*2.*(t-.25)*h)*(mod(i,2.)*2.-1.)/(h*h))\n#define iterTriBl(t,i)  iterTriBl2(t,(i*2.+1.),i)   \n#define endTriBl 8./pi/pi\n#define endSawBl 2./pi\n#define endSquBl 4./pi*0.9\n// the 0.9 shouldn't be needed, but for some reason the amplitude seems wrong without it...                 \n#define blEnd(a,b,c) {float v=0.;for (float i= 0.; i < a; ++i){v+=b(t,i);}return v*c;}\nfloat SawBL(float t)blEnd(NUM_HARMONICS_SAW,iterSawBL,endSawBl)\nfloat SquBL(float t)blEnd(NUM_HARMONICS_SQU,iterSquBL,endSquBl)\nfloat TriBL(float t)blEnd(NUM_HARMONICS_TRI,iterTriBl,endTriBl)\n\nfloat BandMix(float t\n){float m=mod(t,TONE_LENGTH)\n ;float e =1.\n ;     if(m<epsEnv)              e=m/epsEnv\n ;else if(m>(TONE_LENGTH-epsEnv))e=1.-((m-(TONE_LENGTH-epsEnv))/epsEnv)  \n //above envelope [e] figured out how much to scale the volume to account for envelope\n //on the front and back of each wave form\n;m=mod(t / TONE_LENGTH, 6.0) // play the apropriate wave form based on time \n;//m=3.2;\n;t*=TONE_FREQUENCY\n;if     (m>5.)return e*SquBL(t) \n;else if(m>4.)return e*Squ  (t) \n;else if(m>3.)return e*SawBL   (t) \n;else if(m>2.)return e*Saw(t) \n;else if(m>1.)return e*TriBL(t) \n;else         return e*Tri(t)\n;}\n\nvec2 bandLimit_ldlSD2(float t){return vec2( BandMix(t));}\n    \n//https://www.shadertoy.com/view/llG3Ry\nfloat TAU = acos(-1.)*2.;\nfloat TWOTAU = acos(-1.)*4.;\nvec2 bell(float t,float f\n){t=fract(t)\n ;return vec2(sin(dot(TWOTAU,TAU)*f*t)*exp(-3.0*t) );} \n                       \n     \n//https://www.shadertoy.com/view/lstXR8\nfloat bx_cos(float a){return clamp(abs(mod(a,8.0)-4.0)-2.0,-1.0,1.0);}\nfloat tx_cos(float a){return abs(mod(a,4.0)-2.0)-1.0;}\n#define Cos tx_cos\nvec2 bellSqua(float t//cosine bell with overtone loop and a tripple canon modulo sequence without harmony.\n){float f=floor(t*2.)\n ;float n=dumbSequence(f)+dumbSequence(f*2.61+1.)+dumbSequence(f*3.61+2.)\n ;float o=0.,a=t*660.,r=1.,scale=n//step site for overtone loop.\n ;for(int i=0;i<5;i++//overtones\n ){o+=Cos(a)*r\n  ;a*=scale;r/=scale\n  ;a+=Cos(t*60.)*.01;}\n ;float bt=fract(t*2.);\n ;o*=clamp(bt*100.,0.,0.5)*(1.-bt)\n ;o=clamp(o,-1.0,1.0)\n ;return vec2(o);}                     \n                          \n                          \n\n                          \n\n\n\n                          \n//https://www.shadertoy.com/view/4djSzR\n//lava bubbles = chaos*Hull\nfloat bubbles(float t, float p, float l, float ff//time,period,length\n){float c=floor(t/p)*p//this is NOT mod, but its semi-inverse\n ;t-=c+u5(sin(c*12.))*p*.8//interestring time folding!\n ;return \n //step(-.2,cos(c*199.0*l))//more code for less bubbles, seems like a dumb approach\n sin(ff*(5000.+cos(c*70.)*2000.)*(t+.1)*t)//lots of pingpong lines\n *(smoothstep(.0,.07*l,t)-smoothstep(.1*l,.2*l,t))//and a basic dumb hull\n ;}\n\nvec2 bubbles2(float t\n){vec3 p=1./(vec3(1,2,3)+.61)\n// ;return vec2(.9*bubbles(t   ,p.x,1.2,1.)\n //            +.1*bubbles(t+1.,p.y,.5,2.)\n  //           +.5*bubbles(t+2.,p.z,.7,1.))*.75;}//hard params here\n ;return vec2(0.9*bubbles(t,2.0,1.2,1.0)\n             +0.1*bubbles(t,0.5,0.5,2.0)\n             +0.2*bubbles(t,0.2,0.2,2.0))*0.75;}\n                          \n                          \n                          \n                          \n                          \nvec2 sound(float t//entry point for mainSound( in int samp,) and dft()\n){float f=fract(t)\n ;vec2 c=bubbles2(t)\n ;c+=bellSqua(t)\n ;c+=bell(t,220.-cos(f-t)*110.)\n ;return bandLimit_ldlSD2(t)\n ;//return AlienHum(t)//delayed, too complex sequence and way too many octaves in instrument crash it!\n ;//return teslaCoil(t)\n ;return c\n ;return synthWave(t)\n ;return vec2(co2p(440.*t)*exp(-3.0*t))// A 440 Hz wave that attenuates quickly overt time\n ;}\n//vec2 mainSound( in int samp,float t){return sound(t);}\n\nvec2 dft(vec2 u,float gt//Fourier Transform https://www.shadertoy.com/view/MdjXWc\n){float v=256.\n ;float n=min(v,256.)\n ;vec2 c=cs(pi2(floor(u.y*n*.5)/n))\n ;vec2 d=vec2(1,0)\n ;vec2 f=vec2(0)\n ;for(float i=0.;i<n;i++\n ){float x=float(i)/n  \n  ;float t=x*.05+gt\n  ;vec2  w=sound(t)//the dft() function calls the same sound() function that mainSound( in int samp,) calls.\n  ;float v=(w.x+w.y)*.5\n  ;v*=.5*(1.-co2p(x))   // Hann window-function\n  ;f+=d*v\n  ;d=d.xy*c.x+vec2(-1,1)*d.yx*c.y;\n ;}return f;}\n\n#define biject(u,s1,s2, t1, t2) mix(t1,t2,(u)/(s2-(s1)))                       \n\nvec4 waveForm(vec2 u,vec2 m,vec2 r,float t//https://www.shadertoy.com/view/ldlSD2\n){u.y=(u.y*2.-1.)*2.\n ;float zoom=100.\n ;u.x=biject(u.x+(floor(t*fpsWave)*zoom/fpsWave),1.,0.,0.,-1./zoom)\n ;float v = sound(u.x).x\n ;//float dx=fwidth(v);v=abs(v-u.y)/sqrt(1.+dx*dx)//way too many c0 dicsontinuities here to look decent\n ;//this needs multitapping for half devend width differentials.\n ;v=smoothstep(.02,-.02,abs(v-u.y)-.1)//waveform  line thickness\n ;\n ;//c.x=abs(dx-u.y)/sqrt(1.+dx*dx)//euclidean_scale by firct derivative. (bad near very shin extrema)\n ;return vec4(v);}\n\nvec4 image(vec2 u,vec4 m,vec2 r,float t//uv,resolution,time\n){if(m.xy==vec2(0))m=r.xyxy*.5\n ;u   /=r.xy\n ;m.xy/=r.xy\n ;vec2 v=u-m.xy\n ;vec3 w=waveForm(vec2(u.x,u.y),m.xy,r,t).xyz\n ;v.y+=v.y\n ;vec2 f=dft(vec2(v.x,u.y),t+v.x/m.y)//dft wrapper over mainsound()\n ;f.x=length(f)*.75//dft line thickness amplifier\n ;f.x/=1.+f.x\n ;v=abs(v)\n ;//v=(2.-v)*2.-2.\n ;f.x=sqrt(f.x)\n ;//y=sat(y)//seems not too important\n ;//vec3 c=rainbow2(f.x,v.x)*f.x/(v.x+1.025)\n ;//vec3 c=rainbow2((m.x/f.x))*f.x/m.x//interestring reciprocals\n ;//vec3 c=rainbow2((u.x-.5),f.x)//rather silly gratient parameter swap\n ;//vec3 c=rainbow2(f.x*1.61,f.x-.5)*f.x//simple \n ;vec3 c=rainbow2(f.x*1.61,.25)*f.x//simple (only 1 variable parameter to rainbor2()\n ;//c*=1.2//oversaturate\n ;//c=pow(c,vec3(2.1))//gamma\n ;c.xyz=sat(c.xyz)\n ;c+=w*.5\n ;return vec4(c,1);}\n//void mainImage(out vec4 o,vec2 u){o=image(u,iResolution.xy,iTime);}\n\n",
                "description": "",
                "inputs": [],
                "name": "Common",
                "outputs": [],
                "type": "common"
            }
        ],
        "ver": "0.1"
    }
}